<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avendus Capital - Premium Trading Platform</title>
    <meta name="description"
        content="Access real-time market summaries, breaking news, and personalized stock recommendations on our premium financial dashboard.">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
</head>

<body>
    <div class="app-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="search-container">
                    <!-- Hidden inputs to "trap" browser autofill -->
                    <input type="text" name="fake_user" style="display:none" aria-hidden="true">
                    <input type="password" name="fake_pass" style="display:none" aria-hidden="true">

                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" placeholder="Ctrl K" class="search-input" autocomplete="off">
                </div>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-item active" id="navHome" onclick="setActiveNav(this)"><i
                        data-lucide="home"></i> Home</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('market.html'); setActiveNav(this)"
                    class="nav-item" id="navMarket"><i data-lucide="trending-up"></i> Market</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('#'); setActiveNav(this)" class="nav-item"
                    id="navDiscover"><i data-lucide="compass"></i> Discover</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('#'); setActiveNav(this)" class="nav-item"
                    id="navPortfolio"><i data-lucide="briefcase"></i> Portfolio</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('#'); setActiveNav(this)" class="nav-item"
                    id="navMe"><i data-lucide="user"></i> Me</a>
            </nav>
            <div class="header-right">
                <button class="settings-btn" onclick="toggleMessageCenter()"><i data-lucide="mail"></i></button>
                <button class="settings-btn" onclick="openSettings()"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <!-- Premium Video Featured Section -->
        <div class="video-promo-section">
            <div class="video-container" id="videoWrapper">
                <video id="promoVideo" loop muted playsinline autoplay
                    poster="https://images.pexels.com/photos/6801874/pexels-photo-6801874.jpeg?auto=compress&cs=tinysrgb&w=3840&h=2160&dpr=1">
                    <source
                        src="https://player.vimeo.com/external/494163966.sd.mp4?s=7b9e6f3d9f285d8d0c83a1d6a9e1e8d9b1c9c8a2&profile_id=164"
                        type="video/mp4">
                    Your browser does not support the video tag.
                </video>

                <!-- Video Overlays -->
                <div class="video-overlay">
                    <div class="video-text-content">
                        <span class="badge">Exclusive Highlight</span>
                        <h1>Avendus Capital</h1>
                        <p class="tagline">Invest now for the future. Join now.</p>
                        <div class="video-actions" id="promoActions">
                            <a href="login.html" class="join-btn-large"
                                style="text-decoration: none; display: flex; align-items: center; justify-content: center;">Login</a>
                            <button class="learn-more-btn">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Summary (shown when logged in) -->
        <div class="portfolio-summary-bar" id="portfolioBar" style="display: none;">
            <div class="user-greeting">
                <div class="user-avatar" id="topAvatar">91</div>
                <div class="user-text">
                    <h3 id="topGreeting">User</h3>
                    <p>Good afternoon — keep going.</p>
                </div>
                <button class="view-toggle"><i data-lucide="eye"></i></button>
            </div>

            <div class="portfolio-stats">
                <div class="stat-item">
                    <span class="stat-label">Available Balance</span>
                    <span class="stat-value green" id="homePortfolioValue">₹0.00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Invested Value</span>
                    <span class="stat-value blue">₹0.00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today</span>
                    <span class="stat-value green-subtle">0.00%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Week</span>
                    <span class="stat-value green-subtle">0.00%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value green-subtle">0.00%</span>
                </div>
            </div>

            <div class="action-btns">
                <a href="deposit.html" class="btn-deposit"><i data-lucide="plus-circle"></i> Deposit</a>
                <a href="withdraw.html" class="btn-withdraw"><i data-lucide="minus-circle"></i> Withdraw</a>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-grid">
            <!-- Left Column: Market Summary -->
            <section class="card market-summary">
                <div class="card-header">
                    <div class="header-icon"><i data-lucide="activity"></i></div>
                    <h2>Market Summary</h2>
                </div>
                <div class="market-cards-grid">
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">SENSEX</span>
                        </div>
                        <div class="stock-value">83,580.40</div>
                        <div class="stock-change green">+266.47 (+0.32%)</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">NIFTY 50</span>
                        </div>
                        <div class="stock-value">25,627.1</div>
                        <div class="stock-change negative">-148.9 (-0.58%)</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">NIFTY BANK</span>
                        </div>
                        <div class="stock-value">60,023.4</div>
                        <div class="stock-change negative">-214.75 (-0.36%)</div>
                    </div>
                </div>
            </section>

            <!-- About Us Section -->
            <section class="card about-us-section">
                <div class="card-header">
                    <div class="header-icon"><i data-lucide="info"></i></div>
                    <h2>About Avendus Capital</h2>
                </div>
                <div class="about-content" style="padding: 1.5rem; color: #64748b; line-height: 1.6;">
                    <p>Avendus Capital is a leading financial institution dedicated to providing premium trading and
                        investment solutions. We offer a comprehensive suite of tools designed to empower traders
                        globally.</p>
                </div>
            </section>

            <!-- Recommendation Alert (for guests) -->
            <div class="market-auth-prompt" id="marketAuthPrompt">
                <p>Please log in to view more premium insights</p>
                <a href="login.html" class="login-btn-small">Login to Continue</a>
            </div>

            <!-- Right Column: News & Recommendation -->
            <div class="sidebar">
                <section class="card breaking-news">
                    <div class="card-header">
                        <div class="header-icon blue"><i data-lucide="newspaper"></i></div>
                        <h2>Breaking News</h2>
                    </div>
                    <div class="news-carousel" id="newsCarousel">
                        <div class="news-slide active">
                            <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&q=80&w=800"
                                alt="News">
                            <div class="news-slide-overlay">
                                <span class="news-time">Just Now</span>
                                <h3>Market Hits New Milestone Amid Global Optimism</h3>
                            </div>
                        </div>
                        <!-- Arrow Controls -->
                        <button class="carousel-prev" onclick="changeSlide(-1)"><i
                                data-lucide="chevron-left"></i></button>
                        <button class="carousel-next" onclick="changeSlide(1)"><i
                                data-lucide="chevron-right"></i></button>
                    </div>
                </section>

                <section class="card recommendation">
                    <div class="card-header" id="recommendationHeader" style="cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="header-icon blue"><i data-lucide="thumbs-up"></i></div>
                            <h2>Recommendation</h2>
                        </div>
                        <i data-lucide="chevron-down" id="recommendationChevron"></i>
                    </div>
                    <div class="recommendation-list" id="recommendationList"
                        style="display: none; max-height: 0; overflow: hidden;">
                        <div class="rec-item">
                            <img class="rec-thumb"
                                src="https://images.unsplash.com/photo-1460925895917-afdab827c52f?auto=format&fit=crop&q=80&w=200"
                                alt="Rec">
                            <div class="rec-content">
                                <h3>2026 Financial Outlook</h3>
                                <p>Latest trends and predictions.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-left">
                © 2025. Reserved. | <a href="admin_kyc.html">Admin</a>
            </div>
            <div class="footer-right">
                <span class="timezone">GMT+5:30</span>
            </div>
        </footer>
    </div>

    <!-- Consolidated Modals -->
    <div id="settingsModal" class="settings-modal" onclick="if(event.target == this) closeSettings()">
        <div class="settings-content">
            <button class="settings-close" onclick="closeSettings()"><i data-lucide="x"></i></button>
            <div class="settings-header">
                <div class="avatar-circle" id="settingsAvatar">91</div>
                <div class="settings-phone" id="settingsPhone">User Access</div>
            </div>
            <div class="settings-list">
                <div class="settings-item" onclick="toggleSettingsAccordion(this, 'userProfileSub')">
                    <i data-lucide="user"></i> User Profile
                </div>
                <div id="userProfileSub" class="sub-menu">
                    <div class="sub-item" onclick="openUpdateAvatar()">Update Avatar</div>
                    <div class="sub-item" onclick="location.href='admin_login.html?action=kyc'">View KYC</div>
                </div>
                <div class="settings-item" onclick="openResetPassword()"><i data-lucide="key"></i> Change Password</div>
                <div class="settings-item" onclick="openCS()"><i data-lucide="headset"></i> Support</div>
                <div class="settings-item" onclick="DB.logout()"><i data-lucide="log-out"></i> Logout</div>
            </div>
        </div>
    </div>

    <div id="csModal" class="cs-modal" onclick="if(event.target == this) closeCS()">
        <div class="cs-content">
            <div class="cs-header">
                <h3>Customer Support</h3>
                <button onclick="closeCS()"><i data-lucide="x"></i></button>
            </div>
            <div class="cs-body" id="csBody"></div>
            <div class="cs-footer">
                <input type="text" id="csInput" placeholder="Message..."
                    onkeypress="if(event.key === 'Enter') sendCSMessage()">
                <button onclick="sendCSMessage()"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>

    <div id="messageCenterOverlay" class="message-center-overlay" onclick="toggleMessageCenter()"></div>
    <div id="messageCenter" class="message-center-modal">
        <div class="mc-header">
            <h3>Notifications</h3>
            <button onclick="toggleMessageCenter()"><i data-lucide="x"></i></button>
        </div>
        <div id="mcList" class="mc-list" style="padding:2rem; text-align:center; color:#64748b;">No new notifications
        </div>
    </div>

    <div id="resetPasswordModal" class="settings-modal" onclick="if(event.target == this) closeResetPassword()">
        <div class="settings-content" style="max-width: 400px;">
            <button class="settings-close" onclick="closeResetPassword()"><i data-lucide="x"></i></button>
            <h2>Reset Password</h2>
            <div style="display: flex; flex-direction: column; gap:1rem; margin-top:1rem;">
                <input type="password" id="newPassInternal" placeholder="New Password"
                    style="padding:0.8rem; border:1px solid #ccc; border-radius:8px;">
                <input type="password" id="confirmPassInternal" placeholder="Confirm Password"
                    style="padding:0.8rem; border:1px solid #ccc; border-radius:8px;">
                <button onclick="handleInternalReset()"
                    style="background:#3b82f6; color:white; border:none; padding:0.8rem; border-radius:8px;">Update
                    Password</button>
            </div>
        </div>
    </div>

    <div id="topAlertContainer" class="top-alert-container">
        Please login to access this feature.
    </div>

    <!-- Floating Contact -->
    <div class="cs-floating-tab" onclick="openCS()"
        style="position:fixed; bottom:2rem; right:2rem; background:#3b82f6; color:white; padding:1rem; border-radius:50px; cursor:pointer; z-index:999; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <i data-lucide="message-circle"></i> Support
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="script.js"></script>
    <script>
        lucide.createIcons();

        // Global State
        let isChatSubscribed = false;
        const currentUser = typeof DB !== 'undefined' ? DB.getCurrentUser() : null;

        // UI Initialization
        window.addEventListener('load', () => {
            const pb = document.getElementById('portfolioBar');
            const map = document.getElementById('marketAuthPrompt');
            const pa = document.getElementById('promoActions');

            if (currentUser) {
                if (pb) pb.style.display = 'flex';
                if (map) map.style.display = 'none';
                if (pa) pa.style.display = 'none';
                syncUserData();
            } else {
                if (pb) pb.style.display = 'none';
                if (pa) pa.style.display = 'flex';
            }
        });

        async function syncUserData() {
            if (!currentUser) return;

            // Local UI Sync
            const greet = document.getElementById('topGreeting');
            if (greet) greet.textContent = currentUser.full_name || currentUser.mobile;
            const phone = document.getElementById('settingsPhone');
            if (phone) phone.textContent = currentUser.mobile;

            // Remote DB sync
            const client = DB.getClient();
            if (client) {
                const { data: dbUser } = await client.from('users').select('*').eq('id', currentUser.id).single();
                if (dbUser) {
                    const fmt = (v) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(v || 0);

                    // --- USER REQUEST: "Available Balance" must visually deduct PENDING transactions ---
                    let effectiveBalance = parseFloat(dbUser.balance || 0);

                    // Fetch Pending Deposits
                    const { data: pendingD } = await client.from('deposits').select('amount').eq('user_id', currentUser.id).eq('status', 'Pending');
                    const lockedDeposits = (pendingD || []).reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);

                    // Fetch Pending Withdrawals
                    const { data: pendingW } = await client.from('withdrawals').select('amount').eq('user_id', currentUser.id).eq('status', 'Pending');
                    const lockedWithdrawals = (pendingW || []).reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);

                    // Fetch Pending Trades
                    const { data: pendingT } = await client.from('trades').select('total_amount').eq('user_id', currentUser.id).eq('status', 'Pending');
                    const lockedTrades = (pendingT || []).reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0);

                    effectiveBalance = effectiveBalance + lockedDeposits - lockedWithdrawals - lockedTrades;
                    if (effectiveBalance < 0) effectiveBalance = 0;

                    const bEls = document.querySelectorAll('.stat-value.green');
                    if (bEls.length) bEls[0].textContent = fmt(effectiveBalance);
                    const homePortfolioValue = document.getElementById('homePortfolioValue');
                    if (homePortfolioValue) {
                        homePortfolioValue.textContent = fmt(effectiveBalance);
                    }
                    const iEls = document.querySelectorAll('.stat-value.blue');
                    if (iEls.length) iEls[0].textContent = fmt(dbUser.invested);
                }
            }
        }

        // Customer Support & Chat
        function openCS() {
            document.getElementById('csModal').style.display = 'flex';
            loadCSMessages();
        }
        function closeCS() { document.getElementById('csModal').style.display = 'none'; }

        async function loadCSMessages() {
            if (!currentUser) return;
            const chatBody = document.getElementById('csBody');
            const msgs = await DB.getMessages(currentUser.id);

            chatBody.innerHTML = msgs.filter(m => {
                try { const p = JSON.parse(m.message); return !p.title; } catch (e) { return true; }
            }).map(m => {
                const type = m.sender === 'User' ? 'user' : 'service';
                const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `<div class="cs-msg ${type}"><div class="cs-msg-bubble">${m.message}<div style="font-size:0.6rem; opacity:0.6; text-align:right;">${time}</div></div></div>`;
            }).join('');
            chatBody.scrollTop = chatBody.scrollHeight;

            if (!isChatSubscribed) {
                const client = DB.getClient();
                client.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `user_id=eq.${currentUser.id}` }, payload => {
                    const m = payload.new;
                    addCSMessage(m.sender === 'User' ? 'user' : 'service', m.message);
                }).subscribe();
                isChatSubscribed = true;
            }
        }

        function addCSMessage(type, text) {
            const chatBody = document.getElementById('csBody');
            const msg = document.createElement('div');
            msg.className = `cs-msg ${type}`;
            msg.innerHTML = `<div class="cs-msg-bubble">${text}</div>`;
            chatBody.appendChild(msg);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function sendCSMessage() {
            const input = document.getElementById('csInput');
            const msg = input.value.trim();
            if (!msg || !currentUser) return;
            addCSMessage('user', msg);
            input.value = '';
            await DB.sendMessage(currentUser.id, msg, 'User');
        }

        // Settings & Account
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
        function openResetPassword() { document.getElementById('resetPasswordModal').style.display = 'flex'; }
        function closeResetPassword() { document.getElementById('resetPasswordModal').style.display = 'none'; }

        async function handleInternalReset() {
            const p1 = document.getElementById('newPassInternal').value;
            const p2 = document.getElementById('confirmPassInternal').value;
            if (!p1 || p1 !== p2) return alert('Passwords mismatch!');
            const res = await DB.resetPassword(currentUser.mobile, p1);
            if (res.success) { alert('Success!'); closeResetPassword(); } else alert('Error: ' + res.message);
        }

        function toggleSettingsAccordion(el, id) {
            const sub = document.getElementById(id);
            sub.classList.toggle('active');
        }

        // Navigation
        function handleGuestClick(url) {
            if (!currentUser) {
                const alert = document.getElementById('topAlertContainer');
                if (alert) {
                    alert.style.display = 'block';
                    setTimeout(() => alert.style.display = 'none', 3000);
                }
            } else if (url !== '#') {
                window.location.href = url;
            }
        }

        // Recommendation Toggle
        const recHeader = document.getElementById('recommendationHeader');
        if (recHeader) {
            recHeader.addEventListener('click', () => {
                const list = document.getElementById('recommendationList');
                const chevron = document.getElementById('recommendationChevron');
                const isHidden = list.style.display === 'none';
                list.style.display = isHidden ? 'block' : 'none';
                list.style.maxHeight = isHidden ? '500px' : '0';
                chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            });
        }

        function toggleMessageCenter() {
            document.getElementById('messageCenter').classList.toggle('active');
            document.getElementById('messageCenterOverlay').classList.toggle('active');
        }
    </script>
</body>

</html>