<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Detail - Avendus Capital</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js"></script>
    <style>
        /* Reusing styles from market.html */
        .market-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .stock-detail-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Split Layout --- */
        .market-main-container {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .market-left-col {
            flex: 1;
        }

        .market-right-col {
            width: 350px;
            display: flex;
            /* Always visible in this view */
            flex-direction: column;
            gap: 1.5rem;
        }

        /* --- Buy Panel Styles --- */
        .buy-panel {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .bp-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1e293b;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bp-row {
            margin-bottom: 1rem;
        }

        .bp-label {
            display: block;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.4rem;
            font-weight: 600;
        }

        .bp-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }

        .bp-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .bp-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .bp-total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .bp-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.2s;
        }

        .bp-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        /* --- Transactions List --- */
        .trans-list-panel {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .tl-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .tl-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .tl-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tl-symbol {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .tl-date {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .tl-right {
            text-align: right;
        }

        .tl-qty {
            font-size: 0.8rem;
            color: #64748b;
        }

        .tl-price {
            font-weight: 600;
            color: #1e293b;
        }

        /* Chart Area */
        .main-index-view {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .price-hero {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2rem;
        }

        .price-hero h2 {
            font-size: 3.5rem;
            margin: 0;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .index-chg {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .index-chg.green {
            color: #10b981;
        }

        .index-chg.red {
            color: #ef4444;
        }

        .chart-container-realtime {
            height: 600px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        /* Timeframe Buttons */
        .timeframe-btns {
            display: flex;
            gap: 0.8rem;
            margin: 1.5rem 0;
        }

        .tf-btn {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tf-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f0f9ff;
        }

        .tf-btn.active {
            background: #1e56a0;
            color: white;
            border-color: #1e56a0;
        }
    </style>
</head>

<body>
    <div class="market-wrapper">
        <header class="header" style="padding: 1rem 2rem;">
            <div class="header-left">
                <a href="market.html"
                    style="text-decoration:none; display:flex; align-items:center; gap:0.5rem; color:#1e293b; font-weight:600;">
                    <button class="settings-btn"><i data-lucide="arrow-left"></i></button>
                    Back to Market
                </a>
            </div>
            <nav class="nav">
                <!-- Simplified Nav -->
                <span style="font-weight: 700; color: #1e56a0; font-size: 1.2rem;">Stock Details</span>
            </nav>
            <div class="header-right">
                <button class="settings-btn"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <main class="stock-detail-content">
            <!-- Auth Lock Check (simplified) -->
            <div id="authCheck" style="display:none; text-align:center; padding:4rem;">
                <h2>Please Log In</h2>
                <a href="login.html" style="color:#3b82f6;">Go to Login</a>
            </div>

            <div id="stockContent" class="market-main-container">
                <!-- Left Column: Chart -->
                <div class="market-left-col">
                    <div class="main-index-view" style="padding: 0;">
                        <div class="chart-container-realtime"
                            style="height: 700px; margin-bottom: 0; border: none; border-radius: 16px; overflow: hidden;">
                            <div id="tradingview_widget" style="height:100%; width:100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Buy Panel -->
                <div class="market-right-col">
                    <div class="buy-panel">
                        <div class="bp-header">
                            <span id="bpHeaderTitle" style="color:#1e56a0;">Buy Stock</span>
                            <span id="bpStockSymbol" style="font-size:0.9rem; color:#64748b;">...</span>
                        </div>

                        <div class="bp-info-row">
                            <span style="color:#64748b;">Current Price:</span>
                            <span id="bpCurrentPrice" style="font-weight:700; color:#1e293b;">₹0.00</span>
                        </div>

                        <div class="bp-info-row" style="margin-bottom:1.5rem;">
                            <span style="color:#64748b;">Your Balance:</span>
                            <span id="bpUserBalance" style="font-weight:700; color:#10b981;">₹0.00</span>
                        </div>

                        <div class="bp-row">
                            <label class="bp-label">Quantity (Shares)</label>
                            <input type="number" id="bpQuantity" class="bp-input" value="1" min="1"
                                oninput="updateBuyTotal()">
                        </div>
                        <div class="bp-info-row">
                            <span style="color:#64748b;">Tax Fees:</span>
                            <span id="bpTaxFees" style="font-weight:600; color:#1e293b;">₹0.00</span>
                        </div>
                        <div class="bp-info-row">
                            <span style="color:#64748b;">Txn Charge:</span>
                            <span id="bpTxnCharge" style="font-weight:600; color:#1e293b;">₹0.00</span>
                        </div>
                        <div class="bp-total-row">
                            <span>Total Cost:</span>
                            <span id="bpTotalCost" style="color:#1e56a0;">₹0.00</span>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button class="bp-btn" id="buyBtn" onclick="executeBuyOrder()"
                                style="margin-top: 0; flex: 1;">
                                BUY NOW
                            </button>
                            <button class="bp-btn" id="sellBtn" onclick="executeSellOrder()"
                                style="margin-top: 0; flex: 1; background: #ef4444;">
                                SELL NOW
                            </button>
                        </div>
                    </div>

                    <!-- Holdings List -->
                    <div class="trans-list-panel">
                        <div class="bp-header" style="margin-bottom:0.5rem; border:none; padding-bottom:0;">
                            <span style="color:#1e293b;">Your Holdings</span>
                            <i data-lucide="history" size="16" color="#64748b"></i>
                        </div>
                        <div id="holdingsListWrapper" style="max-height: 300px; overflow-y: auto;">
                            <!-- Items will be injected here -->
                            <div style="text-align:center; padding:1.5rem; color:#94a3b8; font-size:0.8rem;">
                                No active holdings
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        lucide.createIcons();

        // Stock Data for Pricing Fallbacks
        // (Copying a subset or full list from market.html to ensure price availability)
        // In a real app, this should be in a shared JS file or fetched from API.
        const INDIAN_STOCKS = [
            { s: 'BSE:SENSEX', n: 'SENSEX Index', p: 83580.40 },
            { s: 'NSE:NIFTY', n: 'NIFTY 50', p: 25641.65 },
            { s: 'NSE:BANKNIFTY', n: 'NIFTY BANK', p: 60045.35 },
            { s: 'NSE:RELIANCE', n: 'Reliance Industries Ltd', p: 2985.50 },
            { s: 'NSE:TCS', n: 'Tata Consultancy Services', p: 4250.20 },
            { s: 'NSE:HDFCBANK', n: 'HDFC Bank Ltd', p: 1680.75 },
            { s: 'NSE:INFY', n: 'Infosys Ltd', p: 1890.30 },
            { s: 'NSE:ICICIBANK', n: 'ICICI Bank Ltd', p: 1250.40 },
            { s: 'NSE:HINDUNILVR', n: 'Hindustan Unilever Ltd', p: 2780.10 },
            { s: 'NSE:SBIN', n: 'State Bank of India', p: 795.60 },
            { s: 'NSE:BHARTIARTL', n: 'Bharti Airtel Ltd', p: 1650.20 },
            { s: 'NSE:ITC', n: 'ITC Ltd', p: 510.40 },
            { s: 'NSE:KOTAKBANK', n: 'Kotak Mahindra Bank', p: 1820.50 },
            { s: 'NSE:LT', n: 'Larsen & Toubro Ltd', p: 3750.80 },
            { s: 'NSE:AXISBANK', n: 'Axis Bank Ltd', p: 1190.30 },
            { s: 'NSE:HCLTECH', n: 'HCL Technologies', p: 1760.40 },
            { s: 'NSE:MARUTI', n: 'Maruti Suzuki India', p: 12450.00 },
            { s: 'NSE:TITAN', n: 'Titan Company Ltd', p: 3580.20 },
            { s: 'NSE:BAJFINANCE', n: 'Bajaj Finance Ltd', p: 7450.60 },
            { s: 'NSE:SUNPHARMA', n: 'Sun Pharmaceutical', p: 1890.10 },
            { s: 'NSE:TATAMOTORS', n: 'Tata Motors Ltd', p: 980.50 },
            { s: 'NSE:ULTRACEMCO', n: 'UltraTech Cement', p: 11250.00 },
            { s: 'NSE:ASIANPAINT', n: 'Asian Paints Ltd', p: 3250.40 },
            { s: 'NSE:NTPC', n: 'NTPC Ltd', p: 410.20 },
            { s: 'NSE:M_M', n: 'Mahindra & Mahindra', p: 2890.50 },
            { s: 'NSE:POWERGRID', n: 'Power Grid Corp', p: 345.60 },
            { s: 'NSE:ADANIENT', n: 'Adani Enterprises', p: 3150.80 },
            { s: 'NSE:ADANIPORTS', n: 'Adani Ports & SEZ', p: 1450.30 },
            { s: 'NSE:COALINDIA', n: 'Coal India Ltd', p: 510.20 },
            { s: 'NSE:WIPRO', n: 'Wipro Ltd', p: 540.60 },
            { s: 'NSE:ONGC', n: 'ONGC', p: 320.10 },
            { s: 'NSE:JSWSTEEL', n: 'JSW Steel Ltd', p: 980.40 },
            { s: 'NSE:BAJAJFINSV', n: 'Bajaj Finserv Ltd', p: 1850.20 },
            { s: 'NSE:GRASIM', n: 'Grasim Industries', p: 2650.50 },
            { s: 'NSE:TECHM', n: 'Tech Mahindra Ltd', p: 1540.30 },
            { s: 'NSE:EICHERMOT', n: 'Eicher Motors Ltd', p: 4850.60 },
            { s: 'NSE:NESTLEIND', n: 'Nestle India Ltd', p: 2540.20 },
            { s: 'NSE:TATASTEEL', n: 'Tata Steel Ltd', p: 165.40 },
            { s: 'NSE:INDUSINDBK', n: 'IndusInd Bank Ltd', p: 1450.30 },
            { s: 'NSE:BRITANNIA', n: 'Britannia Industries', p: 5890.50 },
            { s: 'NSE:CIPLA', n: 'Cipla Ltd', p: 1620.40 },
            { s: 'NSE:HEROMOTOCO', n: 'Hero MotoCorp Ltd', p: 5650.20 },
            { s: 'NSE:APOLLOHOSP', n: 'Apollo Hospitals', p: 6850.40 },
            { s: 'NSE:DIVISLAB', n: 'Divi\'s Laboratories', p: 5450.80 },
            { s: 'NSE:DRREDDY', n: 'Dr. Reddy\'s Labs', p: 6780.20 },
            { s: 'NSE:SBILIFE', n: 'SBI Life Insurance', p: 1780.50 },
            { s: 'NSE:HDFCLIFE', n: 'HDFC Life Insurance', p: 720.40 },
            { s: 'NSE:BPCL', n: 'Bharat Petroleum', p: 340.20 },
            { s: 'NSE:LTIM', n: 'LTIMindtree Ltd', p: 5950.60 },
            { s: 'NSE:TATACONSUM', n: 'Tata Consumer', p: 1250.30 }
        ];

        // Helper to find price
        function getStockPrice(sym) {
            const s = INDIAN_STOCKS.find(x => x.s === sym);
            return s ? s.p : 0;
        }

        let currentActiveSymbol = '';
        let currentStockName = '';
        let currentPrice = 0;
        let currentInterval = 'D';
        let currentProductType = 'stock';

        async function syncBalance() {
            const user = window.DB.getCurrentUser();
            if (!user) return;
            const client = window.DB.getClient();
            if (!client) return;
            try {
                const { data: dbUser } = await client.from('users').select('*').eq('id', user.id).single();
                if (dbUser) {
                    const [pD, pW, pT] = await Promise.all([
                        client.from('deposits').select('amount').eq('user_id', user.id).eq('status', 'Pending'),
                        client.from('withdrawals').select('amount').eq('user_id', user.id).eq('status', 'Pending'),
                        client.from('trades').select('total_amount').eq('user_id', user.id).eq('status', 'Pending')
                    ]);
                    const lockedDeposits = (pD.data || []).reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                    const lockedWithdrawals = (pW.data || []).reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);
                    const lockedTrades = (pT.data || []).reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0);
                    let effectiveBalance = (parseFloat(dbUser.balance) || 0) + lockedDeposits - lockedWithdrawals - lockedTrades;
                    if (effectiveBalance < 0) effectiveBalance = 0;
                    const balanceEl = document.getElementById('bpUserBalance');
                    if (balanceEl) {
                        balanceEl.innerText = '₹' + effectiveBalance.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                        balanceEl.dataset.effective = effectiveBalance;
                    }
                }
            } catch (e) {
                console.error("Sync Balance Error:", e);
            }
        }

        window.onload = function () {
            // Check Auth
            const user = window.DB.getCurrentUser();
            if (!user) {
                document.getElementById('stockContent').style.display = 'none';
                document.getElementById('authCheck').style.display = 'block';
                return;
            } else {
                document.getElementById('stockContent').style.display = 'flex';
                syncBalance();
            }

            // Parse URL
            const urlParams = new URLSearchParams(window.location.search);
            const sym = urlParams.get('symbol');
            const name = urlParams.get('name') || sym;
            const type = urlParams.get('type') || 'stock';

            if (sym) {
                initPage(sym, name, type);
            } else {
                alert("No stock specified.");
                window.location.href = 'market.html';
            }

            loadHoldings();

            setInterval(() => {
                if (window.DB.getCurrentUser()) {
                    syncBalance();
                    loadHoldings();
                }
            }, 2000);
        };

        let globalModalCallback = null;
        function showModal(type, title, msg, callback) {
            const modal = document.getElementById('globalModal');
            if (!modal) {
                alert(msg);
                if (callback) callback();
                return;
            }
            const iconContainer = document.getElementById('modalIconContainer');
            const icon = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const msgEl = document.getElementById('modalMsg');
            const btn = document.getElementById('modalBtn');
            titleEl.innerText = title;
            msgEl.innerText = msg;
            globalModalCallback = callback;
            if (type === 'success') {
                iconContainer.style.background = '#ecfdf5';
                iconContainer.style.color = '#10b981';
                icon.setAttribute('data-lucide', 'check-circle');
                btn.style.background = '#1e56a0';
            } else if (type === 'error') {
                iconContainer.style.background = '#fef2f2';
                iconContainer.style.color = '#ef4444';
                icon.setAttribute('data-lucide', 'alert-circle');
                btn.style.background = '#ef4444';
            } else if (type === 'warning') {
                iconContainer.style.background = '#fffbeb';
                iconContainer.style.color = '#f59e0b';
                icon.setAttribute('data-lucide', 'alert-triangle');
                btn.style.background = '#f59e0b';
            }
            modal.style.display = 'flex';
            if (window.lucide) window.lucide.createIcons();
        }
        function closeGlobalModal() {
            document.getElementById('globalModal').style.display = 'none';
            if (globalModalCallback) {
                globalModalCallback();
                globalModalCallback = null;
            }
        }

        function initPage(sym, name, type = 'stock') {
            currentActiveSymbol = sym;
            currentStockName = name;
            currentProductType = type;

            // Set Titles
            document.getElementById('bpStockSymbol').innerText = sym;
            document.title = `${name} - Stock Detail`;

            // Load Widget
            loadWidget(sym);

            // Set Price (Use Engine if available)
            const liveData = window.MarketEngine ? window.MarketEngine.getProduct(sym) : null;
            currentPrice = liveData ? liveData.price : getStockPrice(sym);
            if (currentPrice === 0) {
                currentPrice = 1000.00; // Default fallback
            }
            document.getElementById('bpCurrentPrice').innerText = '₹' + currentPrice.toLocaleString('en-IN', { minimumFractionDigits: 2 });


            // Set Action Text
            const buyBtn = document.querySelector('.bp-btn');
            const headerTitle = document.getElementById('bpHeaderTitle');
            if (currentProductType === 'OTC' || currentProductType === 'IPO') {
                if (buyBtn) buyBtn.innerText = 'SUBSCRIBE NOW';
                if (headerTitle) headerTitle.innerText = `Subscribe to ${currentProductType}`;
            }

            updateBuyTotal();
            startSimulation(); // Start the ticker
        }

        function loadWidget(symbol) {
            let tvSymbol = symbol;
            if (symbol.includes('.')) {
                const parts = symbol.split('.');
                if (parts.length === 2) {
                    tvSymbol = `${parts[1]}:${parts[0]}`;
                }
            } else if (!symbol.includes(':')) {
                tvSymbol = `BSE:${symbol}`;
            }

            const container = document.getElementById('tradingview_widget');
            if (container) container.innerHTML = '';

            new TradingView.widget({
                "autosize": true,
                "symbol": tvSymbol,
                "interval": "D",
                "timezone": "Asia/Kolkata",
                "theme": "light",
                "style": "1",
                "locale": "in",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_widget",
                "hide_side_toolbar": false,
                "withdateranges": true,
                "save_image": true,
                "details": true,
                "hotlist": true,
                "calendar": true,
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650",
                "studies": ["Volume@tv-basicstudies", "MAExp@tv-basicstudies"]
            });
        }


        // --- Buy Logic ---
        function updateBuyTotal() {
            const qty = parseInt(document.getElementById('bpQuantity').value) || 0;
            const baseTotal = qty * currentPrice;

            // Realtime Market Fees
            const tax = baseTotal * 0.0012;
            const txnCharge = baseTotal * 0.0003;
            const finalTotal = baseTotal + tax + txnCharge;

            const taxEl = document.getElementById('bpTaxFees');
            const txnEl = document.getElementById('bpTxnCharge');
            const totalEl = document.getElementById('bpTotalCost');

            if (taxEl) taxEl.innerText = '₹' + tax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (txnEl) txnEl.innerText = '₹' + txnCharge.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (totalEl) totalEl.innerText = '₹' + finalTotal.toLocaleString('en-IN', { maximumFractionDigits: 2 });

            return { qty, price: currentPrice, baseTotal, tax, txnCharge, total: finalTotal };
        }

        function closeOrderConfirm() {
            const modal = document.getElementById('orderConfirmModal');
            if (modal) modal.style.display = 'none';
        }

        async function executeBuyOrder() {
            const user = window.DB.getCurrentUser();
            if (!user) return;

            const qty = parseInt(document.getElementById('bpQuantity').value) || 0;
            if (qty <= 0) { alert("Invalid quantity"); return; }

            const calc = updateBuyTotal();
            const symbol = currentActiveSymbol;
            const stockName = currentStockName;

            // Populate Premium Confirmation Modal
            const ocName = document.getElementById('ocAssetName');
            const ocSym = document.getElementById('ocAssetSymbol');
            const ocQty = document.getElementById('ocQuantity');
            const ocPr = document.getElementById('ocPrice');
            const ocBase = document.getElementById('ocBaseAmount');
            const ocTx = document.getElementById('ocTax');
            const ocTn = document.getElementById('ocTxn');
            const ocTot = document.getElementById('ocTotal');
            const ocBtn = document.getElementById('ocConfirmBtn');

            if (ocName) ocName.innerText = stockName;
            if (ocSym) ocSym.innerText = `${symbol} • BSE`;
            if (ocQty) ocQty.innerText = calc.qty.toLocaleString();
            if (ocPr) ocPr.innerText = '₹' + calc.price.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocBase) ocBase.innerText = '₹' + calc.baseTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTx) ocTx.innerText = '+₹' + calc.tax.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTn) ocTn.innerText = '+₹' + calc.txnCharge.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTot) ocTot.innerText = '₹' + calc.total.toLocaleString('en-IN', { minimumFractionDigits: 2 });

            if (ocBtn) {
                ocBtn.innerText = `CONFIRM ${currentProductType.toUpperCase()} BUY`;
                ocBtn.onclick = () => executeConfirmedTrade('buy', currentProductType, symbol, stockName, calc);
            }

            const modal = document.getElementById('orderConfirmModal');
            if (modal) modal.style.display = 'flex';
            if (window.lucide) window.lucide.createIcons();
        }

        async function executeSellOrder(tradeId) {
            const user = window.DB.getCurrentUser();
            if (!user) return;

            // If no tradeId provided, find the first available holding for this symbol
            if (!tradeId) {
                const trades = await window.DB.getTradesByUserId(user.id);
                const matching = trades.find(t => t.status === 'Approved' && t.symbol.toUpperCase() === currentActiveSymbol.toUpperCase());
                if (!matching) {
                    alert("You don't have any holdings for " + currentActiveSymbol + " to sell.");
                    return;
                }
                tradeId = matching.id;
            }

            const trade = (await window.DB.getTradesByUserId(user.id)).find(t => t.id == tradeId);
            if (!trade) return;

            const qty = parseFloat(trade.quantity);
            const baseReturn = qty * currentPrice;
            const tax = baseReturn * 0.0012;
            const txnCharge = baseReturn * 0.0003;
            const totalReturn = baseReturn - tax - txnCharge;

            const calc = {
                tradeId,
                qty,
                price: currentPrice,
                baseTotal: baseReturn,
                tax: tax,
                txnCharge: txnCharge,
                total: totalReturn
            };

            // Populate Premium Confirmation Modal for SELL
            const ocName = document.getElementById('ocAssetName');
            const ocSym = document.getElementById('ocAssetSymbol');
            const ocQty = document.getElementById('ocQuantity');
            const ocPr = document.getElementById('ocPrice');
            const ocBase = document.getElementById('ocBaseAmount');
            const ocTx = document.getElementById('ocTax');
            const ocTn = document.getElementById('ocTxn');
            const ocTot = document.getElementById('ocTotal');
            const ocBtn = document.getElementById('ocConfirmBtn');

            if (ocName) ocName.innerText = currentStockName;
            if (ocSym) ocSym.innerText = `${currentActiveSymbol} • EXIT LOT`;
            if (ocQty) ocQty.innerText = qty.toLocaleString();
            if (ocPr) ocPr.innerText = '₹' + currentPrice.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocBase) ocBase.innerText = '₹' + baseReturn.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTx) ocTx.innerText = '-₹' + tax.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTn) ocTn.innerText = '-₹' + txnCharge.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTot) ocTot.innerText = '₹' + totalReturn.toLocaleString('en-IN', { minimumFractionDigits: 2 });

            if (ocBtn) {
                ocBtn.innerText = `CONFIRM SELL ORDER`;
                ocBtn.style.background = '#ef4444';
                ocBtn.onclick = () => executeConfirmedTrade('sell', 'stock', currentActiveSymbol, currentStockName, calc);
            }

            const modal = document.getElementById('orderConfirmModal');
            if (modal) modal.style.display = 'flex';
            if (window.lucide) window.lucide.createIcons();
        }

        async function executeConfirmedTrade(action, type, symbol, stockName, calc) {
            const btn = document.getElementById('ocConfirmBtn');
            const originalText = btn.innerText;
            btn.innerText = "EXECUTING...";
            btn.disabled = true;

            const user = window.DB.getCurrentUser();
            const client = window.DB.getClient();

            try {
                if (action === 'buy') {
                    // 1. Force Refresh User Data
                    const freshUser = await window.DB.refreshCurrentUser();
                    const currentBalance = parseFloat(freshUser.balance || 0);

                    if (calc.total > currentBalance) {
                        alert(`Insufficient balance! Your available balance is ₹${currentBalance.toFixed(2)}, but the total cost is ₹${calc.total.toFixed(2)}.`);
                        closeOrderConfirm();
                        return;
                    }

                    const isSubscription = ['otc', 'ipo'].includes((type || '').toLowerCase());
                    const tradeStatus = isSubscription ? 'Pending' : 'Approved';

                    const tradeData = {
                        user_id: freshUser.id,
                        symbol: symbol,
                        name: stockName,
                        type: (type || 'stock').toLowerCase(),
                        quantity: calc.qty,
                        price: calc.price,
                        total_amount: calc.total,
                        tax_amount: calc.tax,
                        txn_charge: calc.txnCharge,
                        status: tradeStatus
                    };

                    const result = await window.DB.submitTrade(tradeData);
                    if (result.success) {
                        if (tradeStatus === 'Approved') {
                            const newBalance = currentBalance - calc.total;
                            const newInvested = (parseFloat(freshUser.invested) || 0) + calc.total;
                            await window.DB.updateUserFinancials(freshUser.id, newBalance, newInvested);
                        }

                        closeOrderConfirm();
                        if (isSubscription) {
                            openPurchaseModal(type, symbol, stockName, calc.qty, calc.total);
                        } else {
                            showModal('success', 'Order Successful', `Successfully purchased ${calc.qty} shares of ${stockName}.`, () => {
                                syncBalance();
                                loadHoldings();
                            });
                        }
                    } else {
                        showModal('error', 'Submission Failed', 'Failed to submit trade.');
                    }
                } else {
                    // SELL logic
                    const tradeId = calc.tradeId;
                    const { error: tradeErr } = await client.from('trades').update({
                        status: 'Settled',
                        processed_at: new Date().toISOString(),
                        admin_note: `Sold at Market ₹${calc.price.toFixed(2)}`
                    }).eq('id', tradeId);
                    if (tradeErr) throw tradeErr;

                    const freshUser = await window.DB.refreshCurrentUser();
                    const newBalance = (parseFloat(freshUser.balance) || 0) + calc.total;
                    const originalTrade = (await window.DB.getTradesByUserId(user.id)).find(t => t.id == tradeId);
                    const newInvested = (parseFloat(freshUser.invested) || 0) - (parseFloat(originalTrade.total_amount) || 0);

                    await client.from('users').update({
                        balance: newBalance,
                        invested: Math.max(0, newInvested)
                    }).eq('id', user.id);

                    showModal('success', 'Order Closed', `Order closed successfully! ₹${calc.total.toLocaleString('en-IN')} added to your balance.`, () => {
                        closeOrderConfirm();
                        syncBalance();
                        loadHoldings();
                    });
                }
            } catch (e) {
                console.error("Trade error:", e);
                alert("Transaction failed: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.background = ''; // reset color
            }
        }

        async function loadHoldings() {
            const user = window.DB && window.DB.getCurrentUser ? window.DB.getCurrentUser() : null;
            const list = document.getElementById('holdingsListWrapper');
            if (!list || !user) return;

            try {
                // Fetch latest trades for this user
                const allTrades = await window.DB.getTradesByUserId(user.id);

                // Filter for Approved trades for THIS specific stock/product
                const myTrades = allTrades.filter(t =>
                    t.status === 'Approved' &&
                    t.symbol.toUpperCase() === currentActiveSymbol.toUpperCase()
                );

                if (myTrades.length > 0) {
                    list.innerHTML = myTrades.map(trade => {
                        const tradeDate = new Date(trade.created_at).toLocaleDateString('en-IN', {
                            day: '2-digit', month: 'short'
                        });
                        const total = parseFloat(trade.total_amount);
                        const qty = parseInt(trade.quantity);
                        const price = parseFloat(trade.price);

                        // Show each purchase as an entry
                        return `
                            <div class="tl-item">
                                <div class="tl-left">
                                    <div class="tl-symbol">${trade.symbol}</div>
                                    <div class="tl-date">${tradeDate} • Bought at ₹${price.toLocaleString('en-IN')}</div>
                                    <button onclick="executeSellOrder('${trade.id}')" style="margin-top: 0.5rem; background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">SELL LOT</button>
                                </div>
                                <div class="tl-right">
                                    <div class="tl-price">₹${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div>
                                    <div class="tl-qty">${qty} Shares</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div style="text-align:center; padding:1.5rem; color:#94a3b8; font-size:0.8rem;">You do not own this stock yet.</div>';
                }
            } catch (e) {
                console.error("Error loading holdings:", e);
                list.innerHTML = '<div style="text-align:center; padding:1rem; color:#ef4444; font-size:0.75rem;">Error updating holdings</div>';
            }
        }

        // --- SIMULATION ---
        function startSimulation() {
            // Synchronize with MarketEngine for REAL real-time data
            setInterval(() => {
                const liveData = window.MarketEngine ? window.MarketEngine.getProduct(currentActiveSymbol) : null;
                if (!liveData) return;

                currentPrice = liveData.price;

                // Update UI Prices
                const elPrice = document.getElementById('bpCurrentPrice');
                const sdPrice = document.getElementById('sdPrice');
                const sdSymbol = document.getElementById('sdSymbol');

                if (elPrice) elPrice.innerText = '₹' + currentPrice.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (sdPrice) sdPrice.innerText = '₹' + currentPrice.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (sdSymbol) sdSymbol.innerText = currentActiveSymbol;

                // Update Progress on Detail Page (Mock)
                const sdProgress = document.getElementById('sdProgress');
                const sdMarker = document.getElementById('sdSliderMarker');
                if (sdProgress && sdMarker) {
                    const mockPct = 30 + (Math.random() * 40); // Random wiggle
                    sdProgress.style.width = mockPct + '%';
                    sdMarker.style.left = mockPct + '%';
                }

                // Also update Total Cost
                updateBuyTotal();
            }, 1000); // Check engine every second
        }

        let currentPurchaseData = null;

        function openPurchaseModal(type, symbol, name, qty, total) {
            currentPurchaseData = { type, symbol, name, qty, total };

            document.getElementById('cpName').innerText = name;
            document.getElementById('cpSymbol').innerText = symbol;
            document.getElementById('cpQty').innerText = qty;
            document.getElementById('cpTotal').innerText = `₹${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;

            document.getElementById('purchaseConfirmModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closePurchaseModal() {
            document.getElementById('purchaseConfirmModal').style.display = 'none';
            currentPurchaseData = null;
        }

        window.confirmPurchaseSubscription = async function () {
            const btn = document.getElementById('cpSubmitBtn');
            const originalText = btn.innerText;

            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                showModal('success', 'Request Received', `Your subscription request for ${currentPurchaseData.name} has been received and is waiting for administrator approval.`, () => {
                    closePurchaseModal();
                    syncBalance();
                });
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };


    </script>
    <!-- Premium Order Confirmation Modal -->
    <div id="orderConfirmModal" class="center-popup-modal" onclick="if(event.target == this) closeOrderConfirm()"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div class="center-popup-content"
            style="max-width: 480px; padding: 0; overflow: hidden; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); background: white; border-radius: 20px; width: 90%;">
            <div style="background: linear-gradient(135deg, #1e56a0 0%, #16427d 100%); padding: 1.5rem; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div id="ocTypeLabel"
                            style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; font-weight: 700; margin-bottom: 0.25rem;">
                            PRO ORDER CONFIRMATION</div>
                        <h2 id="ocAssetName" style="font-weight: 800; font-size: 1.5rem; margin: 0; line-height: 1.2;">
                            Stock Name</h2>
                        <div id="ocAssetSymbol"
                            style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; font-weight: 500;">SYMBOL •
                            EXCHANGE</div>
                    </div>
                    <button class="popup-close" onclick="closeOrderConfirm()"
                        style="background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center;"><i
                            data-lucide="x" size="20"></i></button>
                </div>
            </div>

            <div class="popup-body" style="padding: 1.5rem; background: #ffffff;">
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <div
                        style="flex: 1; background: #f8fafc; padding: 1rem; border-radius: 12px; border: 1px solid #f1f5f9;">
                        <div
                            style="font-size: 0.7rem; color: #64748b; font-weight: 700; margin-bottom: 0.25rem; text-transform: uppercase;">
                            Quantity</div>
                        <div id="ocQuantity" style="font-size: 1.25rem; font-weight: 800; color: #1e293b;">0</div>
                    </div>
                    <div
                        style="flex: 1; background: #f8fafc; padding: 1rem; border-radius: 12px; border: 1px solid #f1f5f9;">
                        <div
                            style="font-size: 0.7rem; color: #64748b; font-weight: 700; margin-bottom: 0.25rem; text-transform: uppercase;">
                            Price/Share</div>
                        <div id="ocPrice" style="font-size: 1.25rem; font-weight: 800; color: #1e293b;">₹0.00</div>
                    </div>
                </div>

                <div style="border-radius: 16px; background: #f1f5f9; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #64748b; font-size: 0.9rem; font-weight: 500;">Base Amount</span>
                        <span id="ocBaseAmount"
                            style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">₹0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #64748b; font-size: 0.85rem;">Tax (0.12%)</span>
                        <span id="ocTax" style="font-weight: 600; color: #ef4444; font-size: 0.85rem;">+₹0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span style="color: #64748b; font-size: 0.85rem;">Txn Charge (0.03%)</span>
                        <span id="ocTxn" style="font-weight: 600; color: #ef4444; font-size: 0.85rem;">+₹0.00</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px dashed #cbd5e1;">
                        <span style="color: #1e56a0; font-weight: 800; font-size: 1rem;">EST. TOTAL</span>
                        <span id="ocTotal" style="font-weight: 900; color: #1e56a0; font-size: 1.4rem;">₹0.00</span>
                    </div>
                </div>

                <div
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 10px; margin-bottom: 2rem;">
                    <i data-lucide="shield-check" size="18" color="#d97706"></i>
                    <span style="font-size: 0.75rem; color: #92400e; line-height: 1.4; font-weight: 500;">By confirming,
                        you agree to execute the order at the current market value. Real-time volatility may affect the
                        final price.</span>
                </div>

                <button id="ocConfirmBtn"
                    style="width: 100%; padding: 1.25rem; background: #1e56a0; color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(30, 86, 160, 0.3);"
                    onmouseover="this.style.background='#16427d'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 15px -3px rgba(30, 86, 160, 0.4)';"
                    onmouseout="this.style.background='#1e56a0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(30, 86, 160, 0.3)';">CONFIRM
                    BUY ORDER</button>

                <p style="text-align: center; margin-top: 1rem; font-size: 0.75rem; color: #94a3b8; font-weight: 500;">
                    Fast execution • Secured by Avendus Enterprise</p>
            </div>
        </div>
    </div>

    <!-- Confirm Purchase Modal (For OTC/IPO) -->
    <div id="purchaseConfirmModal" class="center-popup-modal" onclick="if(event.target == this) closePurchaseModal()"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div class="center-popup-content"
            style="max-width: 480px; background:white; border-radius:20px; width:90%; overflow: hidden;">
            <div style="background: #1e56a0; padding: 1.5rem; color: white;">
                <h2 style="font-weight: 800; margin: 0; font-size: 1.25rem;">Subscription Confirmation</h2>
                <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 4px;">Review your institutional allocation
                    request</div>
            </div>
            <div class="popup-body" style="padding:1.5rem;">
                <div style="background: #f1f5f9; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #64748b; font-size: 0.9rem;">Product</span>
                        <span id="cpName" style="font-weight: 700; color: #1e293b;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #64748b; font-size: 0.9rem;">Symbol</span>
                        <span id="cpSymbol" style="font-weight: 700; color: #1e293b;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span style="color: #64748b; font-size: 0.9rem;">Quantity Requested</span>
                        <span id="cpQty" style="font-weight: 700; color: #1e293b;">0</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px dashed #cbd5e1;">
                        <span style="color: #1e56a0; font-weight: 800;">TOTAL PAYABLE</span>
                        <span id="cpTotal" style="font-weight: 900; color: #1e56a0; font-size: 1.25rem;">₹0.00</span>
                    </div>
                </div>

                <div
                    style="margin-bottom: 1.5rem; text-align: center; color: #64748b; font-size: 0.85rem; line-height: 1.5; padding: 0 1rem;">
                    Your subscription request will be sent to our desk for review. Once verified, units will be credited
                    to your portfolio.
                </div>

                <button class="logout-btn"
                    style="background: #1e56a0; width: 100%; border-radius: 12px; height: 56px; font-weight: 800; border:none; color:white; cursor:pointer;"
                    id="cpSubmitBtn" onclick="confirmPurchaseSubscription()">SEND SUBSCRIPTION REQUEST</button>
            </div>
        </div>
    </div>
    <!-- Global Notification Modal -->
    <div id="globalModal" class="center-popup-modal" onclick="if(event.target == this) closeGlobalModal()"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
        <div class="center-popup-content"
            style="max-width: 400px; padding: 2.5rem 2rem; text-align: center; border-radius: 24px; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); background: white;">
            <div id="modalIconContainer"
                style="width: 80px; height: 80px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: grid; place-items: center; margin: 0 auto 1.5rem;">
                <i id="modalIcon" data-lucide="check-circle" size="48"></i>
            </div>
            <h2 id="modalTitle" style="font-weight: 800; font-size: 1.5rem; color: #1e293b; margin-bottom: 0.5rem;">
                Success</h2>
            <p id="modalMsg" style="color: #64748b; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem;">Your
                transaction has been processed successfully.</p>
            <button id="modalBtn" onclick="closeGlobalModal()"
                style="width: 100%; padding: 1rem; background: #1e56a0; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='none'">
                CONTINUE
            </button>
        </div>
    </div>
</body>

</html>
<style>
    .mini-tf-btn {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 700;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mini-tf-btn.active {
        background: #1e56a0;
        color: white;
        border-color: #1e56a0;
    }

    .range-dot,
    #rangeProgress {
        transition: all 0.5s ease;
    }

    .styled-chart-box {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
</style>