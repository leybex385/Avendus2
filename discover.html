<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market - Avendus Capital</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db.js?v=20260212"></script>
    <script src="market_data.js"></script>
    <style>
        /* Using global styles from styles.css */

        .market-wrapper {
            display: flex;
            flex-direction: column;
        }

        /* Removed local header styles to use global styles.css */

        .market-content {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1.5rem;
            padding: 0 1.5rem 1.5rem;
            flex: 1;
        }

        .left-col {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .m-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Assets Card */
        .assets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .asset-mini-card {
            background: #f8fafc;
            padding: 0.8rem 0.6rem;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
            min-width: 0;
            overflow: hidden;
        }

        .asset-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.3rem;
        }

        .asset-val {
            font-weight: 700;
            font-size: 0.75rem;
            word-break: break-all;
            line-height: 1.2;
        }

        .asset-val.green {
            color: var(--green-up);
        }

        .asset-val.red {
            color: var(--red-down);
        }

        .asset-sub {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 0.2rem;
        }

        /* Sectors Grid */
        .sector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .sector-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 16px;
            padding: 1.25rem 1rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
        }

        .sector-card:hover {
            transform: translateY(-4px);
            border-color: #3b82f6;
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.15);
        }

        .sector-icon-box {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.2rem;
        }

        .sector-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 2.2rem;
        }

        .sector-pct {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.2rem;
        }

        .sector-pct.up {
            color: #10b981;
        }

        .sector-pct.down {
            color: #ef4444;
        }

        /* Major Indice Section */
        .section-title.indices {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .indices-list {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .index-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            flex: 1;
            border: 2px solid #f1f5f9;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .index-card.active {
            border-color: #3b82f6;
            background: #f8faff;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1);
        }

        .index-card-left {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 1;
        }

        .index-head {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.4rem;
        }

        .index-flag {
            width: 22px;
            height: 16px;
            object-fit: cover;
            border-radius: 2px;
        }

        .index-name {
            font-weight: 700;
            font-size: 0.85rem;
            color: #475569;
            letter-spacing: 0.5px;
        }

        .index-val {
            font-size: 1.6rem;
            font-weight: 800;
            color: #1e293b;
            margin: 0;
            transition: color 0.3s;
        }

        .index-chg {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .index-chg.green {
            color: #10b981;
        }

        .index-chg.red {
            color: #ef4444;
        }

        /* Sparkline Area */
        .sparkline-container {
            width: 150px;
            height: 70px;
            margin-left: 1rem;
        }

        .sparkline-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .sparkline-path {
            fill: none;
            stroke-width: 3.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .sparkline-path.green {
            stroke: #10b981;
        }

        .sparkline-path.red {
            stroke: #ef4444;
        }

        /* Main Chart Area */
        .main-index-view {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .price-hero {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2rem;
        }

        .price-hero h2 {
            font-size: 3.5rem;
            margin: 0;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .chart-container-realtime {
            height: 750px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .news-section h3 {
            margin-bottom: 1rem;
        }

        .news-item {
            padding: 1.2rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .news-item h4 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
            color: #1e293b;
        }

        .news-item p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
            line-height: 1.5;
        }

        .news-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        /* Side Lists */
        .side-list-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stock-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .stock-ident {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .stock-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .stock-ticker {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .stock-full-name {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .stock-price-col {
            text-align: right;
        }

        .footer-market {
            background: var(--bg-orange);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .footer-right {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        /* Day Range Slider Styles */
        .day-range-container {
            margin: 1.5rem 0;
            padding: 1rem 0;
            border-top: 1px solid #f1f5f9;
        }

        .range-bar-wrapper {
            position: relative;
            height: 10px;
            background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
            border-radius: 5px;
            margin: 1.5rem 0 0.5rem;
        }

        .slider-marker {
            position: absolute;
            top: 50%;
            width: 16px;
            height: 16px;
            background: white;
            border: 3px solid #10b981;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
        }

        .low-val {
            color: #ef4444;
        }

        .high-val {
            color: #10b981;
        }



        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
            font-size: 0.85rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .info-label {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .info-val-text {
            font-weight: 600;
            color: #1e293b;
        }

        .timeframe-btns {
            display: flex;
            gap: 0.8rem;
            margin: 1.5rem 0;
        }

        .tf-btn {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .tf-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f0f9ff;
        }

        .tf-btn.active {
            background: #1e56a0;
            color: white;
            border-color: #1e56a0;
            box-shadow: 0 4px 12px rgba(30, 86, 160, 0.2);
        }

        /* Holding Card Designs (User Request) */
        .holding-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .h-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .h-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border-color: #3b82f6;
        }

        .h-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
        }

        .h-stock-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .h-stock-meta {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

        .h-status-badge {
            font-size: 0.75rem;
            font-weight: 700;
            color: #10b981;
            background: #ecfdf5;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .h-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
            border-top: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
        }

        .h-stat-item {
            text-align: center;
        }

        .h-stat-label {
            display: block;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.4rem;
        }

        .h-stat-val {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .h-stat-val.red {
            color: #ef4444;
        }

        .h-stat-val.green {
            color: #10b981;
        }

        .h-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .h-btn {
            padding: 0.75rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .h-btn.view {
            background: #10b981;
            color: white;
        }

        .h-btn.view:hover {
            background: #059669;
        }

        .h-btn.close {
            background: #d4af37;
            color: black;
        }

        .h-btn.close:hover {
            background: #aa8c2c;
        }

        /* Premium Discover Cards (User Request) */
        .premium-trade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem 0;
        }

        .premium-trade-card {
            background: #1a1b1f;
            border-radius: 24px;
            padding: 2rem;
            color: #ffffff;
            border: 1px solid #2d2e32;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .premium-trade-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: #facc1555;
        }

        .premium-card-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .premium-asset-info {
            flex: 1;
        }

        .premium-asset-name {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #fcfcfc;
        }

        .premium-asset-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .premium-return-rate {
            text-align: right;
        }

        .premium-return-label {
            display: block;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.2rem;
            font-weight: 500;
        }

        .premium-return-val {
            font-size: 1.25rem;
            font-weight: 800;
            color: #10b981;
        }

        .premium-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.25rem 0;
            border-top: 1px solid #ffffff10;
        }

        .premium-detail-item .label {
            display: block;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .premium-detail-item .value {
            font-size: 1.15rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        .premium-subscribe-btn {
            background: #facc15;
            color: #000000;
            border: none;
            border-radius: 16px;
            height: 52px;
            font-weight: 800;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .premium-subscribe-btn:hover {
            background: #eab308;
            transform: scale(1.02);
        }

        .premium-subscribe-btn:active {
            transform: scale(0.98);
        }

        .premium-subscribe-btn.locked {
            background: #3a3b40;
            color: #94a3b8;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Detail Modal Table */
        .detail-info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        .detail-info-table tr td {
            padding: 0.8rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-info-table tr td:first-child {
            color: #94a3b8;
            font-weight: 500;
        }

        .detail-info-table tr td:last-child {
            text-align: right;
            font-weight: 600;
            color: #1e293b;
        }

        .detail-info-table tr:last-child td {
            border-bottom: none;
        }

        .detail-total-val {
            font-size: 2.2rem;
            font-weight: 800;
            color: #1e293b;
            text-align: center;
            margin: 0.5rem 0;
        }

        .detail-total-label {
            font-size: 0.85rem;
            color: #94a3b8;
            text-align: center;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 20px;
            bottom: 0;
            width: 2px;
            background: #f1f5f9;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
            margin-top: 5px;
            z-index: 1;
        }

        .timeline-content h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .timeline-content p {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Close Order Modal Bar */
        .quotation-timer {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            margin-top: 1rem;
            overflow: hidden;
            position: relative;
        }

        .quotation-progress {
            height: 100%;
            background: #10b981;
            width: 100%;
        }

        /* Exchange Tabs */
        .exchange-tab {
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            background: #f1f5f9;
            color: #64748b;
            transition: all 0.2s;
            font-size: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .exchange-tab.active {
            background: #1e56a0;
            color: white;
            border-color: #1e56a0;
            box-shadow: 0 4px 6px rgba(30, 86, 160, 0.2);
        }

        /* Customer Service Modal - Premium Version Restored */
        .cs-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .cs-content {
            width: 400px;
            height: 650px;
            background: white;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        .cs-header {
            background: #1e56a0;
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .cs-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cs-header-avatar img {
            width: 32px;
            height: 32px;
        }

        .cs-header-info {
            flex: 1;
        }

        .cs-header-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .cs-header-hours {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .cs-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .cs-body {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .cs-msg {
            max-width: 85%;
            display: flex;
            gap: 0.8rem;
        }

        .cs-msg.service {
            align-self: flex-start;
        }

        .cs-msg.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .cs-msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: #e2e8f0;
        }

        .cs-msg-avatar img {
            width: 100%;
            height: 100%;
        }

        .cs-msg-bubble {
            padding: 0.7rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .cs-msg.service .cs-msg-bubble {
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 2px;
        }

        .cs-msg.user .cs-msg-bubble {
            background: #1e56a0;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .cs-footer {
            padding: 1rem;
            background: white;
            border-top: 1px solid #f1f5f9;
        }

        .cs-input-area {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cs-input-row {
            display: flex;
            gap: 0.5rem;
        }

        .cs-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            outline: none;
            font-size: 0.9rem;
        }

        .cs-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cs-tools {
            display: flex;
            gap: 0.25rem;
        }

        .cs-tool-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
        }

        .cs-tool-btn:hover {
            background: #f1f5f9;
            color: #1e56a0;
        }

        .cs-send-btn {
            background: #1e56a0;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .cs-emoji-picker {
            position: absolute;
            bottom: 120px;
            left: 10px;
            right: 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .cs-emoji-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .cs-emoji-btn:hover {
            background: #f1f5f9;
        }

        .cs-attachment-preview {
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .cs-floating-tab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1e56a0;
            color: white;
            padding: 0.8rem 1.4rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(30, 86, 160, 0.3);
            z-index: 1000;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .cs-input:focus {
            border-color: #1e56a0;
        }

        .cs-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .buy-widget {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            display: block;
        }

        .quantity-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .q-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            outline: none;
        }

        .max-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .trading-info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.85rem;
        }

        .trading-info-table td {
            padding: 0.5rem 0;
        }

        .trading-info-table .val {
            text-align: right;
            font-weight: 600;
        }

        .trading-info-table .total {
            color: #10b981;
            font-weight: 700;
        }

        .buy-btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            opacity: 0.8;
        }

        .buy-btn:hover {
            opacity: 1;
        }

        .stats-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .stats-table tr {
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-table td {
            padding: 0.8rem 0.5rem;
        }

        .stats-table .label {
            color: #64748b;
        }

        .stats-table .val {
            text-align: right;
            font-weight: 600;
            color: #1e293b;
        }

        .heart-icon {
            cursor: pointer;
            color: #10b981;
        }

        .company-info-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .company-info-section h3 {
            margin-top: 0;
        }

        .company-info-grid {
            display: grid;
            gap: 0.8rem;
            font-size: 0.9rem;
        }

        .info-pair {
            font-weight: 700;
            color: #1e293b;
        }

        /* Discover View Styles */
        #discoverView {
            display: none;
            grid-template-columns: 280px 1fr;
            gap: 1.5rem;
            padding: 0.5rem 1.5rem 1.5rem;
            margin-top: 0;
        }

        .discover-sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: fit-content;
        }

        .discover-nav-item {
            padding: 1rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #1e293b;
            font-weight: 500;
            transition: all 0.2s;
        }

        .discover-nav-item:hover {
            background: #f1f5f9;
        }

        .discover-nav-item.active {
            background: #dbeafe;
            color: #1e56a0;
        }

        .discover-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
        }

        .discover-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .refresh-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1e56a0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(30, 86, 160, 0.2);
        }

        .discover-tabs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .d-tab {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .d-tab.active {
            background: #1e56a0;
            color: white;
            border-color: #1e56a0;
        }

        .d-tab-pill {
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            background: white;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .d-tab-pill.active {
            background: #1e56a0;
            color: white;
            border-color: #1e56a0;
        }

        .search-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1e56a0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        /* Transaction Card Styles */
        .trans-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .t-card {
            border: 1px solid #fde047;
            /* Yellowish border as seen in images */
            border-radius: 20px;
            padding: 1.2rem;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .t-card-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .t-stock-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.95rem;
        }

        .t-status {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .t-status.rejected {
            color: #ef4444;
        }

        .t-status.sold {
            color: #64748b;
        }

        .t-status.unsettled {
            color: #f43f5e;
        }

        .t-card-body {
            display: flex;
            justify-content: flex-end;
            margin: 0.5rem 0;
        }

        .t-info-col {
            text-align: right;
        }

        .t-info-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .t-info-val {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .t-pnl {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .t-pnl.green {
            color: #10b981;
        }

        .t-pnl.red {
            color: #ef4444;
        }

        .t-card-footer {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .t-btn-view {
            flex: 1;
            background: #10b981;
            color: white;
            border: none;
            padding: 0.6rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        .t-btn-close {
            flex: 1;
            background: #fda4af;
            color: white;
            border: none;
            padding: 0.6rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Portfolio View Styles */
        #portfolioView {
            display: none;
            grid-template-columns: 460px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            flex: 1;
        }

        .p-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .p-card-title {
            font-weight: 700;
            color: #1e56a0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.2rem;
            font-size: 1.1rem;
        }

        .p-assets-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .p-asset-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .p-asset-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .p-asset-val {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1e293b;
        }

        .p-asset-sub {
            font-size: 0.7rem;
            color: #10b981;
            font-weight: 600;
        }

        .p-asset-sub.red {
            color: #ef4444;
        }

        .p-btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .p-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-weight: 700;
            border: none;
            color: white;
            cursor: pointer;
        }

        .p-btn.deposit {
            background: #10b981;
        }

        .p-btn.withdraw {
            background: #f59e0b;
        }

        .stat-charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .mini-chart-box {
            border: 1px solid #f1f5f9;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .advances-bar {
            height: 10px;
            display: flex;
            border-radius: 5px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .adv-green {
            background: #10b981;
        }

        .adv-red {
            background: #ef4444;
        }

        .p-table {
            width: 100%;
            border-collapse: collapse;
        }

        .p-table th,
        .p-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
        }

        .p-tab-bar {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .p-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background: #f1f5f9;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .p-tab.active {
            background: #1e56a0;
            color: white;
        }

        .date-filter-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
        }

        .date-input-group input {
            border: none;
            outline: none;
            font-size: 0.85rem;
            color: #64748b;
        }

        .clear-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #1e293b;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .half-donut {
            width: 150px;
            height: 75px;
            position: relative;
            margin: 0 auto;
            overflow: hidden;
        }

        .donut-circle-box {
            width: 100px;
            height: 100px;
            position: relative;
            margin: 0 auto;
        }

        .donut-center-val {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: #1e293b;
        }

        .donut-val {
            position: absolute;
            bottom: 0;
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .fund-item-card {
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.2s ease;
        }

        .fund-item-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.05);
        }

        .f-item-main {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .f-item-type {
            font-weight: 700;
            color: #1e293b;
            font-size: 1rem;
        }

        .f-item-sub {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* --- Split Layout for Market View --- */
        .market-main-container {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .market-left-col {
            flex: 1;
            /* Takes remaining space */
        }

        .market-right-col {
            width: 320px;
            /* Sidebar width */
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* --- Buy Panel Styles --- */
        .buy-panel {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .bp-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #1e293b;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bp-row {
            margin-bottom: 1rem;
        }

        .bp-label {
            display: block;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.4rem;
            font-weight: 600;
        }

        .bp-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s;
        }

        .bp-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .bp-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .bp-total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .bp-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.2s;
        }

        .bp-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        /* --- Transactions List in Right Panel --- */
        .trans-list-panel {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .tl-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .tl-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .tl-item:first-child {
            padding-top: 0;
        }

        .tl-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tl-symbol {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1e293b;
        }

        .tl-date {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .tl-right {
            text-align: right;
        }

        .tl-qty {
            font-size: 0.8rem;
            color: #64748b;
        }

        .tl-price {
            font-weight: 600;
            color: #1e293b;
        }


        .f-item-id {
            font-size: 0.75rem;
            color: #cbd5e1;
            margin-top: 0.2rem;
        }

        .f-item-price-col {
            text-align: right;
        }

        .f-item-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .f-item-amount.red {
            color: #ef4444;
        }

        .f-item-amount.green {
            color: #10b981;
        }

        .f-item-curr {
            font-size: 0.75rem;
            color: #cbd5e1;
            font-weight: 600;
            margin-top: 0.2rem;
        }

        /* Me View Styles - Consolidation point */
        .me-view-container {
            display: none;
            grid-template-columns: 500px 1fr;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            height: calc(100vh - 120px);
            overflow: hidden;
            background: #fdf2f2;
            /* Light orange/red tint background */
        }

        .me-left-col,
        .me-right-col {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            overflow-y: auto;
            padding-right: 8px;
            scroll-behavior: smooth;
        }

        /* Hide scrollbars for a cleaner look */
        .me-left-col::-webkit-scrollbar,
        .me-right-col::-webkit-scrollbar {
            width: 4px;
        }

        .me-left-col::-webkit-scrollbar-thumb,
        .me-right-col::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .me-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .me-card-tag {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            color: #3b82f6;
        }

        .me-title-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #3b82f6;
            font-weight: 700;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        /* Profile Styles */
        .me-profile-main {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .me-p-avatar {
            width: 70px;
            height: 70px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #64748b;
        }

        .me-p-info h2 {
            font-size: 1.25rem;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }

        .me-p-info p {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.2rem;
        }

        .kyc-approved {
            background: #d1fae5;
            color: #059669;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .kyc-pending {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .kyc-rejected {
            background: #fee2e2;
            color: #dc2626;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .kyc-not-verified {
            background: #f1f5f9;
            color: #64748b;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .me-vip-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .me-stat-item {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .me-stat-item.blue {
            border-color: #bee3f8;
        }

        .me-stat-item.gold {
            border-color: #fef3c7;
        }

        .me-stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            display: block;
            margin-bottom: 0.5rem;
        }

        .me-stat-val {
            font-size: 1.25rem;
            font-weight: 800;
        }

        .me-stat-val.blue {
            color: #3182ce;
        }

        .me-stat-val.gold {
            color: #d69e2e;
        }

        .me-btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .me-btn {
            border: none;
            padding: 0.9rem;
            border-radius: 10px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: opacity 0.2s;
        }

        .me-btn.deposit {
            background: #10b981;
        }

        .me-btn.withdraw {
            background: #f6993f;
        }

        /* Assets List */
        .me-asset-grid {
            display: grid;
            grid-template-columns: repeat(3, 2fr);
            gap: 1rem;
        }

        .me-as-card {
            border: 1px solid #f1f5f9;
            padding: 1rem;
            border-radius: 10px;
            background: #fafafa;
        }

        .me-as-lbl {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .me-as-val {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0.3rem 0;
        }

        .me-as-sub {
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Gauge SVG */
        .gauge-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
        }

        .gauge-score-text {
            font-size: 2.5rem;
            font-weight: 800;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        /* Applications Right Col */
        .me-apps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .app-pill-row {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .app-pill {
            padding: 6px 15px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
        }

        .app-pill.active {
            background: white;
            border-color: #1e56a0;
            color: #1e56a0;
        }

        .no-data-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5rem 0;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .score-info-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #475569;
            font-style: italic;
        }

        /* --- DISCOVER PAGE BLACK & GOLD THEME --- */
        #discoverView {
            background-color: #0b0b0b !important;
            min-height: 100vh;
            padding: 1.5rem;
            display: none;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        /* Tabs (Trades / Transactions / Upcoming) Buttons in Sidebar/Nav */
        .discover-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .d-tab {
            background: #111;
            border: 1px solid #2a2a2a;
            color: #ccc;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .d-tab:hover {
            border-color: #d4af37;
            color: #fff;
        }

        .d-tab.active {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%);
            border-color: #d4af37;
            color: #000;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .d-tab.active i {
            stroke: #000 !important;
        }

        /* Premium Discover Cards (User Request) */
        .premium-trade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem 0;
        }

        /* Ensure we target any trade list container in discover view */
        #tradesList {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
            gap: 1.5rem !important;
        }

        .premium-trade-card {
            background: linear-gradient(180deg, #111 0%, #0d0d0d 100%) !important;
            border: 1px solid #2a2a2a !important;
            border-radius: 12px !important;
            padding: 1.5rem !important;
            position: relative;
            color: #ffffff !important;
            display: flex;
            flex-direction: column;
            gap: 1.5rem !important;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .premium-trade-card:hover {
            transform: translateY(-5px);
            border-color: #d4af37 !important;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.1) !important;
        }

        .premium-card-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .premium-asset-info {
            flex: 1;
        }

        .premium-asset-name {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #ffffff !important;
        }

        .premium-asset-meta {
            font-size: 0.75rem;
            color: #888 !important;
            font-weight: 500;
            text-transform: uppercase;
        }

        .premium-return-rate {
            text-align: right;
        }

        .premium-return-label {
            display: block;
            font-size: 0.75rem;
            color: #888 !important;
            margin-bottom: 0.2rem;
            font-weight: 500;
        }

        .premium-return-val {
            font-size: 1.25rem;
            font-weight: 800;
            /* JS sets color */
        }

        .premium-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.25rem 0;
            border-top: 1px solid #2a2a2a !important;
            margin-top: -0.5rem;
        }

        .premium-detail-item .label {
            display: block;
            font-size: 0.8rem;
            color: #888 !important;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .premium-detail-item .value {
            font-size: 1.15rem;
            font-weight: 700;
            color: #f1f5f9 !important;
        }

        .premium-subscribe-btn {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
            color: #000 !important;
            border: none;
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .premium-subscribe-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4) !important;
        }

        .premium-subscribe-btn.locked {
            background: #2a2a2a !important;
            color: #666 !important;
            cursor: not-allowed;
            background-image: none !important;
            box-shadow: none !important;
        }

        /* Transactions & Holdings Cards in Discover */
        #discoverView .h-card,
        #discoverView .t-card {
            background: linear-gradient(180deg, #111 0%, #0d0d0d 100%) !important;
            border: 1px solid #2a2a2a !important;
            border-radius: 12px !important;
            padding: 1.5rem !important;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
        }

        #discoverView .h-head,
        #discoverView .t-card-head {
            border-bottom: 1px solid #2a2a2a !important;
            padding-bottom: 1rem;
            margin-bottom: 1rem !important;
        }

        #discoverView .t-card-body {
            padding-top: 0.5rem;
        }

        #discoverView .t-stock-name {
            color: #fff !important;
        }

        #discoverView .h-stock-info h3 {
            color: #fff !important;
        }

        #discoverView .t-info-label,
        #discoverView .h-stat-label,
        #discoverView .h-stock-meta,
        #discoverView .t-stock-name span {
            color: #888 !important;
        }

        #discoverView .t-info-val,
        #discoverView .h-stat-val {
            color: #fff !important;
            font-weight: 700;
        }

        #discoverView .h-stat-val.green {
            color: #10b981 !important;
        }

        #discoverView .h-stat-val.red {
            color: #ef4444 !important;
        }

        /* Buttons in Trans cards */
        #discoverView .h-btn.view {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
            color: #000 !important;
            border: none;
        }

        #discoverView .h-btn.view:hover {
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4) !important;
            transform: translateY(-2px);
        }

        #discoverView .h-btn.close {
            background: #2a2a2a !important;
            border: 1px solid #ef4444 !important;
            color: #ef4444 !important;
        }

        #discoverView .h-btn.close:hover {
            background: #ef4444 !important;
            color: #fff !important;
        }

        /* Transaction Tabs (Sub-pills) */
        .d-tab-pill {
            background: #111 !important;
            border: 1px solid #2a2a2a !important;
            color: #888 !important;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .d-tab-pill:hover {
            color: #fff !important;
            border-color: #444 !important;
        }

        .d-tab-pill.active {
            background: #d4af37 !important;
            color: #000 !important;
            border-color: #d4af37 !important;
            font-weight: 600;
        }

        /* Sector Cards (Regular Stocks in Discover) override */
        #discoverView .sector-card {
            background: #111 !important;
            border: 1px solid #2a2a2a !important;
            border-radius: 12px !important;
        }

        #discoverView .sector-card:hover {
            border-color: #d4af37 !important;
            transform: translateY(-2px);
        }

        #discoverView .stock-ticker {
            color: #fff !important;
        }

        #discoverView .stock-full-name {
            color: #888 !important;
        }

        #discoverView .stock-full-name span {
            background: #2a2a2a !important;
            color: #d4af37 !important;
        }

        /* Section Headers in Discover */
        #discoverView .discover-head {
            border-bottom: 1px solid #2a2a2a;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        #discoverView .discover-head div {
            color: #fff !important;
        }

        #discoverView .discover-head i {
            color: #d4af37 !important;
        }

        /* Search & Refresh Circles in Discover */
        #discoverView .search-circle,
        #discoverView .refresh-circle {
            background: #2a2a2a !important;
            color: #d4af37 !important;
        }
    </style>
</head>

<body>
    <div class="market-wrapper">
        <header class="header" style="padding: 1rem 2rem;">
            <div class="header-left">
                <div class="search-container" style="position: relative;">
                    <!-- Improved trap for browser autofill -->
                    <div style="position: absolute; left: -9999px; top: -9999px;">
                        <input type="text" name="fake_user" autocomplete="username">
                        <input type="password" name="fake_pass" autocomplete="current-password">
                    </div>

                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" placeholder="Search Stocks (e.g. RELIANCE, TCS)..." class="search-input"
                        id="globalSearchInput" autocomplete="off">
                    <div id="searchResults" class="search-results-dropdown"></div>
                </div>
            </div>
            <nav class="nav">
                <a href="index.html?logged_in=true" class="nav-item" id="navHome" onclick="setActiveNav(this)"><i
                        data-lucide="home"></i> Home</a>
                <a href="javascript:void(0)" class="nav-item active" id="navMarket"
                    onclick="showMarketView(); setActiveNav(this)"><i data-lucide="trending-up"></i> Market</a>
                <a href="javascript:void(0)" class="nav-item" id="navDiscover"
                    onclick="showDiscoverView(); setActiveNav(this)"><i data-lucide="compass"></i> Discover</a>
                <a href="javascript:void(0)" class="nav-item" id="navPortfolio"
                    onclick="showPortfolioView(); setActiveNav(this)"><i data-lucide="briefcase"></i> Portfolio</a>
                <a href="javascript:void(0)" class="nav-item" id="navMe" onclick="showMeView(); setActiveNav(this)"><i
                        data-lucide="user"></i> Me</a>
            </nav>
            <div class="header-right">
                <button class="settings-btn" onclick="toggleMessageCenter()">
                    <i data-lucide="bell"></i>
                    <div class="notif-badge"></div>
                </button>
                <button class="settings-btn" onclick="openCS()" title="Support" style="position: relative;">
                    <div class="csr-badge" id="csrHeaderBadge" style="display: none;"></div>
                    <i data-lucide="headset"></i>
                </button>
                <button class="settings-btn" onclick="openSettings()"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <!-- Detail Header (Hidden by default) -->
        <div class="detail-header" id="stockDetailHeader" style="display: none;">
            <div class="back-btn" onclick="closeStockDetail()">
                <i data-lucide="chevron-left"></i>
            </div>
            <div id="detailStockTitle" style="font-weight: 700; font-size: 1.1rem;">Bartronics India Limited</div>
        </div>

        <div id="mainDashboard">
            <main class="market-content">
                <!-- Left Column -->
                <div class="left-col">
                    <!-- Assets Widget -->
                    <section class="m-card auth-locked-container">
                        <div class="auth-lock-overlay">
                            <p>This section is only available to authenticated users.</p>
                            <a href="login.html" class="auth-lock-btn">Please log in to continue</a>
                        </div>
                        <div class="auth-locked-content">
                            <div class="assets-header">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 700;">
                                    <i data-lucide="wallet" size="20" color="#3b82f6"></i> Assets
                                    <span id="toggleAssets"
                                        style="cursor: pointer; display: flex; align-items: center;">
                                        <i data-lucide="eye" size="16" color="#64748b" id="eyeIcon"></i>
                                    </span>
                                </div>
                                <i data-lucide="rotate-cw" size="18" color="#64748b"></i>
                            </div>
                            <div class="assets-grid" style="grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <div class="asset-mini-card">
                                    <div class="asset-label">Available</div>
                                    <div class="asset-val"><span class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Cash</div>
                                </div>
                                <div class="asset-mini-card">
                                    <div class="asset-label">Invested</div>
                                    <div class="asset-val"><span class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Invested</div>
                                </div>
                                <div class="asset-mini-card">
                                    <div class="asset-label">Bonus</div>
                                    <div class="asset-val"><span class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Credit</div>
                                </div>
                                <div class="asset-mini-card">
                                    <div class="asset-label">Frozen</div>
                                    <div class="asset-val"><span class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Pending</div>
                                </div>
                                <div class="asset-mini-card">
                                    <div class="asset-label">Loan</div>
                                    <div class="asset-val"><span class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Funds</div>
                                </div>
                                <div class="asset-mini-card">
                                    <div class="asset-label">Pending</div>
                                    <div class="asset-val" style="color:#ef4444;"><span
                                            class="asset-amount">0.00</span></div>
                                    <div class="asset-sub">Settle</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Stocks Sector -->
                    <section class="m-card">
                        <div class="section-title"
                            style="font-weight: 700; margin-bottom: 1.25rem; font-size: 1.1rem; color: #1e293b;">Stocks
                            Sector</div>
                        <div class="sector-grid">
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(16, 185, 129, 0.1);">
                                    <i data-lucide="sprout" size="20" color="#10b981"></i>
                                </div>
                                <div class="sector-name">Aluminum Industry</div>
                                <div class="sector-pct down">-4.99%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(59, 130, 246, 0.1);">
                                    <i data-lucide="utensils" size="20" color="#3b82f6"></i>
                                </div>
                                <div class="sector-name">Restaurants</div>
                                <div class="sector-pct up">+1.90%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(236, 72, 153, 0.1);">
                                    <i data-lucide="cpu" size="20" color="#ec4899"></i>
                                </div>
                                <div class="sector-name">Electronics</div>
                                <div class="sector-pct down">-1.49%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(245, 158, 11, 0.1);">
                                    <i data-lucide="construction" size="20" color="#f59e0b"></i>
                                </div>
                                <div class="sector-name">Metal Fab</div>
                                <div class="sector-pct down">-3.55%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(99, 102, 241, 0.1);">
                                    <i data-lucide="wrench" size="20" color="#6366f1"></i>
                                </div>
                                <div class="sector-name">Tools & Hardware</div>
                                <div class="sector-pct down">-3.29%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(16, 185, 129, 0.1);">
                                    <i data-lucide="layout-grid" size="20" color="#10b981"></i>
                                </div>
                                <div class="sector-name">Specialty Retail</div>
                                <div class="sector-pct up">+3.07%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(239, 68, 68, 0.1);">
                                    <i data-lucide="zap" size="20" color="#ef4444"></i>
                                </div>
                                <div class="sector-name">Energy</div>
                                <div class="sector-pct up">+1.12%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(168, 85, 247, 0.1);">
                                    <i data-lucide="pill" size="20" color="#a855f7"></i>
                                </div>
                                <div class="sector-name">Pharma</div>
                                <div class="sector-pct down">-0.45%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(14, 165, 233, 0.1);">
                                    <i data-lucide="plane" size="20" color="#0ea5e9"></i>
                                </div>
                                <div class="sector-name">Aviation</div>
                                <div class="sector-pct up">+2.30%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(249, 115, 22, 0.1);">
                                    <i data-lucide="shopping-cart" size="20" color="#f97316"></i>
                                </div>
                                <div class="sector-name">E-Commerce</div>
                                <div class="sector-pct up">+4.15%</div>
                            </div>

                        </div>
                    </section>

                    <!-- Commodities Widget -->
                    <section class="m-card" style="margin-top: 1.5rem;">
                        <div class="section-title"
                            style="font-weight: 700; margin-bottom: 1.25rem; font-size: 1.1rem; color: #1e293b;">
                            Commodities</div>
                        <div class="sector-grid">
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(234, 179, 8, 0.1);">
                                    <i data-lucide="coins" size="20" color="#eab308"></i>
                                </div>
                                <div class="sector-name">Gold</div>
                                <div class="sector-pct up">+0.85%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(148, 163, 184, 0.1);">
                                    <i data-lucide="disc" size="20" color="#94a3b8"></i>
                                </div>
                                <div class="sector-name">Silver</div>
                                <div class="sector-pct down">-0.42%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(15, 23, 42, 0.1);">
                                    <i data-lucide="droplet" size="20" color="#0f172a"></i>
                                </div>
                                <div class="sector-name">Crude Oil</div>
                                <div class="sector-pct up">+1.20%</div>
                            </div>
                            <div class="sector-card">
                                <div class="sector-icon-box" style="background: rgba(14, 165, 233, 0.1);">
                                    <i data-lucide="wind" size="20" color="#0ea5e9"></i>
                                </div>
                                <div class="sector-name">Natural Gas</div>
                                <div class="sector-pct down">-1.15%</div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Main Column -->
                <div class="center-col">
                    <div class="section-title indices">
                        <i data-lucide="line-chart" size="20" color="#3b82f6"></i>
                        Major Indices
                    </div>
                    <!-- Scroll Wrapper -->
                    <div id="indicesScrollContainer"
                        style="width: 100%; overflow-x: auto; overflow-y: hidden; cursor: grab; padding-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none; display: block; touch-action: pan-x;">
                        <section class="indices-list" id="majorIndicesList"
                            style="display: flex; gap: 1rem; width: max-content; margin: 0; padding: 0;">
                            <!-- Dynamic Content Loaded by JS -->
                        </section>
                    </div>

                    <!-- Main Index View (Chart + Price Hero) -->
                    <section class="main-index-view auth-locked-container" style="margin-top: 1.5rem;">
                        <div class="auth-lock-overlay">
                            <p>This section is only available to authenticated users.</p>
                            <a href="login.html" class="auth-lock-btn">Please log in to continue</a>
                        </div>
                        <div class="auth-locked-content">
                            <div class="market-main-container">
                                <div class="market-left-col">
                                    <div class="styled-chart-box"
                                        style="background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
                                        <!-- Real-time Price Header -->
                                        <div class="chart-header-stylized" style="margin-bottom: 1.5rem;">
                                            <div id="valSymbol"
                                                style="font-size: 1rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">
                                                SENSEX</div>
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 0.5rem;">
                                                <h1 id="indexPrice"
                                                    style="font-size: 2.8rem; font-weight: 800; color: #1e293b; margin: 0; line-height: 1;">
                                                    84,065.75</h1>
                                                <div id="heroChange" class="index-chg green"
                                                    style="font-size: 1.2rem; font-weight: 700; background: #eefcf4; padding: 4px 12px; border-radius: 8px;">
                                                    +485.35 (+0.58%)</div>
                                            </div>
                                        </div>

                                        <!-- Day Range Bar -->
                                        <div class="styled-range-container"
                                            style="margin-bottom: 2rem; position: relative;">
                                            <div class="range-labels"
                                                style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; margin-bottom: 8px;">
                                                <span id="dayLow" style="color: #ef4444;">83,580.42</span>
                                                <span id="dayHigh" style="color: #10b981;">84,314.68</span>
                                            </div>
                                            <div class="range-track"
                                                style="height: 6px; background: #f1f5f9; border-radius: 3px; position: relative;">
                                                <div id="rangeProgress"
                                                    style="position: absolute; left: 0; top: 0; height: 100%; width: 50%; background: linear-gradient(to right, #ef4444, #10b981); border-radius: 3px;">
                                                </div>
                                                <div id="sliderMarker" class="range-dot"
                                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; background: white; border: 3px solid #10b981; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2;">
                                                </div>
                                            </div>
                                            <div class="range-stats"
                                                style="display: flex; gap: 25px; margin-top: 10px; font-size: 11px; color: #94a3b8; font-weight: 600;">
                                                <span>Symbol: <b id="valSymbolText"
                                                        style="color: #475569;">SENSEX</b></span>
                                                <span>Market: <b style="color: #475569;">ININ</b></span>
                                                <span>Prev Close: <b id="gridClose"
                                                        style="color: #475569;">83,580.4</b></span>
                                                <span>Volume: <b id="valVol"
                                                        style="color: #475569;">14,913,178</b></span>
                                            </div>
                                        </div>

                                        <!-- Chart Controls Row -->
                                        <div class="chart-controls-row"
                                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-top: 1px solid #f1f5f9; margin-bottom: 10px;">
                                            <div class="tf-group" style="display: flex; gap: 10px;">
                                                <button class="mini-tf-btn active"
                                                    onclick="updateChartInterval('D', this)">1D</button>
                                                <button class="mini-tf-btn"
                                                    onclick="updateChartInterval('W', this)">1W</button>
                                                <button class="mini-tf-btn"
                                                    onclick="updateChartInterval('M', this)">1M</button>
                                            </div>
                                            <div class="chart-legend"
                                                style="display: flex; gap: 20px; font-size: 12px; font-weight: 700; color: #64748b;">
                                                <span style="display: flex; align-items: center; gap: 6px;"><i
                                                        style="width: 10px; height: 10px; background: #ef4444; border-radius: 50%; display: inline-block;"></i>
                                                    Stock</span>
                                                <span style="display: flex; align-items: center; gap: 6px;"><i
                                                        style="width: 10px; height: 10px; background: #3b82f6; border-radius: 50%; display: inline-block;"></i>
                                                    Volume</span>
                                            </div>
                                        </div>

                                        <!-- Actual Chart -->
                                        <div class="chart-container-realtime"
                                            style="height: 600px; width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid #f1f5f9;">
                                            <div id="tradingview_widget" style="height:100%; width:100%;"></div>
                                        </div>
                                    </div>

                                    <!-- Stock News & IPO (Red Box Area) -->
                                    <div class="news-section m-card" style="padding: 1.5rem; margin-top: 1.25rem;">
                                        <div class="side-list-title" style="margin-bottom: 1.25rem;">
                                            <div
                                                style="font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                                                <i data-lucide="newspaper" size="18" color="#3b82f6"></i>
                                                Stock News
                                            </div>
                                        </div>

                                        <div class="news-item"
                                            style="margin-bottom: 1.25rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem;">
                                            <div class="news-meta"
                                                style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.25rem; text-transform: uppercase;">
                                                TECH  3:45 PM</div>
                                            <h4
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; line-height: 1.4; color: #1e293b;">
                                                Nifty IT Index Surges 3% as Powell Hints at Rate Cuts</h4>
                                            <p style="font-size: 0.75rem; color: #64748b; line-height: 1.5; margin: 0;">
                                                Powell hints at possible rate cuts later this year, boosting
                                                sentiment...</p>
                                        </div>

                                        <div class="news-item"
                                            style="margin-bottom: 1.25rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem;">
                                            <div class="news-meta"
                                                style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.25rem; text-transform: uppercase;">
                                                RELIANCE  3:05 PM</div>
                                            <h4
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; line-height: 1.4; color: #1e293b;">
                                                Reliance Retail to Acquire Stake in VogueIndia</h4>
                                            <p style="font-size: 0.75rem; color: #64748b; line-height: 1.5; margin: 0;">
                                                RRVL set to acquire 51% stake in fashion tech startup...</p>
                                        </div>

                                        <div class="news-item"
                                            style="margin-bottom: 1.25rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem;">
                                            <div class="news-meta"
                                                style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.25rem; text-transform: uppercase;">
                                                SUNPHARMA  2:35 PM</div>
                                            <h4
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; line-height: 1.4; color: #1e293b;">
                                                USFDA Approval for Generic Diabetes Drug</h4>
                                            <p style="font-size: 0.75rem; color: #64748b; line-height: 1.5; margin: 0;">
                                                Sun Pharma received final approval for generic Sitagliptin tablets...
                                            </p>
                                        </div>

                                        <div class="news-item"
                                            style="margin-bottom: 1.25rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem;">
                                            <div class="news-meta"
                                                style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.25rem; text-transform: uppercase;">
                                                HDFCBANK  2:10 PM</div>
                                            <h4
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; line-height: 1.4; color: #1e293b;">
                                                HDFC Bank Q3 Net Profit Jumps 18%</h4>
                                            <p style="font-size: 0.75rem; color: #64748b; line-height: 1.5; margin: 0;">
                                                Stellar growth in net profit for Q3, beating street estimates...</p>
                                        </div>

                                        <div class="news-item"
                                            style="border-bottom: none; padding-bottom: 0; margin-bottom: 0;">
                                            <div class="news-meta"
                                                style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 0.25rem; text-transform: uppercase;">
                                                SENSEX  1:45 PM</div>
                                            <h4
                                                style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.4rem; line-height: 1.4; color: #1e293b;">
                                                Sensex Crosses Historic 84,000 Mark</h4>
                                            <p style="font-size: 0.75rem; color: #64748b; line-height: 1.5; margin: 0;">
                                                Driven by robust FII investments and positive global cues...</p>
                                        </div>
                                    </div>

                                </div> <!-- End market-left-col -->
                            </div> <!-- End market-main-container -->
                        </div> <!-- End auth-locked-content -->
                    </section> <!-- End main-index-view -->
                </div> <!-- End center-col -->

                <!-- Sidebar Content (Far Right Side) -->
                <div class="right-col" style="display: flex; flex-direction: column; gap: 1.5rem;">

                    <section class="m-card"
                        style="margin-top: 0; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: none;">
                        <div class="auth-locked-content" style="display: block;">
                            <div class="side-list-title">
                                <div style="font-weight: 700;"><i data-lucide="star" size="18" color="#f59e0b"></i>
                                    Watch List
                                </div>
                            </div>
                            <div style="text-align: center; color: #94a3b8; padding: 1rem; font-size: 0.8rem;">No data.
                            </div>
                        </div>
                    </section>

                    <section class="m-card"
                        style="margin-top: 0; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: none;">
                        <div class="side-list-title">
                            <div style="font-weight: 700;"><i data-lucide="trending-up" size="18" color="#10b981"></i>
                                Top Gainer</div>
                            <div style="font-size: 0.65rem; display: flex; gap: 0.35rem;">
                                <span class="exchange-tab active" onclick="switchExchange('gainers', 'NSE')">NSE</span>
                                <span class="exchange-tab" onclick="switchExchange('gainers', 'BSE')">BSE</span>
                            </div>
                        </div>
                        <div id="gainersList">
                            <div class="auth-locked-content" style="display: block;">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </section>

                    <section class="m-card"
                        style="margin-top: 0; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: none;">
                        <div class="side-list-title">
                            <div style="font-weight: 700;"><i data-lucide="trending-down" size="18" color="#ef4444"></i>
                                Top Loser</div>
                            <div style="font-size: 0.65rem; display: flex; gap: 0.35rem;">
                                <span class="exchange-tab active" onclick="switchExchange('losers', 'NSE')">NSE</span>
                                <span class="exchange-tab" onclick="switchExchange('losers', 'BSE')">BSE</span>
                            </div>
                        </div>
                        <div id="losersList">
                            <div class="auth-locked-content" style="display: block;">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </section>

                    <!-- IPO Calendar (Moved below Top Loser) -->
                    <section class="m-card"
                        style="margin-top: 0; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: none;">
                        <div class="side-list-title">
                            <div style="font-weight: 700;"><i data-lucide="calendar" size="18" color="#6366f1"></i>
                                IPO Calendar</div>
                        </div>
                        <div class="auth-locked-content" style="display: block;">
                            <div class="ipo-item"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #f1f5f9;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.85rem;">Armour Security</div>
                                    <div style="font-size: 0.7rem; color: #64748b;">14-16 Jan</div>
                                </div>
                                <div
                                    style="background: #eff6ff; color: #3b82f6; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                                    Upcoming</div>
                            </div>
                            <div class="ipo-item"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #f1f5f9;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.85rem;">TechNova Sol</div>
                                    <div style="font-size: 0.7rem; color: #64748b;">20-22 Jan</div>
                                </div>
                                <div
                                    style="background: #f0fdf4; color: #10b981; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                                    Open</div>
                            </div>
                            <div class="ipo-item"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: none;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.85rem;">Global Infra Ltd</div>
                                    <div style="font-size: 0.7rem; color: #64748b;">25-27 Jan</div>
                                </div>
                                <div
                                    style="background: #fef3c7; color: #f59e0b; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                                    Soon</div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>





        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
            let currentWidget = null;
            let currentActiveSymbol = 'BSE:SENSEX';
            let currentInterval = 'D';

            function loadWidgetWithInterval(interval, btn) {
                currentInterval = interval;
                document.querySelectorAll('.mini-tf-btn').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
                loadWidget(currentActiveSymbol);
            }

            const indexData = {
                'BSE:SENSEX': {
                    price: 83580.40,
                    basePrice: 83313.93,
                    low: 83250.27,
                    high: 83784.17,
                    open: 83757.54,
                    close: 83817.69,
                    vol: "14,913,178",
                    sym: "SENSEX",
                    cardValId: 'valSensexCard',
                    cardChgId: 'chgSensexCard',
                    sparkId: 'sparkSensex',
                    history: [35, 38, 30, 32, 25, 28, 20, 22, 15, 18, 20]
                },
                'NSE:NIFTY': {
                    price: 25641.65,
                    basePrice: 25776.00,
                    low: 25600.00,
                    high: 25800.00,
                    open: 25750.00,
                    close: 25776.00,
                    vol: "22,450,112",
                    sym: "NIFTY 50",
                    cardValId: 'valNiftyCard',
                    cardChgId: 'chgNiftyCard',
                    sparkId: 'sparkNifty',
                    history: [30, 32, 35, 38, 36, 40, 38, 42, 40, 45, 42]
                },
                'NSE:BANKNIFTY': {
                    price: 60045.35,
                    basePrice: 60238.15,
                    low: 59500.00,
                    high: 60500.00,
                    open: 60200.00,
                    close: 60238.15,
                    vol: "8,124,556",
                    sym: "NIFTY BANK",
                    cardValId: 'valBankNiftyCard',
                    cardChgId: 'chgBankNiftyCard',
                    sparkId: 'sparkBankNifty',
                    history: [20, 22, 25, 22, 28, 25, 30, 28, 35, 32, 38]
                }
            };

            function loadWidget(symbol) {
                currentWidget = new TradingView.widget({
                    "autosize": true,
                    "symbol": symbol,
                    "interval": currentInterval,
                    "timezone": "Asia/Kolkata",
                    "theme": "dark",
                    "style": "1",
                    "locale": "in",
                    "toolbar_bg": "#111111",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview_widget",
                    "hide_side_toolbar": true,
                    "withdateranges": false,
                    "save_image": false,
                    "details": false,
                    "hotlist": false,
                    "calendar": false,
                    "studies": ["Volume@tv-basicstudies"],
                    "overrides": {
                        "paneProperties.background": "#0b0b0b",
                        "paneProperties.vertGridProperties.color": "#1f1f1f",
                        "paneProperties.horzGridProperties.color": "#1f1f1f",
                        "scalesProperties.textColor": "#94a3b8",
                        "mainSeriesProperties.candleStyle.upColor": "#10b981",
                        "mainSeriesProperties.candleStyle.downColor": "#ef4444",
                        "mainSeriesProperties.candleStyle.wickUpColor": "#10b981",
                        "mainSeriesProperties.candleStyle.wickDownColor": "#ef4444",
                        "mainSeriesProperties.candleStyle.borderUpColor": "#10b981",
                        "mainSeriesProperties.candleStyle.borderDownColor": "#ef4444",
                        "volume.volume.color.1": "#d4af37",
                        "volume.volume.color.0": "#ef4444"
                    }
                });
            }

            function updateChartInterval(interval, btn) {
                currentInterval = interval;
                document.querySelectorAll('.mini-tf-btn').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
                loadWidget(currentActiveSymbol);
            }

            function updateChart(symbol, title) {
                currentActiveSymbol = symbol;
                // Removed chartTitle update as it's now internal to the widget
                document.querySelectorAll('.index-card').forEach(c => c.classList.remove('active'));

                if (symbol === 'BSE:SENSEX') document.getElementById('cardSensex').classList.add('active');
                else if (symbol === 'NSE:NIFTY') document.getElementById('cardNifty').classList.add('active');
                else if (symbol === 'NSE:BANKNIFTY') document.getElementById('cardNiftyBank').classList.add('active');

                syncUI();
                loadWidget(symbol);
            }


            function syncUI() {
                // Rehydrate existing static data
                for (const sym in indexData) {
                    const d = indexData[sym];
                    const diff = d.price - d.basePrice;
                    const pct = (diff / d.basePrice) * 100;
                    const isUp = diff >= 0;
                    const colorClass = isUp ? 'green' : 'red';
                    const sign = isUp ? '+' : '';
                    const changeText = `${sign}${diff.toFixed(2)} (${sign}${pct.toFixed(2)}%)`;
                    const formattedPrice = d.price.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    // Cards
                    const cardVal = document.getElementById(d.cardValId);
                    if (cardVal) {
                        cardVal.innerText = formattedPrice;
                        const cardChg = document.getElementById(d.cardChgId);
                        if (cardChg) {
                            cardChg.innerText = changeText;
                            cardChg.className = `index-chg ${colorClass}`;
                        }

                        // Sparkline
                        const sparkPath = document.querySelector(`#${d.sparkId} .sparkline-path`);
                        if (sparkPath) {
                            const points = d.history.map((val, i) => `${i * 10} ${val}`).join(' L');
                            sparkPath.setAttribute('d', `M${points}`);
                            sparkPath.className.baseVal = `sparkline-path ${colorClass}`;
                        }
                    }
                }

                // If it's one of the known indices, update Hero with static data
                if (indexData[currentActiveSymbol]) {
                    const d = indexData[currentActiveSymbol];
                    const diff = d.price - d.basePrice;
                    const pct = (diff / d.basePrice) * 100;
                    const isUp = diff >= 0;
                    const colorClass = isUp ? 'green' : 'red';
                    const sign = isUp ? '+' : '';
                    const changeText = `${sign}${(diff || 0).toFixed(2)} (${sign}${(pct || 0).toFixed(2)}%)`;

                    // Update Stylish Header
                    if (document.getElementById('indexPrice')) document.getElementById('indexPrice').innerText = (d.price || 0).toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    if (document.getElementById('valSymbol')) document.getElementById('valSymbol').innerText = d.sym;
                    if (document.getElementById('valSymbolText')) document.getElementById('valSymbolText').innerText = d.sym;

                    const hChg = document.getElementById('heroChange');
                    if (hChg) {
                        hChg.innerText = changeText;
                        hChg.className = `index-chg ${colorClass}`;
                        hChg.style.background = isUp ? '#eefcf4' : '#fff1f1';
                        hChg.style.color = isUp ? '#10b981' : '#ef4444';
                    }

                    // Update Range Bar
                    if (document.getElementById('dayLow')) {
                        document.getElementById('dayLow').innerText = d.low.toLocaleString('en-IN');
                        document.getElementById('dayHigh').innerText = d.high.toLocaleString('en-IN');
                        if (document.getElementById('gridClose')) document.getElementById('gridClose').innerText = d.close.toLocaleString('en-IN');
                        if (document.getElementById('valVol')) document.getElementById('valVol').innerText = d.vol;

                        const range = d.high - d.low;
                        const pos = d.price - d.low;
                        const pctPos = (pos / range) * 100;
                        const safePct = Math.max(0, Math.min(100, pctPos));

                        document.getElementById('sliderMarker').style.left = `${safePct}%`;
                        document.getElementById('rangeProgress').style.width = `${safePct}%`;
                    }
                } else {
                    // Custom Stock Selected
                }
            }

            // --- SEARCH FUNCTIONALITY WITH ALPHA VANTAGE ---
            const INDIAN_STOCKS = [
                { s: 'BSE:SENSEX', n: 'SENSEX Index', p: 83580.40 },
                { s: 'NSE:NIFTY', n: 'NIFTY 50', p: 25641.65 },
                { s: 'NSE:BANKNIFTY', n: 'NIFTY BANK', p: 60045.35 },
                { s: 'NSE:RELIANCE', n: 'Reliance Industries Ltd', p: 2985.50 },
                { s: 'NSE:TCS', n: 'Tata Consultancy Services', p: 4250.20 },
                { s: 'NSE:HDFCBANK', n: 'HDFC Bank Ltd', p: 1680.75 },
                // ... (rest of static list serves as fallback/cache)
            ];

            // API CONFIG
            const AV_API_KEY = '0AQTPTM1OF8VJQA1';
            let searchTimeout = null;

            const sInput = document.getElementById('globalSearchInput');
            const sResults = document.getElementById('searchResults');

            if (sInput) {
                sInput.addEventListener('input', (e) => {
                    const q = e.target.value.trim().toUpperCase();
                    if (q.length < 2) { // Wait for at least 2 chars
                        sResults.style.display = 'none';
                        return;
                    }

                    // Debounce API calls (wait 1s after typing stops to save API limits)
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        fetchStockPrice(q);
                    }, 1000);
                });

                document.addEventListener('click', (e) => {
                    if (!sInput.contains(e.target) && !sResults.contains(e.target)) {
                        sResults.style.display = 'none';
                    }
                });
            }

            async function fetchStockPrice(query) {
                sResults.innerHTML = '<div class="search-item" style="color:#64748b;">Searching...</div>';
                sResults.style.display = 'block';

                try {
                    // Try Alpha Vantage for Global Quote (Realtime Price)
                    // Note: Alpha Vantage uses symbols like 'RELIANCE.BSE' or 'TCS.NSE'
                    // We'll try appending .BSE or .NSE if not present. Default to BSE for generic search.
                    let symbolForApi = query;
                    if (!symbolForApi.includes('.')) symbolForApi += '.BSE';

                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbolForApi}&apikey=${AV_API_KEY}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const quote = data['Global Quote'];
                        const price = parseFloat(quote['05. price']);
                        const sym = quote['01. symbol'];

                        // Show API Result
                        sResults.innerHTML = `
                                        <div class="search-item" onclick="selectStock('${sym}', '${sym}', 'stock')">
                                            <div>
                                                <div class="search-symbol">${sym}</div>
                                                <div class="search-name">Live from Alpha Vantage</div>
                                            </div>
                                            <div class="search-price-val" style="color:#10b981;">${price.toLocaleString('en-IN')}</div>
                                        </div>
                                    `;
                    } else {
                        // Fallback to Static List if API limit reached or not found
                        console.log("API limit or not found:", data);
                        showFallbackResults(query);
                    }
                } catch (e) {
                    console.error("API Error", e);
                    showFallbackResults(query);
                }
            }

            function showFallbackResults(q) {
                const results = MarketEngine.search(q);
                if (results.length > 0) {
                    sResults.innerHTML = results.map(m => `
                        <div class="search-item" style="display: flex; gap: 12px; align-items: center;" onclick="selectStock('${m.symbol}', '${m.name}', '${m.type || 'stock'}')">
                            <div style="flex: 1;">
                                <div class="search-symbol">${m.symbol}</div>
                                <div class="search-name">${m.name}</div>
                            </div>
                            <div class="search-price-val">${m.price.toLocaleString('en-IN')}</div>
                        </div>
                    `).join('');
                } else {
                    sResults.innerHTML = '<div class="search-item" style="cursor:default; color:#94a3b8;">No results found</div>';
                }
                sResults.style.display = 'block';
            }

            function selectStock(sym, name, type = 'stock') {
                sInput.value = '';
                sResults.style.display = 'none';
                // Redirect to Stock Detail Page with type info
                window.location.href = `stock_detail.html?symbol=${encodeURIComponent(sym)}&name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`;
            }

            window.onload = function () {
                loadWidget(currentActiveSymbol);
                syncUI();
                // Optional: Mock live update for hero prices of default data
                setInterval(() => {
                    for (let k in indexData) {
                        let v = indexData[k];
                        let change = (Math.random() - 0.5) * (v.price * 0.0005); // 0.05% fluctuation
                        v.price += change;
                        if (v.price < v.low) v.low = v.price;
                        if (v.price > v.high) v.high = v.price;
                    }
                    syncUI();
                }, 3000);
            };

            function startSimulation() {
                setInterval(() => {
                    for (const sym in indexData) {
                        const d = indexData[sym];
                        const oldPrice = d.price;
                        const change = (Math.random() - 0.5) * (d.price * 0.0006);
                        d.price += change;

                        // Keep within day range
                        if (d.price < d.low) d.price = d.low + Math.abs(change);
                        if (d.price > d.high) d.price = d.high - Math.abs(change);

                        // Update Sparkline History (Simulated)
                        // Every 3 seconds, shift history
                        if (Date.now() % 3000 < 1000) {
                            const lastVal = d.history[d.history.length - 1];
                            const nextVal = Math.max(5, Math.min(35, lastVal + (Math.random() - 0.5) * 5));
                            d.history.shift();
                            d.history.push(nextVal);
                        }
                    }

                    // Fluatuate Sectors too
                    for (let i = 1; i <= 9; i++) {
                        const sectEl = document.getElementById(`sect-${i}`);
                        if (sectEl) {
                            let curVal = parseFloat(sectEl.innerText);
                            let newVal = curVal + (Math.random() - 0.5) * 0.05;
                            sectEl.innerText = (newVal > 0 ? '+' : '') + newVal.toFixed(2) + '%';
                            sectEl.className = `sector-pct ${newVal >= 0 ? 'up' : 'down'}`;
                        }
                    }

                    syncUI();
                }, 1000);
            }

            updateChart("BSE:SENSEX", "SENSEX (BSE Index Live)");
            startSimulation();
        </script>

        <!-- Stock Detail View (Hidden by default) -->
        <div id="stockDetailView" style="display: none;">
            <div class="detail-left">
                <section class="main-index-view" style="margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div id="detLogoWrap"></div>
                            <div>
                                <h2 id="detName" style="margin: 0; font-size: 1.5rem;">Bartronics India Limited</h2>
                                <div id="detExchange" style="font-size: 0.8rem; color: #64748b; margin-top: 0.3rem;">NSE
                                     IN</div>
                            </div>
                        </div>
                        <i data-lucide="heart" class="heart-icon" size="24"></i>
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem;">
                        <h2 id="detPrice" style="font-size: 2.5rem; margin: 0;">14.34</h2>
                        <div id="detChange" class="index-chg green" style="font-size: 1.1rem;">+2.39 (+20.00%)</div>
                    </div>

                    <div class="day-range-container">
                        <div class="range-bar-wrapper">
                            <div class="slider-marker" id="detSliderMarker" style="left: 100%;"></div>
                        </div>
                        <div class="range-labels">
                            <span class="low-val" id="detLow">12.00</span>
                            <span class="high-val" id="detHigh">14.34</span>
                        </div>

                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Symbol:</span>
                                <span class="info-val-text" id="detSymbol">ASMS</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Market:</span>
                                <span class="info-val-text">NSE</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">High:</span>
                                <span class="info-val-text" id="detGridHigh">14.34</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Low:</span>
                                <span class="info-val-text" id="detGridLow">12.00</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Prev Open:</span>
                                <span class="info-val-text">12.12</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Prev Close:</span>
                                <span class="info-val-text">11.95</span>
                            </div>
                            <div class="info-item" style="grid-column: span 3;">
                                <span class="info-label">Volume:</span>
                                <span class="info-val-text">10,608,975</span>
                            </div>
                        </div>
                    </div>

                    <div class="timeframe-btns">
                        <button class="tf-btn active">1D</button>
                        <button class="tf-btn">1W</button>
                        <button class="tf-btn">1M</button>
                    </div>

                    <div class="chart-container-realtime" id="detChartContainer">
                        <div id="tradingview_det" style="height:100%; width:100%;"></div>
                    </div>

                    <div class="company-info-section">
                        <h3>Company Info</h3>
                        <p style="color: #64748b; font-size: 0.9rem;">-</p>
                        <div class="company-info-grid">
                            <div><span class="info-label">Website:</span> <span class="info-pair">-</span></div>
                            <div><span class="info-label">Managing Director:</span> <span class="info-pair">-</span>
                            </div>
                            <div><span class="info-label">Established:</span> <span class="info-pair">-</span></div>
                            <div><span class="info-label">Headquarters:</span> <span class="info-pair">-</span></div>
                        </div>
                    </div>

                    <div class="stats-grid-container">
                        <table class="stats-table">
                            <tr>
                                <td class="label">Daily High</td>
                                <td class="val">11.00</td>
                            </tr>
                            <tr>
                                <td class="label">52W High</td>
                                <td class="val">20.00</td>
                            </tr>
                            <tr>
                                <td class="label">Daily Low</td>
                                <td class="val">11.00</td>
                            </tr>
                            <tr>
                                <td class="label">52W Low</td>
                                <td class="val">10.00</td>
                            </tr>
                            <tr>
                                <td class="label">1D Volume</td>
                                <td class="val">261528</td>
                            </tr>
                            <tr>
                                <td class="label">P/B</td>
                                <td class="val">11.34580072</td>
                            </tr>
                            <tr>
                                <td class="label">Basic EPS (TTM)</td>
                                <td class="val">0.07</td>
                            </tr>
                        </table>
                        <table class="stats-table">
                            <tr>
                                <td class="label">1D Change (%)</td>
                                <td class="val red">-3.83%</td>
                            </tr>
                            <tr>
                                <td class="label">1D Volatility</td>
                                <td class="val">7.27%</td>
                            </tr>
                            <tr>
                                <td class="label">1W Perf (%)</td>
                                <td class="val red">-0.27%</td>
                            </tr>
                            <tr>
                                <td class="label">1M Perf (%)</td>
                                <td class="val red">-12.57%</td>
                            </tr>
                            <tr>
                                <td class="label">3M Perf (%)</td>
                                <td class="val red">-19.86%</td>
                            </tr>
                            <tr>
                                <td class="label">YTD Perf (%)</td>
                                <td class="val red">-8.52%</td>
                            </tr>
                            <tr>
                                <td class="label">Mkt Cap</td>
                                <td class="val">3,49,95,86,807.00</td>
                            </tr>
                        </table>
                    </div>

                    <div style="background: white; border-radius: 12px; margin-top: 1rem; padding: 1.5rem;">
                        <table class="stats-table" style="width: 100%;">
                            <tr>
                                <td class="label">ISIN</td>
                                <td class="val">INE855F01042</td>
                            </tr>
                            <tr>
                                <td class="label">Gross Margin (TTM)</td>
                                <td class="val">9.41%</td>
                            </tr>
                            <tr>
                                <td class="label">Net Margin (TTM)</td>
                                <td class="val">5.30%</td>
                            </tr>
                            <tr>
                                <td class="label">PE (TTM)</td>
                                <td class="val">163.61</td>
                            </tr>
                            <tr>
                                <td class="label">Enterprise Value (EV)</td>
                                <td class="val">3,48,72,50,807.00</td>
                            </tr>
                        </table>
                    </div>
                </section>
            </div>

            <div class="detail-right" style="margin-top: 1.5rem;">
                <section class="buy-widget">
                    <div class="input-group">
                        <span class="input-label">Quantity</span>
                        <div class="quantity-input-wrapper">
                            <input type="number" id="buyQuantityInput" class="q-input" value="0" min="1">
                            <button class="max-btn" onclick="setMaxQuantity()">Max</button>
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem;" id="minInvReq">Minimum
                            investment
                            required: 0.00</div>
                    </div>

                    <div style="margin: 1rem 0;">
                        <input type="range" id="buyRangeSlider" style="width: 100%;" min="0" max="100" value="0"
                            oninput="updateBuyFromSlider(this.value)">
                        <div style="text-align: center; color: #94a3b8; font-size: 0.75rem;" id="fundStatus">No
                            available funds</div>
                    </div>

                    <div style="font-weight: 700; margin-top: 2rem; margin-bottom: 1rem;">Trading Information</div>
                    <table class="trading-info-table">
                        <tr>
                            <td>Buy Price</td>
                            <td class="val" id="detBuyPrice">14.34</td>
                        </tr>
                        <tr>
                            <td>Quantity</td>
                            <td class="val" id="displayQuantity">0</td>
                        </tr>
                        <tr>
                            <td>Tax Fees</td>
                            <td class="val" id="buyTaxFees">0.00</td>
                        </tr>
                        <tr>
                            <td>Txn Charge</td>
                            <td class="val" id="buyTxnCharge">0.00</td>
                        </tr>
                        <tr>
                            <td style="font-weight: 700;">Total Est. Investment</td>
                            <td class="val total" id="buyTotalCost">0.00</td>
                        </tr>
                    </table>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button class="buy-btn" id="buyBtn" onclick="handleTradeAction()"
                            style="flex: 1; margin-top: 0;">Buy</button>
                        <button class="buy-btn" id="sellBtn" onclick="handleSellFromDetail()"
                            style="flex: 1; margin-top: 0; background: #ef4444;">Sell</button>
                    </div>
                </section>

                <section id="detailHoldingsSection" class="m-card" style="margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="font-weight: 700; color: #d4af37; display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="history" size="18"></i> Your Holdings
                        </div>
                        <i data-lucide="rotate-cw" size="18" color="#d4af37" style="cursor: pointer;"
                            onclick="if(typeof renderDetailHoldings === 'function') renderDetailHoldings()"></i>
                    </div>
                    <div id="detHoldingsList" style="max-height: 300px; overflow-y: auto;">
                        <div style="text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem;">No active
                            holdings.</div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Discover View (Hidden by default) -->
        <div id="discoverView">
            <aside class="discover-sidebar">
                <div class="discover-nav-item active" onclick="switchDiscoverTab('trades')">
                    <i data-lucide="trending-up"></i> Trades
                </div>
                <div class="discover-nav-item" onclick="switchDiscoverTab('transactions')">
                    <i data-lucide="file-text"></i> Transactions
                </div>
                <div class="discover-nav-item" onclick="switchDiscoverTab('upcoming')">
                    <i data-lucide="calendar"></i> Upcoming
                </div>
            </aside>

            <div class="discover-main">
                <!-- Trades Section -->
                <div id="tradesSection" class="discover-card">
                    <div class="discover-head">
                        <div
                            style="font-weight: 700; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            <i data-lucide="trending-up"></i> Trades
                        </div>
                        <div class="refresh-circle"><i data-lucide="rotate-cw" size="18"></i></div>
                    </div>
                    <div class="discover-tabs">
                        <div class="d-tab active" onclick="switchTradesTab(this, 'all')"><i data-lucide="layout-grid"
                                size="18"></i> All</div>
                        <div class="d-tab" onclick="switchTradesTab(this, 'stocks')"><i data-lucide="trending-up"
                                size="18"></i> Ins. Stocks</div>
                        <div class="d-tab" onclick="switchTradesTab(this, 'otc')"><i data-lucide="box" size="18"></i>
                            OTC</div>
                        <div class="d-tab" onclick="switchTradesTab(this, 'ipo')"><i data-lucide="rocket" size="18"></i>
                            IPO</div>
                    </div>
                    <div id="tradesList" style="margin-top: 1rem;">
                        <!-- List of trades will appear here -->
                        <div style="color: #94a3b8; font-size: 0.9rem;">No data.</div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactionsSection" class="discover-card" style="display: none;">
                    <div class="discover-head">
                        <div
                            style="font-weight: 700; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            <i data-lucide="file-text"></i> Transactions
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="search-circle"><i data-lucide="search" size="18"></i></div>
                            <div class="refresh-circle"><i data-lucide="rotate-cw" size="18"></i></div>
                        </div>
                    </div>
                    <div class="discover-tabs" id="transactionTabs">
                        <div class="d-tab-pill active" onclick="switchTransactionTab(this, 'all')">All</div>
                        <div class="d-tab-pill" onclick="switchTransactionTab(this, 'holding')">Holding</div>
                        <div class="d-tab-pill" onclick="switchTransactionTab(this, 'sold')">Sold</div>
                        <div class="d-tab-pill" onclick="switchTransactionTab(this, 'pending')">Pending</div>
                        <div class="d-tab-pill" onclick="switchTransactionTab(this, 'pendingPayment')">Pending Payment
                        </div>
                        <div class="d-tab-pill" onclick="switchTransactionTab(this, 'rejected')">Rejected</div>

                    </div>
                    <div id="transList" class="trans-list-container">
                        <!-- Dynamic content -->
                        <div style="color: #94a3b8; font-size: 0.9rem;">No data.</div>
                    </div>
                </div>

                <!-- Upcoming Section -->
                <div id="upcomingSection" class="discover-card" style="display: none;">
                    <div class="discover-head">
                        <div
                            style="font-weight: 700; color: #3b82f6; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                            <i data-lucide="calendar" color="#10b981"></i> Upcoming
                        </div>
                        <div class="refresh-circle"><i data-lucide="rotate-cw" size="18"></i></div>
                    </div>
                    <div style="padding-top: 1rem; color: #94a3b8; font-size: 0.9rem;">No data.</div>
                </div>
            </div>
        </div>

        <!-- Portfolio View (Hidden by default) -->
        <div id="portfolioView">
            <div class="portfolio-left">
                <!-- Assets Card -->
                <div class="p-card">
                    <div class="p-card-title">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="credit-card" size="20"></i> Assets <i data-lucide="eye" size="16"
                                color="#64748b" style="cursor: pointer;" id="assetToggleEye"
                                onclick="toggleAssetsVisibility()"></i>
                        </div>
                        <i data-lucide="rotate-cw" size="18" style="cursor: pointer;" onclick="auditFinancials(this)"
                            title="Refresh & Audit Financials"></i>
                    </div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 1rem;">INR</div>
                    <div class="p-assets-grid">
                        <div class="p-asset-item">
                            <span class="p-asset-label">Available Balance</span>
                            <span class="p-asset-val" id="pAvailableBalance" data-val="0.00">0.00</span>
                            <span class="p-asset-sub">Cash</span>
                        </div>
                        <div class="p-asset-item">
                            <span class="p-asset-label">Current Investments</span>
                            <span class="p-asset-val" id="pCurrentInvested" data-val="0.00">0.00</span>
                            <span class="p-asset-sub">Invested</span>
                        </div>
                        <div class="p-asset-item">
                            <span class="p-asset-label">Promotional Credits</span>
                            <span class="p-asset-val" id="pPromoCredits" data-val="0.00">0.00</span>
                            <span class="p-asset-sub">Bonus</span>
                        </div>
                        <div class="p-asset-item">
                            <span class="p-asset-label">Pending Funds</span>
                            <span class="p-asset-val" id="pPendingFunds" data-val="0.00">0.00</span>
                            <span class="p-asset-sub">Frozen</span>
                        </div>
                        <div class="p-asset-item">
                            <span class="p-asset-label">Borrowed Funds</span>
                            <span class="p-asset-val" id="pBorrowedFunds" data-val="0.00">0.00</span>
                            <span class="p-asset-sub">Loan</span>
                        </div>
                        <div class="p-asset-item">
                            <span class="p-asset-label">Outstanding</span>
                            <span class="p-asset-val red" id="pPendingSettlement" data-val="0.00">0.00</span>
                            <span class="p-asset-sub red" style="cursor: pointer; text-decoration: underline;"
                                onclick="showDiscoverView('transactions'); switchTransactionTab(null, 'pendingPayment');">Clear
                                Due</span>
                        </div>
                    </div>
                </div>

                <div class="p-btn-row">
                    <button class="p-btn deposit" onclick="window.location.href='deposit.html'"><i
                            data-lucide="arrow-up-circle"></i> Deposit</button>
                    <button class="p-btn withdraw" onclick="window.location.href='withdraw.html'"><i
                            data-lucide="arrow-down-circle"></i> Withdraw</button>
                </div>

                <!-- Statistics Section -->
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <!-- Invested Card -->
                    <div class="p-card" style="flex: 1; margin-bottom: 0; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                            <span style="font-weight: 700; color: #1e56a0;">Invested</span>
                            <span style="font-size: 0.8rem; color: #3b82f6;">INR</span>
                        </div>
                        <div style="text-align: center;">
                            <div id="pInvestedMain"
                                style="font-size: 1.25rem; font-weight: 800; color: #3b82f6; margin-bottom: 0.25rem;">
                                0.00</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 1.5rem; font-weight: 500;">
                                Total Invested</div>
                            <div class="donut-circle-box"
                                style="margin: 0 auto 2rem; width: 140px; height: 140px; position: relative;">
                                <svg viewBox="0 0 100 100"
                                    style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="#3b82f6" stroke-width="10" />
                                    <circle id="pDonutCircle" cx="50" cy="50" r="40" fill="none" stroke="#10b981"
                                        stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="251.2"
                                        stroke-linecap="round"
                                        style="transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);" />
                                </svg>
                                <div
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div id="pDonutPct" style="font-size: 1.2rem; font-weight: 800; color: #1e293b;">0%
                                    </div>
                                    <div
                                        style="font-size: 0.6rem; color: #94a3b8; font-weight: 600; text-transform: uppercase;">
                                        Profit</div>
                                </div>
                            </div>
                            <div
                                style="display: flex; justify-content: center; gap: 1.5rem; font-size: 0.8rem; margin-bottom: 1.5rem; padding: 0 0.5rem;">
                                <span
                                    style="display: flex; align-items: center; gap: 6px; font-weight: 600; color: #475569;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;">
                                    </div> Invested
                                </span>
                                <span
                                    style="display: flex; align-items: center; gap: 6px; font-weight: 600; color: #475569;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #10b981;">
                                    </div> Profit
                                </span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-around; border-top: 1px solid #f1f5f9; padding-top: 1.25rem;">
                                <div style="text-align: left; flex: 1;">
                                    <div
                                        style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">
                                        Overall Profit</div>
                                    <div id="pProfitMain" style="font-weight: 800; font-size: 1.1rem; color: #10b981;">
                                        0.00</div>
                                </div>
                                <div style="text-align: right; flex: 1;">
                                    <div
                                        style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">
                                        Growth (ROI)</div>
                                    <div id="pROIMain" style="font-weight: 800; font-size: 1.1rem; color: #1e293b;">
                                        0.00%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Trades Card -->
                    <div class="p-card" style="flex: 1; margin-bottom: 0; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                            <span style="font-weight: 700; color: #1e56a0;">Trades</span>
                            <span style="font-size: 0.8rem; color: #64748b;">ROI Tracking</span>
                        </div>
                        <div style="text-align: center; position: relative; padding-top: 1rem;">
                            <div
                                style="width: 180px; height: 90px; margin: 0 auto; position: relative; overflow: hidden;">
                                <svg viewBox="0 0 100 50" style="width: 100%; height: 100%;">
                                    <!-- Background Gauge Track -->
                                    <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#f1f5f9" stroke-width="10"
                                        stroke-linecap="round" />
                                    <!-- Segmented Indicators -->
                                    <path d="M 10 50 A 40 40 0 0 1 35 15" fill="none" stroke="#f87171" stroke-width="10"
                                        opacity="0.6" />
                                    <path d="M 35 15 A 40 40 0 0 1 65 15" fill="none" stroke="#fbbf24" stroke-width="10"
                                        opacity="0.6" />
                                    <path d="M 65 15 A 40 40 0 0 1 90 50" fill="none" stroke="#10b981" stroke-width="10"
                                        opacity="0.6" />
                                </svg>
                                <!-- Needle -->
                                <div id="pGaugeNeedle"
                                    style="position: absolute; bottom: 0; left: 50%; width: 3px; height: 45px; background: #1e293b; transform-origin: bottom center; transform: translateX(-50%) rotate(-90deg); transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 4px;">
                                    <div
                                        style="width: 10px; height: 10px; border-radius: 50%; background: #1e293b; position: absolute; bottom: -5px; left: -3.5px; border: 2px solid white;">
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; justify-content: space-around; margin-top: 2rem; border-top: 1px solid #f1f5f9; padding-top: 1.25rem;">
                                <div style="text-align: left; flex: 1;">
                                    <div
                                        style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">
                                        Total Trades</div>
                                    <div id="pTradesCount" style="font-weight: 800; font-size: 1.1rem; color: #1e293b;">
                                        0</div>
                                </div>
                                <div style="text-align: right; flex: 1;">
                                    <div
                                        style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">
                                        Direct Profit</div>
                                    <div id="pTradesProfit"
                                        style="font-weight: 800; font-size: 1.1rem; color: #10b981;">0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-card">
                    <div class="p-card-title">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="pie-chart"></i> Portfolio
                        </div>
                        <i data-lucide="rotate-cw" size="18"></i>
                    </div>
                    <div style="display: flex; gap: 2rem; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: #94a3b8;">PORTFOLIO</div>
                            <div style="font-weight: 700; margin-bottom: 0.5rem;">IN  INR</div>
                            <div style="font-size: 0.75rem; color: #94a3b8;">Total Invested</div>
                            <div id="pPortfolioTotal" style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">
                                0.00</div>

                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                                    <span style="color: #94a3b8;">INS. STOCK (100%)</span><span id="pInsStockVal"
                                        style="font-weight: 600;">0.00</span>
                                </div>
                            </div>
                        </div>
                        <div style="width: 150px; height: 150px; position: relative;">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12" />
                            </svg>
                            <div id="pCircleText"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; text-align: center;">
                                0.00
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-card">
                    <div class="p-card-title" style="color: #a855f7;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="activity"></i> Stocks Trading Stats
                        </div>
                        <div
                            style="background: #1e56a0; color: white; border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
                            <img src="https://flagcdn.com/w20/in.png" width="14"> IN
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                        <div>
                            <div id="pStatsInvested" style="font-size: 1.5rem; font-weight: 700;">0.00</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">Invested</div>
                        </div>
                        <div style="text-align: right;">
                            <div id="pStatsCurrentValue" style="font-size: 0.9rem; font-weight: 700; color: #10b981;">
                                0.00</div>
                            <div style="font-size: 0.8rem; color: #10b981;"><i data-lucide="arrow-up" size="12"></i>
                                <span id="pStatsROI">0.00%</span>
                            </div>
                        </div>
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem;">
                        <span style="color: #10b981;"><i data-lucide="arrow-up" size="14"></i> <span
                                id="valAdvances">18</span> Advances</span>
                        <span style="color: #ef4444;"><span id="valDeclines">4</span> Declines <i
                                data-lucide="arrow-down" size="14"></i></span>
                    </div>
                    <div class="advances-bar"
                        style="display: flex; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden;">
                        <div id="barAdvances" class="adv-green"
                            style="background: #10b981; transition: flex 0.5s ease;">
                        </div>
                        <div id="barDeclines" class="adv-red" style="background: #ef4444; transition: flex 0.5s ease;">
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <div style="font-weight: 700; font-size: 0.85rem; color: #10b981;">Top Gainer</div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                            <div id="pGainerName" style="font-size: 0.85rem;">-</div>
                            <div style="text-align: right;">
                                <div id="pGainerVal" style="font-weight: 700; font-size: 0.85rem;">0.00</div>
                                <div id="pGainerPct" style="font-size: 0.75rem; color: #10b981;"><i
                                        data-lucide="arrow-up" size="12"></i> 0.00%</div>
                            </div>
                        </div>

                        <div style="font-weight: 700; font-size: 0.85rem; color: #ef4444; margin-top: 1.5rem;">Top Loser
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                            <div id="pLoserName" style="font-size: 0.85rem;">-</div>
                            <div style="text-align: right;">
                                <div id="pLoserVal" style="font-weight: 700; font-size: 0.85rem;">0.00</div>
                                <div id="pLoserPct" style="font-size: 0.75rem; color: #ef4444;"><i
                                        data-lucide="arrow-down" size="12"></i> 0.00%</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <div style="font-weight: 700; color: #2dd4bf; margin-bottom: 1rem;">Equity Investment Allocation
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;">
                                    </div>
                                    <div>
                                        <div style="font-size: 0.85rem;">Inst. Stocks</div>
                                        <div id="pAllocInstPct" style="font-size: 0.7rem; color: #94a3b8;">100.00%</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div id="pAllocInstVal" style="font-weight: 700; font-size: 0.85rem;">0.00</div>
                                    <div id="pAllocInstChg" style="font-size: 0.7rem; color: #94a3b8;"><i
                                            data-lucide="minus" size="10"></i>
                                        0.00 (0.00%)</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.8rem;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #2dd4bf;">
                                    </div>
                                    <div>
                                        <div style="font-size: 0.85rem;">-</div>
                                        <div style="font-size: 0.7rem; color: #94a3b8;">0.00%</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 0.85rem;">0.00</div>
                                    <div style="font-size: 0.7rem; color: #94a3b8;"><i data-lucide="minus"
                                            size="10"></i>
                                        0.00 (0.00%)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-card">
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-bottom: 2rem;">
                        <button class="p-tab active" id="btnWeekly" onclick="switchChartData('weekly')">Weekly</button>
                        <button class="p-tab" id="btnMonthly" onclick="switchChartData('monthly')">Monthly</button>
                    </div>

                    <div style="height: 200px; position: relative; border-bottom: 1px solid #fda4af; display: flex; align-items: flex-end; justify-content: space-between; padding: 0 10px; margin-bottom: 1rem;"
                        id="chartContainer">
                        <!-- Bars will be rendered here dynamically -->
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #64748b; margin-top: 0.5rem; margin-bottom: 1.5rem;"
                        id="chartLabels">
                        <!-- Labels will be rendered here dynamically -->
                    </div>
                    <div style="display: flex; gap: 1.5rem; font-size: 0.8rem;">
                        <span style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;"></div>
                            Invested
                        </span>
                        <span style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #10b981;"></div>
                            Profit
                        </span>
                        <span style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b;"></div> ROI
                            (%)
                        </span>
                    </div>
                </div>

                <script>
                    const chartData = {
                        weekly: [
                            { date: '27 Jan', invested: 30, profit: 5, roi: 1.2 },
                            { date: '28 Jan', invested: 45, profit: 8, roi: 1.5 },
                            { date: '29 Jan', invested: 45, profit: 12, roi: 2.1 },
                            { date: '30 Jan', invested: 60, profit: 15, roi: 2.5 },
                            { date: '02 Feb', invested: 60, profit: 18, roi: 2.8 },
                            { date: '03 Feb', invested: 80, profit: 22, roi: 3.2 },
                            { date: 'Today', invested: 100, profit: 25, roi: 3.5 }
                        ],
                        monthly: [
                            { date: 'Oct', invested: 20, profit: 3, roi: 1.0 },
                            { date: 'Nov', invested: 40, profit: 8, roi: 1.8 },
                            { date: 'Dec', invested: 70, profit: 15, roi: 2.5 },
                            { date: 'Jan', invested: 100, profit: 25, roi: 3.5 }
                        ]
                    };

                    function switchChartData(type) {
                        const btnW = document.getElementById('btnWeekly');
                        const btnM = document.getElementById('btnMonthly');
                        if (btnW) btnW.classList.toggle('active', type === 'weekly');
                        if (btnM) btnM.classList.toggle('active', type === 'monthly');

                        const container = document.getElementById('chartContainer');
                        const labels = document.getElementById('chartLabels');
                        const data = chartData[type];

                        // Scaling logic: find max value in set to keep bars visible but relative
                        const maxVal = Math.max(...data.map(d => Math.max(d.invested, d.profit, 1)));

                        // Render Bars with integrated ROI line indicator
                        container.innerHTML = data.map(d => {
                            const hInv = (d.invested / maxVal) * 90; // scale to 90% of container height
                            const hProf = (d.profit / maxVal) * 90;
                            const roiTop = 100 - (Math.min(d.roi * 10, 95)); // placeholder roi visualization

                            return `
                                <div style="display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%; position: relative; justify-content: flex-end;">
                                    <div style="display: flex; gap: 4px; align-items: flex-end; width: 100%; justify-content: center; height: 100%;">
                                        <div style="width: 10px; height: ${hInv}%; background: #3b82f6; border-radius: 2px 2px 0 0;" title="Invested: ${d.invested}"></div>
                                        <div style="width: 10px; height: ${hProf}%; background: #10b981; border-radius: 2px 2px 0 0;" title="Profit: ${d.profit}"></div>
                                    </div>
                                    <!-- ROI Indicator Dot -->
                                    <div style="position: absolute; top: ${roiTop}%; width: 6px; height: 6px; background: #f59e0b; border-radius: 50%; border: 1px solid white; z-index: 2;" title="ROI: ${d.roi}%"></div>
                                </div>
                            `;
                        }).join('');

                        labels.innerHTML = data.map(d => `<span style="flex: 1; text-align: center; font-size: 0.65rem;">${d.date}</span>`).join('');
                    }

                    // Initial chart load
                    document.addEventListener('DOMContentLoaded', () => {
                        switchChartData('weekly');
                    });
                </script>
            </div>

            <div class="portfolio-right">
                <div class="p-card">
                    <div class="p-card-title">
                        <div style="display: flex; align-items: center; gap: 1rem; color: #3b82f6;">
                            <i data-lucide="landmark"></i> Fund Records
                        </div>
                        <i data-lucide="rotate-cw" size="18" style="cursor: pointer;" onclick="manualRefreshFund()"></i>
                    </div>

                    <div class="p-tab-bar" id="fundTabs">
                        <span class="p-tab active" onclick="switchFundTab(this, 'all')">All</span>
                        <span class="p-tab" onclick="switchFundTab(this, 'today')">Today</span>
                        <span class="p-tab" onclick="switchFundTab(this, '7D')">7D</span>
                        <span class="p-tab" onclick="switchFundTab(this, '30D')">30D</span>
                        <span class="p-tab" onclick="switchFundTab(this, '90D')">90D</span>
                    </div>

                    <div class="date-filter-row">
                        <div class="date-input-group">
                            <input type="date" placeholder="dd/mm/yyyy" id="fundDateFrom"> <i data-lucide="calendar"
                                size="16"></i>
                        </div>
                        <div class="date-input-group">
                            <input type="date" placeholder="dd/mm/yyyy" id="fundDateTo"> <i data-lucide="calendar"
                                size="16"></i>
                        </div>
                        <button class="clear-btn" onclick="clearFundFilters()">Clear</button>
                    </div>

                    <div style="display: flex; gap: 1.5rem; font-size: 0.85rem; color: #64748b; margin-bottom: 2rem;">
                        <span id="fundRecordCount">10 records</span>
                        <span></span>
                        <span style="color: #64748b;">Total: <span id="fundTotalAmount"
                                style="color: #ef4444; font-weight: 700;">-6,38,64,170.43</span> INR</span>
                    </div>

                    <div id="fundRecordsList">
                        <!-- Dynamic Records -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Me View (Redesigned) -->
        <div id="meView" class="me-view-container" style="display: none;">
            <div class="me-left-col">
                <!-- Profile Card -->
                <div class="me-card">
                    <div class="me-card-tag"><i data-lucide="rotate-cw" size="18"></i></div>
                    <div class="me-title-row">
                        <i data-lucide="user-circle"></i> Your Profile
                    </div>
                    <div class="me-profile-main">
                        <div class="me-p-avatar" id="meAvatarInitials">U</div>
                        <div class="me-p-info">
                            <h2 id="meUserDisplayName">User Name</h2>
                            <p>Full Name: <span id="meFullName">-</span></p>
                            <p>Username: <span id="meUsername">-</span></p>
                            <p style="margin-top: 0.5rem;">KYC Status: <span id="meKycStatusBadge" class="kyc-approved"
                                    style="background: #f1f5f9; color: #64748b;">Not Verified</span></p>
                        </div>
                    </div>
                    <div class="me-vip-stats">
                        <div class="me-stat-item blue">
                            <span class="me-stat-label">Credit Score</span>
                            <span class="me-stat-val blue" id="meCreditScore">0</span>
                        </div>
                        <div class="me-stat-item gold">
                            <span class="me-stat-label">VIP</span>
                            <span class="me-stat-val gold" id="meVipLevel">0</span>
                        </div>
                    </div>
                    <div class="me-btn-row">
                        <button class="me-btn deposit" onclick="window.location.href='deposit.html'">
                            <i data-lucide="landmark"></i> Deposit
                        </button>
                        <button class="me-btn withdraw" onclick="window.location.href='withdraw.html'">
                            <i data-lucide="wallet"></i> Withdraw
                        </button>
                    </div>
                </div>

                <!-- Assets Card -->
                <div class="me-card">
                    <div class="me-card-tag"><i data-lucide="rotate-cw" size="18"></i></div>
                    <div class="me-title-row">
                        <i data-lucide="wallet"></i> Assets <i data-lucide="eye" size="14"
                            style="margin-left: 5px;"></i>
                    </div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 1rem;">INR</div>
                    <div class="me-asset-grid">
                        <div class="me-as-card">
                            <div class="me-as-lbl">Available Balance</div>
                            <div class="me-as-val" id="meAvailableBalance">0.00</div>
                            <div class="me-as-sub" style="color: #10b981;">Cash</div>
                        </div>
                        <div class="me-as-card">
                            <div class="me-as-lbl">Current Investments</div>
                            <div class="me-as-val" id="meCurrentInvestments">0.00</div>
                            <div class="me-as-sub" style="color: #3b82f6;">Invested</div>
                        </div>
                        <div class="me-as-card">
                            <div class="me-as-lbl">Promotional Credits</div>
                            <div class="me-as-val" id="meBonusCredits">0.00</div>
                            <div class="me-as-sub" style="color: #db2777;">Bonus</div>
                        </div>
                        <div class="me-as-card">
                            <div class="me-as-lbl">Pending Funds</div>
                            <div class="me-as-val" id="meFrozenFunds">0.00</div>
                            <div class="me-as-sub" style="color: #ef4444;">Frozen</div>
                        </div>
                        <div class="me-as-card">
                            <div class="me-as-lbl">Borrowed Funds</div>
                            <div class="me-as-val" id="meBorrowedFunds">0.00</div>
                            <div class="me-as-sub" style="color: #6366f1;">Loan</div>
                        </div>
                        <div class="me-as-card">
                            <div class="me-as-lbl">Pending Settlement</div>
                            <div class="me-as-val" id="mePendingSettlement">0.00</div>
                            <div class="me-as-sub" style="color: #ef4444;">Outstanding</div>
                        </div>
                    </div>
                </div>

                <!-- Scores Card -->
                <div class="me-card">
                    <div class="me-title-row">
                        <i data-lucide="calculator"></i> Scores and Offers
                    </div>
                    <div class="gauge-wrap">
                        <div class="gauge-score-text" style="color: #64748b;">N/A</div>
                        <svg class="gauge-svg" viewBox="0 0 100 50">
                            <!-- Gauge Background -->
                            <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#f1f5f9" stroke-width="8" />
                            <!-- Colored segments -->
                            <path d="M 10 50 A 40 40 0 0 1 25 20" fill="none" stroke="#ef4444" stroke-width="8" />
                            <path d="M 25 20 A 40 40 0 0 1 50 10" fill="none" stroke="#f59e0b" stroke-width="8" />
                            <path d="M 50 10 A 40 40 0 0 1 75 20" fill="none" stroke="#3b82f6" stroke-width="8" />
                            <path d="M 75 20 A 40 40 0 0 1 90 50" fill="none" stroke="#10b981" stroke-width="8" />

                            <!-- Needle at the beginning (Poor) -->
                            <line x1="50" y1="50" x2="15" y2="45" stroke="#1e293b" stroke-width="2"
                                stroke-linecap="round" />
                            <circle cx="50" cy="50" r="3" fill="#1e293b" />
                        </svg>
                        <div
                            style="font-size: 0.85rem; color: #64748b; margin-top: 1rem; text-align: center; max-width: 400px;">
                            Based on the latest evaluation, your <b>Credit Score is 0</b>. Your credit profile falls
                            under the <b style="color: #64748b;">New Account</b> category.
                        </div>
                        <div class="score-details" style="width: 100%; margin-top: 1.5rem;">
                            <div class="score-row"><span>
                                    <div class="score-dot" style="background:#ef4444"></div>Poor
                                </span> <span>0 - 25</span></div>
                            <div class="score-row"><span>
                                    <div class="score-dot" style="background:#f59e0b"></div>Average
                                </span> <span>26 - 50</span></div>
                            <div class="score-row"><span>
                                    <div class="score-dot" style="background:#fde047"></div>Fair
                                </span> <span>51 - 73</span></div>
                            <div class="score-row"><span>
                                    <div class="score-dot" style="background:#3b82f6"></div>Good
                                </span> <span>74 - 94</span></div>
                            <div class="score-row"><span>
                                    <div class="score-dot" style="background:#10b981"></div>Excellent
                                </span> <span>95 - 100</span></div>
                        </div>
                    </div>
                    <div class="score-info-box">
                        "Your credit score is directly linked to the financial products and benefits you can access.
                        Maintaining a strong score only increases eligibility for exclusive offers, but also helps
                        secure better terms and rates."
                    </div>
                </div>

                <!-- Offers Card -->
                <div class="me-card">
                    <div class="me-title-row">
                        <i data-lucide="gift"></i> Offers
                    </div>
                    <div
                        style="background: #f8fafc; border-radius: 12px; padding: 1.25rem; border: 1px solid #e2e8f0; display: flex; gap: 1rem; align-items: center;">
                        <img src="https://flagcdn.com/w80/in.png" width="40" style="opacity: 0.2;">
                        <div>
                            <div style="font-weight: 700; color: #1e293b;">Tailored Personal Credit Loans</div>
                            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.3rem;">Enjoy a seamless,
                                private borrowing experience designed to complement your lifestyle...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="me-right-col">
                <!-- Applications Card -->
                <div class="me-card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="me-card-tag"><i data-lucide="rotate-cw" size="18"></i></div>
                    <div class="me-apps-header">
                        <div class="me-title-row" style="margin-bottom: 0;">
                            <i data-lucide="layout-list"></i> Applications
                        </div>
                    </div>
                    <div class="app-pill-row">
                        <div class="app-pill active">All</div>
                        <div class="app-pill">Awaiting</div>
                        <div class="app-pill">Approved</div>
                        <div class="app-pill">Rejected</div>
                        <div class="app-pill">Using</div>
                        <div class="app-pill">Repayment</div>
                        <div class="app-pill">Recycled</div>
                    </div>
                    <div class="no-data-wrap">
                        <i data-lucide="inbox" size="48" stroke-width="1" style="margin-bottom: 1rem;"></i>
                        No data.
                    </div>
                </div>
            </div>
        </div>



        <div>
            <footer class="footer-market">
                <div> 2025. Reserved.</div>
                <div class="footer-right">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <img src="https://flagcdn.com/w20/in.png" width="16"> <span id="realTimeClock">13:59:09
                            GMT+5:30</span>
                    </div>
                    <div>Cookie Preference</div>
                </div>
            </footer>
        </div>
    </div>



    <script>
        function setActiveNav(element) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        // Global Helper for Stock Icons
        window.getIconHtml = function (symbol, name, size = 40, color = "#10b981") {
            const sym = symbol.replace('-IPO', '').toUpperCase();
            const cleanName = name.replace(/ (Ltd|Limited|Corporation|Industries|Services|Bank|India|Ltd\.|Limited\.|and)\.?/ig, '').trim().toLowerCase().replace(/\s+/g, '-');

            // Primary sources for Indian stocks (Groww is very reliable)
            const src1 = `https://assets-netstorage.groww.in/stock-logos/${sym}.png`;
            const src2 = `https://assets.upstox.com/content/assets/images/logos/${sym}.png`;
            const src3 = `https://s3-symbol-logo.tradingview.com/${cleanName}--all-around.svg`;

            return `
                <div class="stock-logo-wrap" style="width: ${size}px; height: ${size}px; border-radius: 50%; overflow: hidden; background: #ffffff; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; padding: ${size > 32 ? '4' : '2'}px;">
                    <img src="${src1}" alt="${sym}" style="width: 100%; height: 100%; object-fit: contain;" 
                        onerror="this.src='${src2}'; this.onerror=() => { this.src='${src3}'; this.onerror=() => { this.style.display='none'; this.nextElementSibling.style.display='flex'; }; };">
                    <div class="stock-circle" style="background:${color}; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: ${size * 0.4}px;">${sym[0]}</div>
                </div>
            `;
        };

        lucide.createIcons();

        // Assets Toggle Logic (Main Sidebar)
        let mainAssetsHidden = false;
        const toggleBtn = document.getElementById('toggleAssets');
        const assetAmounts = document.querySelectorAll('.asset-amount');

        assetAmounts.forEach(el => {
            el.setAttribute('data-orig', el.innerText);
        });

        toggleBtn.addEventListener('click', () => {
            mainAssetsHidden = !mainAssetsHidden;

            assetAmounts.forEach(el => {
                if (mainAssetsHidden) {
                    el.innerText = '****';
                } else {
                    el.innerText = el.getAttribute('data-orig');
                }
            });

            const newIconName = mainAssetsHidden ? 'eye-off' : 'eye';
            toggleBtn.innerHTML = `<i data-lucide="${newIconName}" size="16" color="#64748b"></i>`;
            lucide.createIcons();
        });

        // Exchange Switching Logic for Top Gainers/Losers
        // Exchange Switching Logic for Top Gainers/Losers
        const stockData = {
            gainers: {
                NSE: [
                    { t: 'NIRAJISPAT', n: 'Niraj Ispat Industries Limited', p: '257.41', c: '+20.00%', color: '#10b981' },
                    { t: 'PRESSTONIC', n: 'Presstonic Engineering Limited', p: '53.20', c: '+19.82%', color: '#3b82f6' },
                    { t: 'IZMO', n: 'IZMO Limited', p: '841.45', c: '+18.48%', color: '#06b6d4' },
                    { t: 'APOLLOPIPE', n: 'Apollo Pipes Limited', p: '313.40', c: '+18.06%', color: '#10b981' },
                    { t: 'LOYALTEX', n: 'Loyal Textile Mills Limited', p: '314.79', c: '+17.41%', color: '#6366f1' },
                    { t: 'KCEIL', n: 'Kay Cee Energy & Infra Limited', p: '135.80', c: '+16.87%', color: '#f59e0b' }
                ],
                BSE: [
                    { t: 'HDFCBANK', n: 'HDFC Bank Ltd', p: '1,540.20', c: '+2.45%', color: '#3b82f6' },
                    { t: 'RELIANCE', n: 'Reliance Industries Ltd', p: '2,985.40', c: '+1.80%', color: '#6366f1' },
                    { t: 'TCS', n: 'Tata Consultancy Services', p: '4,120.15', c: '+1.20%', color: '#ec4899' }
                ]
            },
            losers: {
                NSE: [
                    { t: 'DHARIWAL', n: 'Dhariwalcorp Limited', p: '78.70', c: '-79.61%', color: '#ef4444' },
                    { t: 'CLEDUCATE', n: 'CL Educate Limited', p: '59.08', c: '-20.00%', color: '#f43f5e' },
                    { t: 'KRISHFL_RE', n: 'KRISHIVAL FOODS LIMITED', p: '23.20', c: '-19.86%', color: '#ef4444' },
                    { t: 'UCL', n: 'Ushanti Colour Chem Limited', p: '52.55', c: '-12.42%', color: '#ec4899' },
                    { t: 'MAHESHWARI', n: 'Maheshwari Logistics Limited', p: '46.27', c: '-12.37%', color: '#f43f5e' },
                    { t: 'VISHWAS', n: 'Vishwas Agri Seeds Limited', p: '38.10', c: '-10.88%', color: '#8b5cf6' }
                ],
                BSE: [
                    { t: 'ZOMATO', n: 'Zomato Limited', p: '255.40', c: '-4.20%', color: '#f43f5e' },
                    { t: 'PAYTM', n: 'One 97 Communications', p: '712.10', c: '-3.15%', color: '#0ea5e9' }
                ]
            }
        };

        function switchExchange(type, exchange) {
            const listId = type === 'gainers' ? 'gainersList' : 'losersList';
            const listContainer = document.querySelector(`#${listId} .auth-locked-content`);
            const data = stockData[type][exchange];

            // Update Tab UI
            const section = listContainer.closest('.m-card');
            if (section) {
                section.querySelectorAll('.exchange-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.innerText === exchange);
                });
            }

            listContainer.innerHTML = data.map(s => `
                <div class="stock-row" style="cursor: pointer" onclick="openStockDetail('${s.t}', '${s.n}', '${exchange}', '${s.p}', '${s.c}', '${type === 'gainers' ? '#10b981' : '#ef4444'}')">
                    <div class="stock-ident">
                        <div>
                            <div class="stock-ticker">${s.t}</div>
                            <div class="stock-full-name">${s.n}  ${exchange}</div>
                        </div>
                    </div>
                    <div class="stock-price-col">
                        <div class="stock-ticker">${s.p}</div>
                        <div class="index-chg ${type === 'gainers' ? 'green' : 'red'}" style="font-size: 0.75rem">${s.c}</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Initialize lists
        if (typeof switchExchange === 'function') {
            switchExchange('gainers', 'NSE');
            switchExchange('losers', 'NSE');
        }

        // Customer Service Toggle


        function closeCS() {
            const modal = document.getElementById('csModal');
            if (modal) modal.style.display = 'none';
        }

        let detailLiveTimer = null;
        function openStockDetail(symbol, name, exchange, price, change, color, type = 'stock') {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('discoverView').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            document.getElementById('stockDetailHeader').style.display = 'flex';
            document.getElementById('stockDetailView').style.display = 'grid';

            // Start Live Updates
            if (detailLiveTimer) clearInterval(detailLiveTimer);
            detailLiveTimer = setInterval(() => {
                const updatedPrice = MarketEngine.getProduct(symbol)?.price || MarketEngine.getIndices()[symbol]?.price;
                if (updatedPrice) {
                    const formatted = '' + updatedPrice.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    document.getElementById('detPrice').innerText = formatted;
                    document.getElementById('detBuyPrice').innerText = formatted;
                    updateBuyCalculations();
                }
            }, 1000);

            // Populate Data
            document.getElementById('detailStockTitle').innerText = name;
            document.getElementById('detName').innerText = name;
            document.getElementById('detExchange').innerText = `${exchange}  IN`;
            document.getElementById('detPrice').innerText = price;
            document.getElementById('detChange').innerText = change;
            document.getElementById('detChange').className = `index-chg ${change.startsWith('+') ? 'green' : 'red'}`;
            document.getElementById('detBuyPrice').innerText = price;
            document.getElementById('detSymbol').innerText = symbol;

            const buyBtn = document.getElementById('buyBtn');
            const sellBtn = document.getElementById('sellBtn');
            if (buyBtn) {
                if (type === 'OTC' || type === 'IPO') {
                    buyBtn.innerText = 'Subscribe';
                    buyBtn.dataset.type = type;
                    if (sellBtn) sellBtn.style.display = 'none';
                } else {
                    buyBtn.innerText = 'Buy';
                    buyBtn.dataset.type = 'stock';
                    if (sellBtn) sellBtn.style.display = 'block';
                }
            }

            // Hide Your Holdings for OTC/IPO
            const holdingsSection = document.getElementById('detailHoldingsSection');
            if (holdingsSection) {
                if (type === 'OTC' || type === 'IPO') {
                    holdingsSection.style.display = 'none';
                } else {
                    holdingsSection.style.display = 'block';
                }
            }

            const detLogoWrap = document.getElementById('detLogoWrap');
            if (detLogoWrap) detLogoWrap.innerHTML = '';

            new TradingView.widget({
                "autosize": true,
                "symbol": exchange + ":" + symbol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "3",
                "locale": "en",
                "toolbar_bg": "#111111",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_det",
                "overrides": {
                    "paneProperties.background": "#111111",
                    "paneProperties.vertGridProperties.color": "#1f1f1f",
                    "paneProperties.horzGridProperties.color": "#1f1f1f",
                    "scalesProperties.textColor": "#94a3b8",
                    "mainSeriesProperties.areaStyle.linecolor": "#d4af37",
                    "mainSeriesProperties.areaStyle.color1": "rgba(212, 175, 55, 0.2)",
                    "mainSeriesProperties.areaStyle.color2": "rgba(212, 175, 55, 0.05)"
                }
            });

            window.scrollTo(0, 0);
            renderDetailHoldings();
            lucide.createIcons();
        }
        window.openStockDetail = openStockDetail;

        async function handleSellFromDetail() {
            const btn = document.getElementById('sellBtn');
            const symbol = document.getElementById('detSymbol')?.innerText;
            const user = window.DB ? window.DB.getCurrentUser() : null;
            if (!user || !symbol) return;

            const originalText = btn.innerText;
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                // Fetch latest trades directly from DB for maximum reliability
                const trades = await window.DB.getTradesByUserId(user.id);
                const myTrades = trades.filter(t => t.status === 'Approved' && t.symbol.toUpperCase() === symbol.toUpperCase());

                if (myTrades.length === 0) {
                    alert("You do not have any active holdings for " + symbol + " to sell.");
                    return;
                }

                // Update global cache just in case
                if (typeof transactionData !== 'undefined') transactionData.all = trades;

                // Open selling modal for the first available holding
                openSellingModal(myTrades[0]);
            } catch (e) {
                console.error("Sell Action Error:", e);
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function closeStockDetail() {
            if (detailLiveTimer) clearInterval(detailLiveTimer);
            document.getElementById('mainDashboard').style.display = 'grid';
            document.querySelector('.header').style.display = 'flex';
            document.getElementById('stockDetailHeader').style.display = 'none';
            document.getElementById('stockDetailView').style.display = 'none';
            lucide.createIcons();
        }
        window.closeStockDetail = closeStockDetail;

        // View Switching Logic (Market / Discover / Portfolio / Me)
        function showMarketView() {
            document.getElementById('mainDashboard').style.display = 'grid';
            document.getElementById('discoverView').style.display = 'none';
            document.getElementById('portfolioView').style.display = 'none';
            document.getElementById('meView').style.display = 'none';
            document.getElementById('stockDetailView').style.display = 'none';
            document.getElementById('stockDetailHeader').style.display = 'none';
            document.querySelector('.header').style.display = 'flex';

            setActiveNav(document.getElementById('navMarket'));
            lucide.createIcons();
        }

        function showDiscoverView() {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('discoverView').style.display = 'grid';
            document.getElementById('portfolioView').style.display = 'none';
            document.getElementById('meView').style.display = 'none';
            document.getElementById('stockDetailView').style.display = 'none';
            document.getElementById('stockDetailHeader').style.display = 'none';
            document.querySelector('.header').style.display = 'flex';

            setActiveNav(document.getElementById('navDiscover'));
            lucide.createIcons();

            // Refresh transactions data when entering discover
            if (typeof fetchUserTransactions === 'function') fetchUserTransactions();
        }

        function showPortfolioView() {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('discoverView').style.display = 'none';
            document.getElementById('portfolioView').style.display = 'grid';
            document.getElementById('meView').style.display = 'none';
            document.getElementById('stockDetailView').style.display = 'none';
            document.getElementById('stockDetailHeader').style.display = 'none';
            document.querySelector('.header').style.display = 'flex';

            setActiveNav(document.getElementById('navPortfolio'));
            lucide.createIcons();

            // Refresh user data (Assets, Balance, Invested)
            DB.refreshCurrentUser().then(fullUser => {
                if (fullUser) syncUserData();
            });

            // Load Fund Records
            if (typeof loadFundRecords === 'function') loadFundRecords();
        }

        function showMeView() {
            document.getElementById('mainDashboard').style.display = 'none';
            document.getElementById('discoverView').style.display = 'none';
            document.getElementById('portfolioView').style.display = 'none';
            document.getElementById('meView').style.display = 'grid';
            document.getElementById('stockDetailView').style.display = 'none';
            document.getElementById('stockDetailHeader').style.display = 'none';
            document.querySelector('.header').style.display = 'flex';

            setActiveNav(document.getElementById('navMe'));

            // Refresh user data (KYC status, balance, etc.) from backend
            DB.refreshCurrentUser().then(fullUser => {
                if (fullUser) syncUserData();
            });

            lucide.createIcons();
        }

        // Application Tabs Logic
        document.querySelectorAll('.app-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.app-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
            });
        });

        let portfolioAssetsHidden = false;
        function toggleAssetsVisibility() {
            portfolioAssetsHidden = !portfolioAssetsHidden;
            const eyeIcon = document.getElementById('assetToggleEye');
            const assetValues = document.querySelectorAll('.p-asset-val');

            if (portfolioAssetsHidden) {
                eyeIcon.setAttribute('data-lucide', 'eye-off');
                assetValues.forEach(el => {
                    el.innerText = '********';
                });
            } else {
                eyeIcon.setAttribute('data-lucide', 'eye');
                assetValues.forEach(el => {
                    el.innerText = el.getAttribute('data-val');
                });
            }
            lucide.createIcons();
        }

        function switchDiscoverTab(tab) {
            // Sidebar active state
            document.querySelectorAll('.discover-nav-item').forEach(el => el.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            // Section visibility
            document.getElementById('tradesSection').style.display = 'none';
            document.getElementById('transactionsSection').style.display = 'none';
            document.getElementById('upcomingSection').style.display = 'none';

            if (tab === 'trades') document.getElementById('tradesSection').style.display = 'block';
            if (tab === 'transactions') {
                document.getElementById('transactionsSection').style.display = 'block';
                fetchUserTransactions().then(() => {
                    const activeTab = document.querySelector('#transactionTabs .d-tab-pill.active');
                    if (activeTab) {
                        // Trigger click to refresh view with data
                        activeTab.click();
                    } else {
                        // Default to All
                        const allTab = document.querySelector('#transactionTabs .d-tab-pill');
                        if (allTab) { allTab.classList.add('active'); switchTransactionTab(allTab, 'all'); }
                    }
                });
            }
            if (tab === 'upcoming') document.getElementById('upcomingSection').style.display = 'block';

            lucide.createIcons();
        }

        async function switchTradesTab(el, type) {
            // Update active state
            document.querySelectorAll('.discover-tabs .d-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            const listContainer = document.getElementById('tradesList');
            let data = [];

            // MAINTENANCE CHECK for Institutional Stocks
            if (type === 'stocks' || type === 'all') {
                const config = await window.DB.getPlatformSettings('institutional_config');
                if (config && config.status === 'Maintenance' && type === 'stocks') {
                    listContainer.innerHTML = `
                        <div style="background: #fff7ed; border: 1px solid #ffedd5; padding: 2rem; border-radius: 12px; text-align: center; margin-top: 1rem;">
                            <div style="color: #9a3412; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">Terminal Under Maintenance</div>
                            <div style="color: #c2410c; font-size: 0.9rem;">The Institutional Trading terminal (057) is currently undergoing scheduled maintenance. Please try again later.</div>
                        </div>
                    `;
                    return;
                }
            }

            if (type === 'all') {
                data = [
                    ...MarketEngine.getAllStocks().map(s => ({ ...s, type: 'stock' })),
                    ...MarketEngine.getOTC().map(s => ({ ...s, type: 'OTC' })),
                    ...MarketEngine.getIPO().map(s => ({ ...s, type: 'IPO' }))
                ];
            } else if (type === 'stocks') {
                data = MarketEngine.getAllStocks().map(s => ({ ...s, type: 'stock' }));
            } else if (type === 'otc') {
                data = MarketEngine.getOTC().map(s => ({ ...s, type: 'OTC' }));
            } else if (type === 'ipo') {
                data = MarketEngine.getIPO().map(s => ({ ...s, type: 'IPO' }));
            }

            if (data.length === 0) {
                listContainer.innerHTML = `<div style="color: #94a3b8; font-size: 0.9rem; margin-top: 1rem;">No data.</div>`;
                return;
            }

            // Decide layout based on type
            const isPremium = (type === 'stocks' || type === 'otc' || type === 'ipo' || (type === 'all' && data.some(d => d.type !== 'stock')));

            if (isPremium) {
                listContainer.style.display = 'grid';
                listContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
                listContainer.style.gap = '1.5rem';
                listContainer.style.padding = '1rem 0';

                listContainer.innerHTML = data.map(s => {
                    const isOTC = s.type === 'OTC';
                    const isIPO = s.type === 'IPO';

                    // Mock additional premium data if missing
                    const profitRange = (isIPO && s.yield) ? s.yield : (isIPO ? "100% - 300%" : "20% - 60%");
                    const vipLv = (isIPO && s.level) ? s.level : (isIPO ? "Lv  2" : "Lv  1");
                    const isLocked = false; // Allow all IPOs to be viewable for now as requested
                    const exchange = s.symbol.includes('NSE') ? 'NSE' : 'BSE';

                    if (s.type === 'stock' && (type === 'all' || type === 'stocks')) {
                        // Regular stocks in "All" view still look premium but slightly different if mixed
                        return `
                            <div class="premium-trade-card">
                                <div class="premium-card-head">
                                    <div class="premium-asset-info">
                                        <div class="premium-asset-name">${s.name}</div>
                                        <div class="premium-asset-meta">${exchange}  Standard Stock</div>
                                    </div>
                                    <div class="premium-return-rate">
                                        <span class="premium-return-label">Volatility</span>
                                        <span class="premium-return-val" style="color:${s.change >= 0 ? '#10b981' : '#ef4444'}">${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)}%</span>
                                    </div>
                                </div>
                                <div class="premium-details-grid">
                                    <div class="premium-detail-item">
                                        <span class="label">Unit Price</span>
                                        <span class="value">${s.price.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                                    </div>
                                    <div class="premium-detail-item">
                                        <span class="label">Status</span>
                                        <span class="value">Tradable</span>
                                    </div>
                                </div>
                                <button class="premium-subscribe-btn subscribe-btn" style="background:#1e56a0; color:white;"
                                    data-id="${s.symbol}">
                                    Trade Now
                                </button>
                            </div>
                        `;
                    }

                    return `
                        <div class="premium-trade-card">
                            <div class="premium-card-head">
                                <div class="premium-asset-info">
                                    <div>
                                        <div class="premium-asset-name">${s.name}</div>
                                        <div class="premium-asset-meta">${exchange}  ${s.type} Asset</div>
                                    </div>
                                </div>
                                <div class="premium-return-rate">
                                    <span class="premium-return-label">${isIPO ? 'Yield' : 'Est. Profit'}</span>
                                    <span class="premium-return-val" style="${isIPO && s.yield ? 'color: #10b981;' : ''}">${profitRange}</span>
                                </div>
                            </div>
                            <div class="premium-details-grid">
                                <div class="premium-detail-item">
                                    <span class="label">Subscription Price</span>
                                    <span class="value">${s.price.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</span>
                                </div>
                                <div class="premium-detail-item">
                                    <span class="label">Level Limit</span>
                                    <span class="value">${vipLv}</span>
                                </div>
                            </div>
                            <button class="premium-subscribe-btn subscribe-btn ${isLocked ? 'locked' : ''}" 
                                data-id="${s.symbol}">
                                ${isLocked ? 'Locked' : 'Subscribe'}
                            </button>
                        </div>
                    `;
                }).join('');
            } else {
                // Regular Stock Layout
                listContainer.style.display = 'grid';
                listContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                listContainer.style.gap = '1rem';
                listContainer.style.padding = '1rem 0';

                listContainer.innerHTML = data.map(s => `
                    <div class="sector-card" style="width: 100%; height: auto; padding: 1.5rem; text-align: left; align-items: flex-start; cursor: default;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 0.5rem;">
                            <div style="text-align: right; width: 100%;">
                                <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 500;">Change</div>
                                <div style="font-size: 1.1rem; font-weight: 800; color: ${s.change >= 0 ? '#10b981' : '#ef4444'};">${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="stock-ticker" style="font-size: 1.1rem; margin-top: 0.5rem;">${s.symbol}</div>
                        <div class="stock-full-name" style="margin-bottom: 1.5rem;">
                            ${s.name} ${s.type !== 'stock' ? `<span style="font-size:0.65rem; background:#eff6ff; color:#3b82f6; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:6px;">${s.type}</span>` : ''}
                        </div>
                        
                        <button class="h-btn view subscribe-btn" style="width: 100%; border-radius: 12px; height: 44px; background: #1e56a0; font-weight: 700;"
                            data-id="${s.symbol}">
                            Trade Now
                        </button>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // --- Trade & Calculation Logic ---

        function updateBuyCalculations() {
            const qtyInput = document.getElementById('buyQuantityInput');
            const priceEl = document.getElementById('detBuyPrice');
            const totalEl = document.getElementById('buyTotalCost');
            const taxEl = document.getElementById('buyTaxFees');
            const txnEl = document.getElementById('buyTxnCharge');
            const displayQty = document.getElementById('displayQuantity'); // Optional display

            if (!qtyInput || !priceEl || !totalEl) return;

            const qty = parseInt(qtyInput.value) || 0;
            // Parse price string like "1,234.56" -> 1234.56
            const priceText = priceEl.innerText.replace(/[^\d.]/g, '');
            const price = parseFloat(priceText) || 0;

            const baseTotal = qty * price;

            // Realtime Market Fees (e.g. 0.12% Tax, 0.03% Txn Charge)
            const tax = baseTotal * 0.0012;
            const txnCharge = baseTotal * 0.0003;
            const finalTotal = baseTotal + tax + txnCharge;

            if (taxEl) taxEl.innerText = '' + tax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (txnEl) txnEl.innerText = '' + txnCharge.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            totalEl.innerText = '' + finalTotal.toLocaleString('en-IN', { maximumFractionDigits: 2 });

            if (displayQty) displayQty.innerText = qty;

            return { qty, price, baseTotal, tax, txnCharge, total: finalTotal };
        }

        async function setMaxQuantity() {
            const user = window.DB && window.DB.getCurrentUser ? window.DB.getCurrentUser() : null;
            if (!user) { alert("Please login first."); return; }

            // Fetch latest balance for accurate max calculation
            const freshUser = await window.DB.refreshCurrentUser();
            const balance = parseFloat(freshUser ? freshUser.balance : user.balance) || 0;

            const priceText = document.getElementById('detBuyPrice').innerText.replace(/[^\d.]/g, '');
            const price = parseFloat(priceText) || 0;

            if (price <= 0) return;

            const maxQty = Math.floor(balance / price);
            document.getElementById('buyQuantityInput').value = maxQty;
            updateBuyCalculations();
        }

        function updateBuyFromSlider(percent) {
            // This requires async balance check ideally, but for slider UI responsiveness, 
            // we might use cached balance or just trigger setMax * percent. 
            // For simplicity, let's assume we want to call setMax then scale it?
            // Better: Get cached balance for speed, real check on buy.
            const user = window.DB && window.DB.getCurrentUser ? window.DB.getCurrentUser() : null;
            if (!user) return;

            // Try to use fresher data if possible, or fallback to cached user
            // Since this is UI interactive, maybe async is tricky, but let's trust cached user object has been refreshed on load
            const balance = parseFloat(user.balance) || 0;
            const priceText = document.getElementById('detBuyPrice').innerText.replace(/[^\d.]/g, '');
            const price = parseFloat(priceText) || 0;

            if (price <= 0) return;

            const maxQty = Math.floor(balance / price);
            const qty = Math.floor(maxQty * (percent / 100));

            document.getElementById('buyQuantityInput').value = qty;
            updateBuyCalculations();
        }

        // Attach listener for manual input
        document.addEventListener('DOMContentLoaded', () => {
            const qInput = document.getElementById('buyQuantityInput');
            if (qInput) qInput.addEventListener('input', updateBuyCalculations);
        });

        let globalModalCallback = null;
        function showModal(type, title, msg, callback) {
            const modal = document.getElementById('globalModal');
            if (!modal) {
                alert(msg);
                if (callback) callback();
                return;
            }
            const iconContainer = document.getElementById('modalIconContainer');
            const icon = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const msgEl = document.getElementById('modalMsg');
            const btn = document.getElementById('modalBtn');
            titleEl.innerText = title;
            msgEl.innerText = msg;
            globalModalCallback = callback;
            if (type === 'success') {
                iconContainer.style.background = 'rgba(212, 175, 55, 0.1)';
                iconContainer.style.color = '#d4af37';
                icon.setAttribute('data-lucide', 'check-circle');
                btn.style.background = 'linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%)';
                btn.style.color = '#000';
            } else if (type === 'error') {
                iconContainer.style.background = 'rgba(239, 68, 68, 0.1)';
                iconContainer.style.color = '#ef4444';
                icon.setAttribute('data-lucide', 'alert-circle');
                btn.style.background = '#ef4444';
                btn.style.color = '#fff';
            } else if (type === 'warning') {
                iconContainer.style.background = 'rgba(245, 158, 11, 0.1)';
                iconContainer.style.color = '#f59e0b';
                icon.setAttribute('data-lucide', 'alert-triangle');
                btn.style.background = '#f59e0b';
                btn.style.color = '#000';
            }
            modal.style.display = 'flex';
            if (window.lucide) window.lucide.createIcons();
        }
        function closeGlobalModal() {
            document.getElementById('globalModal').style.display = 'none';
            if (globalModalCallback) {
                globalModalCallback();
                globalModalCallback = null;
            }
        }

        async function handleTradeAction() {
            const btn = document.getElementById('buyBtn');
            const type = (btn.dataset.type || 'stock').toLowerCase();
            const symbol = document.getElementById('detSymbol').innerText;
            const stockName = document.getElementById('detName').innerText;
            const exchangeText = document.getElementById('detExchange').innerText;

            const calc = updateBuyCalculations();
            if (!calc || calc.qty <= 0) {
                alert("Please enter a valid quantity.");
                return;
            }

            // Institutional Limit Check
            if (type === 'stock') {
                const config = await window.DB.getPlatformSettings('institutional_config');
                if (config) {
                    if (config.status === 'Maintenance') {
                        alert("The Institutional terminal is currently under maintenance. Please try again later.");
                        return;
                    }
                    if (calc.qty > config.max_qty) {
                        alert(`Institutional Limit Exceeded: Maximum allowed quantity for this product is ${config.max_qty.toLocaleString()}.`);
                        return;
                    }
                }
            }

            // Populate Premium Confirmation Modal
            const ocName = document.getElementById('ocAssetName');
            const ocSym = document.getElementById('ocAssetSymbol');
            const ocQty = document.getElementById('ocQuantity');
            const ocPr = document.getElementById('ocPrice');
            const ocBase = document.getElementById('ocBaseAmount');
            const ocTx = document.getElementById('ocTax');
            const ocTn = document.getElementById('ocTxn');
            const ocTot = document.getElementById('ocTotal');
            const ocBtn = document.getElementById('ocConfirmBtn');

            if (ocName) ocName.innerText = stockName;
            if (ocSym) ocSym.innerText = `${symbol}  ${exchangeText}`;
            if (ocQty) ocQty.innerText = calc.qty.toLocaleString();
            if (ocPr) ocPr.innerText = '' + calc.price.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocBase) ocBase.innerText = '' + calc.baseTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTx) ocTx.innerText = '+' + calc.tax.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTn) ocTn.innerText = '+' + calc.txnCharge.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            if (ocTot) ocTot.innerText = '' + calc.total.toLocaleString('en-IN', { minimumFractionDigits: 2 });

            if (ocBtn) {
                ocBtn.innerText = `CONFIRM ${type.toUpperCase()} ORDER`;
                ocBtn.onclick = () => executeConfirmedTrade(type, symbol, stockName, calc);
            }

            const modal = document.getElementById('orderConfirmModal');
            if (modal) modal.style.display = 'flex';
            if (window.lucide) window.lucide.createIcons();
        }

        function closeOrderConfirm() {
            const modal = document.getElementById('orderConfirmModal');
            if (modal) modal.style.display = 'none';
        }

        async function executeConfirmedTrade(type, symbol, stockName, calc) {
            const btn = document.getElementById('ocConfirmBtn');
            const originalText = btn.innerText;
            btn.innerText = "EXECUTING...";
            btn.disabled = true;

            try {
                // 1. Force Refresh User Data to get latest Balance
                const freshUser = await window.DB.refreshCurrentUser();
                if (!freshUser) {
                    alert("Session expired. Please login again.");
                    window.location.href = 'login.html';
                    return;
                }

                // 2. Validate Balance
                const currentBalance = parseFloat(freshUser.balance || 0);
                const isInsufficient = calc.total > currentBalance;

                if (type.toLowerCase() === 'stock' && isInsufficient) {
                    showModal('error', 'Insufficient Balance', `Your available balance is ${currentBalance.toFixed(2)}, but total cost is ${calc.total.toFixed(2)}.`, () => {
                        closeOrderConfirm();
                    });
                    return;
                }

                // 3. Submit Trade
                let tradeStatus = 'Holding';
                if (['otc', 'ipo'].includes(type.toLowerCase())) tradeStatus = 'Pending';

                const tradeData = {
                    user_id: freshUser.id,
                    symbol: symbol,
                    name: stockName,
                    type: type.toLowerCase(),
                    quantity: calc.qty,
                    price: calc.price,
                    total_amount: calc.total,
                    tax_amount: calc.tax,
                    txn_charge: calc.txnCharge,
                    admin_note: isInsufficient ? 'OUTSTANDING:' + currentBalance : '',
                    status: tradeStatus
                };

                const result = await window.DB.submitTrade(tradeData);

                if (result.success) {
                    if (tradeStatus === 'Holding' || isInsufficient) {
                        const deduction = isInsufficient ? currentBalance : calc.total;
                        const newBalance = currentBalance - deduction;
                        const currentInvested = parseFloat(freshUser.invested) || 0;
                        const newInvested = currentInvested + deduction;

                        const currentOutstanding = parseFloat(freshUser.outstanding) || 0;
                        const addedOutstanding = isInsufficient ? (calc.total - currentBalance) : 0;
                        const newOutstanding = currentOutstanding + addedOutstanding;

                        await window.DB.updateUserFinancials(freshUser.id, newBalance, newInvested, newOutstanding);
                    }

                    closeOrderConfirm();

                    if (tradeStatus === 'Holding') {
                        showModal('success', 'Order Successful', `Successfully purchased ${calc.qty} shares of ${stockName}.`, () => {
                            window.DB.refreshCurrentUser().then(() => {
                                if (typeof syncUserData === 'function') syncUserData();
                                if (typeof renderDetailHoldings === 'function') renderDetailHoldings();
                                if (typeof fetchUserTransactions === 'function') fetchUserTransactions();
                            });
                        });
                    } else if (isInsufficient) {
                        showModal('warning', 'Order Queued', `Your balance of ${currentBalance.toLocaleString('en-IN')} has been applied. Please settle the remaining ${(calc.total - currentBalance).toLocaleString('en-IN')} to finalize your subscription.`, () => {
                            window.DB.refreshCurrentUser().then(() => {
                                if (typeof syncUserData === 'function') syncUserData();
                                showDiscoverView('transactions');
                                switchTransactionTab(null, 'pendingPayment');
                            });
                        });
                    } else {
                        // For OTC/IPO that isn't insufficient but just needs a nicer approval modal
                        openPurchaseModal(type, symbol, stockName, calc.qty, calc.total);
                    }
                } else {
                    alert("Submission failed: " + (result.error?.message || "Unknown error"));
                }
            } catch (e) {
                console.error("Trade Error:", e);
                alert("An error occurred: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        let currentPurchaseData = null;

        function openPurchaseModal(type, symbol, name, qty, total) {
            currentPurchaseData = { type, symbol, name, qty, total };

            document.getElementById('cpName').innerText = name;
            document.getElementById('cpSymbol').innerText = symbol;
            document.getElementById('cpQty').innerText = qty;
            document.getElementById('cpTotal').innerText = `${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;

            document.getElementById('purchaseConfirmModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closePurchaseModal() {
            document.getElementById('purchaseConfirmModal').style.display = 'none';
            currentPurchaseData = null;
        }

        window.confirmPurchaseSubscription = async function () {
            const btn = document.getElementById('cpSubmitBtn');
            const originalText = btn.innerText;

            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                showModal('success', 'Request Received', `Your subscription request for ${currentPurchaseData.name} has been received and is waiting for administrator approval.`, () => {
                    closePurchaseModal();
                    if (typeof fetchUserTransactions === 'function') fetchUserTransactions();
                });
            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };


        // --- Helper: SYNC User Data to UI ---
        // --- Helper: SYNC User Data to UI ---


        // Initialize Discover Trades and View Routing
        document.addEventListener('DOMContentLoaded', async () => {
            // Force refresh user data on load
            if (DB.getCurrentUser()) {
                await DB.refreshCurrentUser(); // Use refreshCurrentUser instead of refreshUserData for consistency if needed, but DB.refreshUserData was used before. Let's stick to refreshUserData if it exists or refreshCurrentUser. 
                // Checking DB.js: refreshUserData doesn't exist? refreshCurrentUser does.
                // Wait, previous code used refreshUserData? Let's check. 
                syncUserData();
            }

            const allTab = document.querySelector('.discover-tabs .d-tab.active');
            if (allTab) switchTradesTab(allTab, 'all');

            // --- REALTIME LISTENER FOR BALANCE UPDATES ---
            const user = DB.getCurrentUser();
            const client = DB.getClient();
            if (user && client) {
                client.channel('public:users:' + user.id)
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'users',
                        filter: `id=eq.${user.id}`
                    }, async (payload) => {
                        console.log('Realtime Update:', payload);
                        await DB.refreshCurrentUser();
                        syncUserData();
                    })
                    .subscribe();

                // --- ROBUST POLLING AS FALLBACK ---
                setInterval(async () => {
                    const fresh = await DB.refreshCurrentUser();
                    if (fresh) syncUserData();
                }, 3000); // Check every 3 seconds
            }


            // Handle URL View Parameter
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            if (view === 'discover') {
                showDiscoverView();
                fetchUserTransactions(); // Fetch trades when entering discover
            } else if (view === 'portfolio') {
                showPortfolioView();
            } else if (view === 'me') {
                showMeView();
            } else {
                showMarketView();
                const symbol = urlParams.get('symbol');
                if (symbol && typeof window.MarketEngine !== 'undefined') {
                    const s = window.MarketEngine.getProduct(symbol);
                    if (s) {
                        openStockDetail(s.symbol, s.name, 'NSE', '' + s.price.toLocaleString('en-IN', { minimumFractionDigits: 2 }), (s.change >= 0 ? '+' : '') + (s.change || 0).toFixed(2) + '%', (s.change >= 0 ? '#10b981' : '#ef4444'), s.type);
                    }
                }
            }
        });

        window.transactionData = {
            all: [],
            holding: [],
            sold: [],
            pending: [],
            rejected: [],
            unsettled: []
        };

        async function renderDetailHoldings() {
            const user = window.DB ? window.DB.getCurrentUser() : null;
            const symbolEl = document.getElementById('detSymbol');
            const symbol = symbolEl?.innerText;
            const list = document.getElementById('detHoldingsList');
            if (!user || !symbol || !list) return;

            const updateList = async () => {
                try {
                    const trades = await window.DB.getTradesByUserId(user.id);
                    const myTrades = trades.filter(t => t.status === 'Holding' && t.symbol.toUpperCase() === symbol.toUpperCase());

                    if (myTrades.length > 0) {
                        list.innerHTML = myTrades.map(t => {
                            const date = new Date(t.created_at).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                            const lp = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(t.symbol) : null;
                            const cp = lp ? lp.price : parseFloat(t.price);
                            const prof = (cp * t.quantity) - parseFloat(t.total_amount);

                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #f1f5f9;">
                                    <div style="text-align: left;">
                                        <div style="font-weight: 700; font-size: 0.9rem; color: #f8fafc;">${t.symbol}</div>
                                        <div style="font-size: 0.75rem; color: #94a3b8;">${date}  Buy Price ${parseFloat(t.price).toLocaleString('en-IN')}</div>
                                        <button class="h-btn close close-order-btn" style="margin-top: 0.5rem; padding: 4px 12px; height: auto; font-size: 0.75rem;" data-id="${t.id}">Close Order</button>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: #d4af37;">${parseFloat(t.total_amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div>
                                        <div style="font-size: 0.75rem; color: ${prof >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${prof >= 0 ? '+' : ''}${prof.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        list.innerHTML = `<div style="text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem;">No active holdings for this stock.</div>`;
                    }
                } catch (e) {
                    console.error("Error rendering detail holdings:", e);
                }
            };

            await updateList();
            if (window.detHoldLiveInterval) clearInterval(window.detHoldLiveInterval);
            window.detHoldLiveInterval = setInterval(() => {
                if (document.getElementById('stockDetailView').style.display === 'none') {
                    clearInterval(window.detHoldLiveInterval);
                    return;
                }
                updateList();
            }, 3000);
        }
        window.renderDetailHoldings = renderDetailHoldings;

        async function fetchUserTransactions() {
            const user = window.DB ? window.DB.getCurrentUser() : null;
            if (!user) return;

            // Fetch latest trades
            const trades = await window.DB.getTradesByUserId(user.id);
            console.log("Trade Statuses:", trades.map(t => t.status));

            // Frontend-only categorization: Standardize legacy stock statuses to 'Holding'
            // without modifying the database.
            window.transactionData = {
                all: trades,
                holding: trades.filter(t => t.status === 'Holding' || (t.type === 'stock' && ['Settled', 'Approved', 'Confirmed'].includes(t.status))),
                sold: trades.filter(t => t.status === 'Sold'),
                pending: trades.filter(t => t.status === 'Pending' && !(t.admin_note || "").startsWith('OUTSTANDING')),
                rejected: trades.filter(t => t.status === 'Rejected'),
                pendingPayment: trades.filter(t => (t.status === 'Pending' && (t.admin_note || "").startsWith('OUTSTANDING')) || t.status === 'Awaiting'),
                unsettled: trades.filter(t => !['Holding', 'Sold', 'Pending', 'Rejected'].includes(t.status))
            };
        }
        window.fetchUserTransactions = fetchUserTransactions;

        function switchTransactionTab(el, tabName) {
            document.querySelectorAll('#transactionTabs .d-tab-pill').forEach(pill => pill.classList.remove('active'));
            if (el) el.classList.add('active');

            const list = document.getElementById('transList');
            // If tabName is not in keys, default to empty array
            const data = (window.transactionData && window.transactionData[tabName]) ? window.transactionData[tabName] : [];

            if (!data || data.length === 0) {
                list.innerHTML = `<div style="color: #94a3b8; font-size: 0.9rem; margin-top: 1rem; text-align:center; padding: 2rem;">No data found.</div>`;
                return;
            }

            if (tabName === 'holding') {
                let html = `<div class="holding-grid">`;
                data.forEach(item => {
                    const liveProd = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(item.symbol) : null;
                    const mockCurrPrice = liveProd ? liveProd.price : parseFloat(item.price);
                    const profit = (mockCurrPrice * item.quantity) - parseFloat(item.total_amount);
                    const profitPct = (profit / parseFloat(item.total_amount)) * 100;

                    html += `
                        <div class="h-card">
                            <div class="h-head" style="margin-bottom: 1.5rem;">
                                <div class="h-stock-info">
                                    <h3 style="margin:0; font-size:1rem;">${item.name} <span style="color:#94a3b8; font-size:0.7rem;">(${item.symbol})</span></h3>
                                    <div class="h-stock-meta">BSE  IN</div>
                                </div>
                                <div class="h-status-badge" style="${item.status === 'Pending' ? 'background:#fef3c7; color:#d97706;' : ''}">
                                    ${item.status === 'Pending' ? 'Processing' : 'Holding'}
                                </div>
                            </div>
                            <div class="h-stats-row">
                                <div class="h-stat-item">
                                    <span class="h-stat-label">Current Price</span>
                                    <span class="h-stat-val ${profit >= 0 ? 'green' : 'red'}" id="hPrice-${item.id}">${mockCurrPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</span>
                                </div>
                                <div class="h-stat-item">
                                    <span class="h-stat-label">Unrealized P&L</span>
                                    <span class="h-stat-val ${profit >= 0 ? 'green' : 'red'}" id="hProfit-${item.id}">
                                        ${profit.toLocaleString('en-IN', { maximumFractionDigits: 2 })}
                                        <span style="font-size:0.75rem;">(${profitPct >= 0 ? '+' : ''}${profitPct.toFixed(2)}%)</span>
                                    </span>
                                </div>
                            </div>
                            <div class="h-actions">
                                <button class="h-btn view" onclick="openHoldingDetail('${item.id}')">View Details</button>
                                ${item.status === 'Holding' ? `<button class="h-btn close close-order-btn" data-id="${item.id}">Close Order</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                list.innerHTML = html;

                // Start live update for this tab
                if (window.holdingLiveInterval) clearInterval(window.holdingLiveInterval);
                window.holdingLiveInterval = setInterval(() => {
                    if (document.getElementById('portfolioView').style.display === 'none' && document.getElementById('discoverView').style.display === 'none') {
                        clearInterval(window.holdingLiveInterval);
                        return;
                    }
                    data.forEach(item => {
                        const lp = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(item.symbol) : null;
                        if (!lp) return;
                        const currPrice = lp.price;
                        const prof = (currPrice * item.quantity) - parseFloat(item.total_amount);
                        const profPct = (prof / parseFloat(item.total_amount)) * 100;

                        const prEl = document.getElementById(`hPrice-${item.id}`);
                        const pEl = document.getElementById(`hProfit-${item.id}`);

                        if (prEl) {
                            prEl.innerText = '' + currPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 });
                            prEl.className = `h-stat-val ${prof >= 0 ? 'green' : 'red'}`;
                        }
                        if (pEl) {
                            pEl.innerHTML = `${prof.toLocaleString('en-IN', { maximumFractionDigits: 2 })} <span style="font-size:0.75rem;">(${profPct >= 0 ? '+' : ''}${profPct.toFixed(2)}%)</span>`;
                            pEl.className = `h-stat-val ${prof >= 0 ? 'green' : 'red'}`;
                        }
                    });
                }, 1000);
            } else {
                let html = `<div class="trans-grid">`;
                data.forEach(item => {
                    const dateStr = new Date(item.created_at).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });

                    let statusColor = '#f59e0b'; // pending yellow
                    if (item.status === 'Approved' || item.status === 'Settled') statusColor = '#10b981';
                    if (item.status === 'Rejected' || item.admin_note === 'OUTSTANDING_BALANCE') statusColor = '#ef4444';
                    if (item.status === 'Sold') statusColor = '#3b82f6';

                    html += `
                        <div class="t-card">
                            <div class="t-card-head">
                                <div style="flex: 1;">
                                    <div class="t-stock-name">${item.name} <span style="color:#64748b; font-size:0.75rem;">(${item.symbol})</span></div>
                                    <div style="font-size: 0.65rem; color: #94a3b8; margin-top:0.2rem;">${item.type.toUpperCase()}  ${dateStr}</div>
                                </div>
                                <div style="font-size:0.7rem; font-weight:700; color:${statusColor}; padding:2px 8px; border-radius:4px; background:${statusColor}15;">
                                    ${item.status}
                                </div>
                            </div>
                            <div class="t-card-body">
                                <div class="t-info-col">
                                    <div class="t-info-label">Quantity</div>
                                    <div class="t-info-val">${item.quantity}</div>
                                </div>
                                <div class="t-info-col">
                                    <div class="t-info-label">Price</div>
                                    <div class="t-info-val">${parseFloat(item.price).toLocaleString('en-IN')}</div>
                                </div>
                                <div class="t-info-col">
                                    <div class="t-info-label">Total</div>
                                    <div class="t-info-val">${parseFloat(item.total_amount).toLocaleString('en-IN')}</div>
                                </div>
                            </div>
                            ${item.admin_note ? `<div style="font-size: 0.75rem; color: #ef4444; margin-top: 0.5rem; padding: 0.5rem; background: #fff1f2; border-radius: 4px;">Note: ${item.admin_note}</div>` : ''}
                            ${(item.type.toLowerCase() === 'otc' || item.type.toLowerCase() === 'ipo' || item.admin_note === 'OUTSTANDING_BALANCE') ? `
                                <div style="margin-top: 1rem; border-top: 1px solid #f1f5f9; padding-top: 0.75rem;">
                                    <button class="h-btn view" style="width: 100%; border-radius: 12px; height: 38px; font-size: 0.85rem;" onclick="openHoldingDetail('${item.id}')">View Details</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
                list.innerHTML = html;
            }
        }
        window.switchTransactionTab = switchTransactionTab;

        const fundRecordsData = {
            all: [],
            today: [],
            '7D': [],
            '30D': [],
            '90D': []
        };

        async function loadFundRecords() {
            const list = document.getElementById('fundRecordsList');
            if (list && list.innerHTML.trim() === '') list.innerHTML = '<div style="text-align:center; padding:2rem; color:#94a3b8;">Loading records...</div>';

            const user = window.DB ? window.DB.getCurrentUser() : null;
            if (!user) return;
            const client = window.DB.getClient();
            if (!client) return;

            try {
                // Fetch all data in parallel
                const [tradesRes, depositsRes, withdrawalsRes] = await Promise.all([
                    window.DB.getTradesByUserId(user.id),
                    client.from('deposits').select('*').eq('user_id', user.id).order('created_at', { ascending: false }),
                    client.from('withdrawals').select('*').eq('user_id', user.id).order('created_at', { ascending: false })
                ]);

                const trades = tradesRes || [];
                const deposits = (depositsRes && depositsRes.data) || [];
                const withdrawals = (withdrawalsRes && withdrawalsRes.data) || [];

                // Debug log
                console.log(`[FundRecords] Found ${trades.length} trades, ${deposits.length} deposits, ${withdrawals.length} withdrawals`);

                let allRecords = [];

                // Normalize Trades
                trades.forEach(t => {
                    const isBuy = t.type !== 'sell'; // Assuming 'sell' type for selling
                    // Buy = Negative (outflow), Sell = Positive (inflow)
                    // If trade is approved/pending, we show it.
                    allRecords.push({
                        rawDate: new Date(t.created_at),
                        type: isBuy ? `Buy ${t.symbol}` : `Sell ${t.symbol}`,
                        ex: 'Wallet',
                        id: t.id ? String(t.id).substring(0, 8).toUpperCase() : 'N/A',
                        amount: parseFloat(t.total_amount) || 0,
                        isNegative: isBuy, // Buy is expense
                        rawStatus: t.status
                    });
                });

                // Normalize Deposits
                deposits.forEach(d => {
                    allRecords.push({
                        rawDate: new Date(d.created_at),
                        type: 'Deposit',
                        ex: d.method || 'Bank Transfer',
                        id: d.id ? String(d.id).substring(0, 8).toUpperCase() : 'N/A',
                        amount: parseFloat(d.amount) || 0,
                        isNegative: false, // Inflow
                        rawStatus: d.status
                    });
                });

                // Normalize Withdrawals
                withdrawals.forEach(w => {
                    allRecords.push({
                        rawDate: new Date(w.created_at),
                        type: 'Withdrawal',
                        ex: w.method || 'Bank Transfer',
                        id: w.id ? String(w.id).substring(0, 8).toUpperCase() : 'N/A',
                        amount: parseFloat(w.amount) || 0,
                        isNegative: true, // Outflow
                        rawStatus: w.status
                    });
                });

                // Sort by Date Descending
                allRecords.sort((a, b) => b.rawDate - a.rawDate);

                // Helper to format for display
                const mapToDisplay = (rec) => ({
                    type: rec.type,
                    date: rec.rawDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }),
                    ex: `${rec.ex}  ${rec.rawStatus}`,
                    id: rec.id,
                    amount: rec.amount.toLocaleString('en-IN', { minimumFractionDigits: 2 }),
                    isNegative: rec.isNegative,
                    rawDate: rec.rawDate
                });

                // Filter into buckets
                const now = new Date();
                const todayStr = now.toDateString(); // "Fri Feb 11 2026"

                // Rolling windows for others
                const days7 = new Date(now); days7.setDate(now.getDate() - 7);
                const days30 = new Date(now); days30.setDate(now.getDate() - 30);
                const days90 = new Date(now); days90.setDate(now.getDate() - 90);

                fundRecordsData['all'] = allRecords.map(mapToDisplay);

                // Strict Today check (Calendar day)
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                fundRecordsData['today'] = allRecords.filter(r => r.rawDate >= todayStart).map(mapToDisplay);

                // Rolling windows
                fundRecordsData['7D'] = allRecords.filter(r => r.rawDate >= days7).map(mapToDisplay);
                fundRecordsData['30D'] = allRecords.filter(r => r.rawDate >= days30).map(mapToDisplay);
                fundRecordsData['90D'] = allRecords.filter(r => r.rawDate >= days90).map(mapToDisplay);

                // Re-render current tab
                const activeTab = document.querySelector('#fundTabs .p-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    renderFundRecords(tabName);
                } else {
                    renderFundRecords('all');
                }

            } catch (e) {
                console.error("Error loading fund records:", e);
                const list = document.getElementById('fundRecordsList');
                if (list) list.innerHTML = `<div style="text-align: center; color: #ef4444; padding: 2rem;">Failed to load records: ${e.message}</div>`;
            }
        }

        window.manualRefreshFund = async function () {
            const icon = document.querySelector('[data-lucide="rotate-cw"]');
            if (icon) {
                icon.style.transition = 'transform 1s';
                icon.style.transform = 'rotate(360deg)';
            }
            await loadFundRecords();
            if (icon) {
                setTimeout(() => icon.style.transform = 'none', 1000);
            }
            alert("Fund records updated.");
        }

        function switchFundTab(el, tab) {
            document.querySelectorAll('#fundTabs .p-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderFundRecords(tab);
        }

        // Helper to render filtered list
        function renderFundList(data) {
            const list = document.getElementById('fundRecordsList');
            if (data.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem;">No data.</div>`;
                document.getElementById('fundRecordCount').textContent = '0 records';
                document.getElementById('fundTotalAmount').textContent = '0.00';
                return;
            }

            // Update Summary
            let currentTotal = 0;
            data.forEach(item => {
                const val = parseFloat((item.amount || "0").toString().replace(/,/g, ''));
                if (item.isNegative) currentTotal -= val;
                else currentTotal += val;
            });

            const countEl = document.getElementById('fundRecordCount');
            if (countEl) countEl.textContent = `${data.length} records`;

            const totalEl = document.getElementById('fundTotalAmount');
            if (totalEl) {
                totalEl.textContent = `${currentTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                totalEl.style.color = currentTotal >= 0 ? '#10b981' : '#ef4444';
            }

            list.innerHTML = data.map(item => `
                <div class="fund-item-card">
                    <div class="f-item-main">
                        <div class="f-item-type">${item.type}</div>
                        <div class="f-item-sub">${item.date}  ${item.ex}</div>
                        <div class="f-item-id">ID: ${item.id}</div>
                    </div>
                    <div class="f-item-price-col">
                        <div class="f-item-amount ${item.isNegative ? 'red' : 'green'}">${item.amount}</div>
                        <div class="f-item-curr">INR</div>
                    </div>
                </div>
            `).join('');
        }

        function renderFundRecords(tab) {
            const data = fundRecordsData[tab] || fundRecordsData['all'] || [];
            renderFundList(data);
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-IN', { hour12: false });
            const clockEl = document.getElementById('realTimeClock');
            if (clockEl) clockEl.innerText = `${timeString} GMT+5:30`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Date Filtering Logic
        function applyDateFilter() {
            const fVal = document.getElementById('fundDateFrom').value;
            const tVal = document.getElementById('fundDateTo').value;

            // If empty, maybe revert to tab? Let's just filter 'all' if input changes
            if (!fVal && !tVal) return;

            // Deselect tabs visually to indicate custom filter
            document.querySelectorAll('#fundTabs .p-tab').forEach(t => t.classList.remove('active'));

            let list = fundRecordsData['all'] || [];
            if (fVal) {
                const fromD = new Date(fVal);
                fromD.setHours(0, 0, 0, 0);
                list = list.filter(i => i.rawDate && i.rawDate >= fromD);
            }
            if (tVal) {
                const toD = new Date(tVal);
                toD.setHours(23, 59, 59, 999);
                list = list.filter(i => i.rawDate && i.rawDate <= toD);
            }
            renderFundList(list);
        }

        const fundDateFrom = document.getElementById('fundDateFrom');
        if (fundDateFrom) fundDateFrom.addEventListener('change', applyDateFilter);

        const fundDateTo = document.getElementById('fundDateTo');
        if (fundDateTo) fundDateTo.addEventListener('change', applyDateFilter);

        window.clearFundFilters = function () {
            const fFrom = document.getElementById('fundDateFrom');
            const fTo = document.getElementById('fundDateTo');
            if (fFrom) fFrom.value = '';
            if (fTo) fTo.value = '';

            // Reset to All Tab
            const fundTabs = document.getElementById('fundTabs');
            if (fundTabs) {
                const allTab = fundTabs.querySelector('.p-tab'); // First tab is 'All'
                if (allTab) switchFundTab(allTab, 'all');
            } else {
                renderFundRecords('all');
            }
        };

        // Settings Modal Logic
        function deleteAllMessages() {
            const mcList = document.getElementById('mcList');
            const msgCount = document.getElementById('msgCount');
            if (mcList) {
                mcList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem;">No messages</div>';
            }
            if (msgCount) {
                msgCount.innerText = '0 Messages';
            }
        }

        function deleteMessage(btn) {
            const item = btn.closest('.mc-item');
            if (item) {
                item.remove();
                updateMessageCount();
            }
        }

        function updateMessageCount() {
            const mcList = document.getElementById('mcList');
            const msgCount = document.getElementById('msgCount');
            const items = mcList ? mcList.querySelectorAll('.mc-item') : [];
            if (msgCount) {
                msgCount.innerText = `${items.length} Messages`;
            }
            if (mcList && items.length === 0) {
                mcList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem;">No messages</div>';
            }
        }

        function makeAllRead() {
            const dots = document.querySelectorAll('.mc-dot.unread');
            dots.forEach(dot => dot.classList.remove('unread'));
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'flex';
                lucide.createIcons();
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.style.display = 'none';
        }

        function toggleSettingsAccordion(element, id) {
            const subMenu = document.getElementById(id);
            const chevron = element.querySelector('.settings-chevron');

            if (!subMenu) return;

            // Toggle active class
            subMenu.classList.toggle('active');

            // Dynamic max-height for smooth animation
            if (subMenu.classList.contains('active')) {
                subMenu.style.maxHeight = subMenu.scrollHeight + "px";
            } else {
                subMenu.style.maxHeight = null;
            }

            // Toggle rotation class on chevron
            if (chevron) {
                chevron.classList.toggle('rotated');
            }
        }

        // Update Avatar Logic
        function openUpdateAvatar() {
            // Keep settings open behind
            document.getElementById('updateAvatarModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeUpdateAvatar() {
            document.getElementById('updateAvatarModal').style.display = 'none';
        }

        let currentAvatarData = null;

        function previewAvatar(input) {
            const previewCircle = document.getElementById('avatarPreviewCircle');
            const uploadBtn = document.getElementById('uploadAvatarBtn');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    currentAvatarData = e.target.result;
                    previewCircle.innerHTML = `< img src = "${e.target.result}" alt = "Avatar Preview" > `;
                    uploadBtn.classList.add('active');
                    uploadBtn.removeAttribute('disabled');
                    uploadBtn.style.backgroundColor = '#6366f1';
                    uploadBtn.style.cursor = 'pointer';
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function uploadAvatar() {
            const btn = document.getElementById('uploadAvatarBtn');
            if (!btn.classList.contains('active')) return;

            btn.innerText = 'Uploading...';

            setTimeout(() => {
                // Update avatar in settings modal
                const settingsAvatars = document.querySelectorAll('.avatar-circle');
                settingsAvatars.forEach(av => {
                    av.innerHTML = `< img src = "${currentAvatarData}" style = "width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" > `;
                });

                // Also update any other user-avatar elements if present (e.g. Me view or Header if implemented)
                const otherAvatars = document.querySelectorAll('.user-avatar');
                otherAvatars.forEach(av => {
                    av.innerHTML = `< img src = "${currentAvatarData}" style = "width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" >`;
                });

                alert('Avatar updated successfully!');
                btn.innerText = 'Upload Avatar';
                closeUpdateAvatar();
                openSettings(); // Re-open settings to show the updated avatar
            }, 1000);
        }


        // Internal Reset Password Logic (Renamed to prevent conflict with any older logic)
        function openInternalResetPassword() {
            // Keep settings open behind
            document.getElementById('resetPasswordModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeInternalResetPassword() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        function togglePassVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                iconElement.setAttribute('data-lucide', 'eye'); // Change logic if needed, but simple attribute switch works with re-render or just class
                // Simpler: just changing icon class or reliable attribute
                // For lucide, we might need to remove and re-add element or just rely on click
                // Let's use a simpler approach for the icon if lucide doesn't auto-update on attr change without re-run
                iconElement.style.color = '#3b82f6'; // highlight
            } else {
                input.type = "password";
                iconElement.style.color = '#94a3b8';
            }
        }

        function submitPasswordChange() {
            const current = document.getElementById('cpCurrent').value;
            const newP = document.getElementById('cpNew').value;
            const confirmP = document.getElementById('cpConfirm').value;

            if (!current || !newP || !confirmP) {
                alert('Please fill all fields');
                return;
            }

            if (newP !== confirmP) {
                alert('New passwords do not match');
                return;
            }

            const btn = document.getElementById('cpSubmitBtn');
            btn.innerText = 'Updating...';

            setTimeout(() => {
                alert('Password Changed Successfully! Please login again.');
                window.location.href = 'index.html'; // Logout user
            }, 1500);
        }

        // KYC Logic
        function openKYC() {
            // Keep settings open behind
            document.getElementById('kycModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeKYC() {
            document.getElementById('kycModal').style.display = 'none';
        }

        function previewKYCImage(input, previewId, iconId) {
            const preview = document.getElementById(previewId);
            const icon = document.getElementById(iconId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    icon.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function submitKYC() {
            const name = document.getElementById('kycName').value;
            const idDoc = document.getElementById('kycID').value;
            const mobile = document.getElementById('kycMobile').value;

            if (!name || !idDoc || !mobile) {
                alert('Please fill in all required fields.');
                return;
            }

            const btn = document.querySelector('.kyc-submit-btn');
            btn.innerText = 'Submitting...';
            btn.style.opacity = '0.7';

            setTimeout(() => {
                alert('KYC Document Submitted Successfully! Please wait for approval.');
                btn.innerText = 'Submit';
                btn.style.opacity = '1';
                closeKYC();
                syncUserData(); // Sync name change if any
            }, 1500);
        }

        // Edit Name Modal Logic
        function openEditNameModal() {
            const user = DB.getCurrentUser();
            if (!user) return;
            document.getElementById('editNameInput').value = user.name || '';
            document.getElementById('editNameModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeEditNameModal() {
            document.getElementById('editNameModal').style.display = 'none';
        }

        async function saveName() {
            const newName = document.getElementById('editNameInput').value.trim();
            if (!newName) {
                alert('Please enter a name');
                return;
            }

            const btn = document.getElementById('saveNameBtn');
            btn.innerText = 'Saving...';
            btn.disabled = true;

            try {
                const user = DB.getCurrentUser();
                const result = await DB.updateUser(user.id, {
                    full_name: newName,
                    username: newName,
                    name: newName
                });
                if (result.success) {
                    // Update Local Storage immediately
                    user.full_name = newName;
                    user.username = newName;
                    user.name = newName;
                    localStorage.setItem(DB.CURRENT_USER_KEY, JSON.stringify(user));

                    alert('Name updated successfully!');
                    syncUserData(); // Update Me page immediately
                    closeEditNameModal();
                } else {
                    alert('Error: ' + (result.error?.message || 'Failed to update name'));
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred.');
            } finally {
                btn.innerText = 'Save Name';
                btn.disabled = false;
            }
        }

        // Sync User Data to UI
        async function syncUserData() {
            const user = DB.getCurrentUser();

            // Toggle auth lock overlays instead of redirecting
            const lockedElements = document.querySelectorAll('.auth-locked-container');
            if (!user) {
                lockedElements.forEach(el => el.classList.add('is-locked'));
                return;
            } else {
                lockedElements.forEach(el => el.classList.remove('is-locked'));
            }

            // Refresh transactions if on Transaction view or in background
            if (typeof fetchUserTransactions === 'function') {
                await fetchUserTransactions();
                const activeTab = document.querySelector('#transactionTabs .d-tab-pill.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    if (tabName) switchTransactionTab(activeTab, tabName);
                }
            }

            // Remote DB sync for latest balance and pending items
            const client = DB.getClient();
            let dbUser = user;
            let effectiveBalance = parseFloat(user.balance) || 0;

            if (client) {
                try {
                    const { data: remoteUser } = await client.from('users').select('*').eq('id', user.id).single();
                    if (remoteUser) {
                        dbUser = remoteUser;
                        effectiveBalance = parseFloat(remoteUser.balance) || 0;

                        // Calculate Effective Balance
                        const [pD, pW, pT] = await Promise.all([
                            client.from('deposits').select('amount').eq('user_id', user.id).eq('status', 'Pending'),
                            client.from('withdrawals').select('amount').eq('user_id', user.id).eq('status', 'Pending'),
                            client.from('trades').select('total_amount').eq('user_id', user.id).eq('status', 'Pending')
                        ]);

                        const lockedDeposits = (pD.data || []).reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
                        const lockedWithdrawals = (pW.data || []).reduce((sum, w) => sum + (parseFloat(w.amount) || 0), 0);
                        const lockedTrades = (pT.data || []).reduce((sum, t) => sum + (parseFloat(t.total_amount) || 0), 0);

                        effectiveBalance = effectiveBalance + lockedDeposits - lockedWithdrawals - lockedTrades;
                        if (effectiveBalance < 0) effectiveBalance = 0;
                    }
                } catch (e) {
                    console.error("Market Sync Error:", e);
                }
            }

            // Update Profile Section (Me View)
            const meDisplayName = document.getElementById('meUserDisplayName');
            const meFullName = document.getElementById('meFullName');
            const meUsername = document.getElementById('meUsername');
            const meAvatar = document.getElementById('meAvatarInitials');
            const meCredit = document.getElementById('meCreditScore');
            const meVip = document.getElementById('meVipLevel');

            const displayName = dbUser.full_name || dbUser.name || dbUser.mobile || 'User';
            if (meDisplayName) meDisplayName.textContent = displayName;
            if (meFullName) meFullName.textContent = dbUser.full_name || dbUser.name || '-';
            if (meUsername) meUsername.textContent = dbUser.username || dbUser.mobile || '-';

            if (meAvatar) {
                const firstChar = displayName.charAt(0).toUpperCase();
                meAvatar.textContent = (isNaN(firstChar) ? firstChar : 'U');
            }
            if (meCredit) meCredit.textContent = dbUser.credit_score || 0;
            if (meVip) meVip.textContent = dbUser.vip || 0;

            // Update KYC Status Badge
            const meKycBadge = document.getElementById('meKycStatusBadge');
            if (meKycBadge) {
                const status = dbUser.kyc || 'Not Verified';
                meKycBadge.textContent = status;
                meKycBadge.className = '';
                if (status === 'Approved') meKycBadge.className = 'kyc-approved';
                else if (status === 'Pending') meKycBadge.className = 'kyc-pending';
                else if (status === 'Rejected') meKycBadge.className = 'kyc-rejected';
                else meKycBadge.className = 'kyc-not-verified';
            }

            const formats = { minimumFractionDigits: 2 };
            // FIX: Use RAW DB Balance everywhere for "Available Balance" display
            // ignoring pending items so user sees exactly what Admin set.
            const rawBalance = parseFloat(dbUser.balance) || 0;

            // Helper to safe-fit text
            const fitText = (el, text) => {
                el.textContent = text;
                el.setAttribute('data-val', text);
                el.title = text; // Tooltip for full precision

                // Reset style
                el.style.fontSize = '';
                el.style.whiteSpace = 'nowrap';
                el.style.overflow = 'hidden';
                el.style.textOverflow = 'ellipsis';
                el.style.display = 'block';

                // Dynamic sizing based on length
                if (text.length > 28) el.style.fontSize = '0.6rem';
                else if (text.length > 22) el.style.fontSize = '0.7rem';
                else if (text.length > 16) el.style.fontSize = '0.8rem';
            };

            const updateVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    const fmt = '' + val.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    fitText(el, fmt);
                }
            };

            updateVal('meAvailableBalance', rawBalance);

            const inv = parseFloat(dbUser.invested) || 0;
            const frozen = parseFloat(dbUser.frozen) || 0;
            const loan = parseFloat(dbUser.loan) || 0;
            const bonus = parseFloat(dbUser.bonus) || 0;

            // RECONCILIATION: Calculate Outstanding from Trades as the Source of Truth
            let outstanding = parseFloat(dbUser.outstanding) || 0;
            if (typeof transactionData !== 'undefined' && transactionData.all && transactionData.all.length > 0) {
                const calculatedOutstanding = transactionData.all
                    .filter(t => t.status === 'Pending' && (t.admin_note || "").startsWith('OUTSTANDING'))
                    .reduce((sum, t) => {
                        const total = parseFloat(t.total_amount);
                        const note = t.admin_note || "";
                        let paid = 0;
                        if (note.startsWith('OUTSTANDING:')) {
                            paid = parseFloat(note.split(':')[1]) || 0;
                        } else {
                            paid = total * 0.85;
                        }
                        return sum + (total - paid);
                    }, 0);

                // Use calculated value for the UI
                outstanding = calculatedOutstanding;

                // Silently sync DB if mismatch detected
                if (Math.abs(calculatedOutstanding - (parseFloat(dbUser.outstanding) || 0)) > 1) {
                    console.log("Auditor (Sync): Correcting database mismatch silently.");
                    window.DB.updateUserFinancials(dbUser.id, dbUser.balance, dbUser.invested, calculatedOutstanding);
                }
            }

            updateVal('meCurrentInvestments', inv);
            updateVal('meFrozenFunds', frozen);
            updateVal('meBorrowedFunds', loan);
            updateVal('meBonusCredits', bonus);
            updateVal('mePendingSettlement', outstanding);

            // Update sidebar assets
            const assetAmounts = document.querySelectorAll('.asset-amount');
            if (assetAmounts.length >= 6) {
                // Map values to the 6 grid items in order:
                // 1. Available (Cash)
                // 2. Invested (Invested)
                // 3. Bonus (Credit)
                // 4. Frozen (Pending)
                // 5. Loan (Funds)
                // 6. Pending (Settle) -> This is actually Outstanding

                const fmtRaw = '' + rawBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const fmtInv = '' + inv.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const fmtBonus = '' + bonus.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const fmtFrozen = '' + frozen.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const fmtLoan = '' + loan.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const fmtOut = '' + outstanding.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                fitText(assetAmounts[0], fmtRaw);
                fitText(assetAmounts[1], fmtInv);
                fitText(assetAmounts[2], fmtBonus);
                fitText(assetAmounts[3], fmtFrozen);
                fitText(assetAmounts[4], fmtLoan);
                fitText(assetAmounts[5], fmtOut);
            }

            // Update Portfolio View Invested Amounts
            const formattedRawBal = '' + rawBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const formattedInv = '' + inv.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Update p-asset-val elements in Portfolio view
            // Use ID targeting for precision
            const updatePortfolioVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    const fmt = '' + val.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    fitText(el, fmt);
                }
            };

            updatePortfolioVal('pAvailableBalance', rawBalance);

            updatePortfolioVal('pCurrentInvested', inv);
            updatePortfolioVal('pPromoCredits', bonus);
            updatePortfolioVal('pPendingFunds', frozen);
            updatePortfolioVal('pBorrowedFunds', loan);
            updatePortfolioVal('pPendingSettlement', outstanding);

            // Legacy Loop for safety (if IDs missing on some copies)
            // But skip elements that have IDs since we handled them above
            document.querySelectorAll('.p-asset-val').forEach(el => {
                if (el.id) return; // Skip if ID exists (handled above)

                const label = el.previousElementSibling?.textContent;
                if (label === 'Available Balance') {
                    el.textContent = formattedRawBal;
                    el.setAttribute('data-val', formattedRawBal);
                } else if (label === 'Current Investments') {
                    el.textContent = formattedInv;
                    el.setAttribute('data-val', formattedInv);
                }
            });

            updateVal('pInvestedMain', inv);

            updateVal('pPortfolioTotal', inv);

            updateVal('pCircleText', inv);

            updateVal('pInsStockVal', inv);

            updateVal('pStatsInvested', inv);
            updateVal('pStatsCurrentValue', inv);

            // --- PORTFOLIO DASHBOARD ENHANCEMENTS ---
            // Calculate Total Profit & ROI for the charts
            let totalProfit = 0;
            let tradesCount = 0;

            if (typeof transactionData !== 'undefined' && transactionData.holding) {
                tradesCount = transactionData.holding.length;
                transactionData.holding.forEach(item => {
                    // Use actual market price if available
                    const liveProd = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(item.symbol) : null;
                    const currentPrice = liveProd ? liveProd.price : parseFloat(item.price);
                    const profit = (currentPrice * item.quantity) - parseFloat(item.total_amount);
                    totalProfit += profit;
                });
            }

            const roiPercent = inv > 0 ? (totalProfit / inv) * 100 : 0;

            // Update Text Elements
            updateVal('pProfitMain', totalProfit);

            const roiEl = document.getElementById('pROIMain');
            if (roiEl) {
                roiEl.textContent = (roiPercent >= 0 ? '+' : '') + roiPercent.toFixed(2) + '%';
                roiEl.style.color = roiPercent >= 0 ? '#10b981' : '#ef4444';
            }

            const tradesCountEl = document.getElementById('pTradesCount');
            if (tradesCountEl) tradesCountEl.textContent = tradesCount;

            updateVal('pTradesProfit', totalProfit);

            // Animate Donut Chart
            // The donut shows profit ratio relative to investment (capped at 100% for visual)
            const donutCircle = document.getElementById('pDonutCircle');
            const donutPctLabel = document.getElementById('pDonutPct');
            if (donutCircle) {
                let profitRatio = Math.min(Math.max(totalProfit / (inv || 1), 0), 1);
                // Ensure a visual sliver if profit exists but is proportionately tiny
                if (totalProfit > 0 && profitRatio < 0.01) profitRatio = 0.01;

                const offset = 251.2 * (1 - profitRatio);
                donutCircle.style.strokeDashoffset = offset;
                if (donutPctLabel) {
                    const displayPct = (totalProfit / (inv || 1) * 100);
                    donutPctLabel.textContent = (displayPct < 0.01 && totalProfit > 0 ? '<0.01' : displayPct.toFixed(displayPct < 1 ? 2 : 0)) + '%';
                }
            }

            // Animate Gauge Needle
            // Map ROI -10% to +10% to the gauge 0-100%
            const gaugeNeedle = document.getElementById('pGaugeNeedle');
            if (gaugeNeedle) {
                // Normalize ROI to a value between 0 and 1
                // -10% (0) | 0% (0.5) | +10% (1.0)
                let normalizedROI = (roiPercent + 10) / 20;
                normalizedROI = Math.min(Math.max(normalizedROI, 0), 1);
                const angle = -90 + (normalizedROI * 180);
                gaugeNeedle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
            }

            // Sync Stats View
            const statsROI = document.getElementById('pStatsROI');
            if (statsROI) {
                statsROI.textContent = (roiPercent >= 0 ? '+' : '') + roiPercent.toFixed(2) + '%';
            }

            // Calculate Top Gainer/Loser
            if (typeof transactionData !== 'undefined' && transactionData.holding && transactionData.holding.length > 0) {
                let gainer = null, loser = null;
                let maxProfitPct = -Infinity, maxLossPct = Infinity;

                transactionData.holding.forEach(item => {
                    const liveProd = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(item.symbol) : null;
                    const currentPrice = liveProd ? liveProd.price : parseFloat(item.price);
                    const profit = (currentPrice * item.quantity) - parseFloat(item.total_amount);
                    const profitPct = (profit / parseFloat(item.total_amount)) * 100;

                    if (profitPct > maxProfitPct) {
                        maxProfitPct = profitPct;
                        gainer = { ...item, currentPrice, profit, profitPct };
                    }
                    if (profitPct < maxLossPct) {
                        maxLossPct = profitPct;
                        loser = { ...item, currentPrice, profit, profitPct };
                    }
                });

                if (gainer) {
                    const gName = document.getElementById('pGainerName');
                    if (gName) gName.textContent = gainer.name;
                    updateVal('pGainerVal', gainer.currentPrice);
                    const gPct = document.getElementById('pGainerPct');
                    if (gPct) gPct.innerHTML = `<i data-lucide="arrow-up" size="12"></i> ${gainer.profitPct.toFixed(2)}%`;
                }

                if (loser) {
                    const lName = document.getElementById('pLoserName');
                    if (lName) lName.textContent = loser.name;
                    updateVal('pLoserVal', loser.currentPrice);
                    const lPct = document.getElementById('pLoserPct');
                    if (lPct) lPct.innerHTML = `<i data-lucide="arrow-down" size="12"></i> ${loser.profitPct.toFixed(2)}%`;
                }
            }

            // Sync Allocation
            updateVal('pAllocInstVal', inv);
            const allocChg = document.getElementById('pAllocInstChg');
            if (allocChg) {
                const liveTotalVal = inv + totalProfit;
                allocChg.innerHTML = `<i data-lucide="${totalProfit >= 0 ? 'arrow-up' : 'arrow-down'}" size="10"></i> ${totalProfit >= 0 ? '+' : '-'}${Math.abs(totalProfit).toLocaleString('en-IN', { minimumFractionDigits: 2 })} (${roiPercent.toFixed(2)}%)`;
                allocChg.style.color = totalProfit >= 0 ? '#10b981' : '#ef4444';
            }
            // ----------------------------------------

            // Update Buy Widget Balance Info
            const fundStatus = document.getElementById('fundStatus');
            if (fundStatus) {
                fundStatus.textContent = `Available: ${formattedRawBal}`;
                fundStatus.style.color = rawBalance > 0 ? '#10b981' : '#ef4444';
            }

            // Update Settings Modal Profile
            const setPhone = document.querySelector('.settings-phone');
            if (setPhone) setPhone.textContent = user.mobile || user.id;

            const setName = document.querySelector('.settings-name');
            if (setName) setName.textContent = user.full_name || user.name || user.mobile || 'User';

            // Update Settings Avatar Initials
            if (setAvatar && !setAvatar.querySelector('img')) {
                const firstChar = (user.full_name || user.name || user.mobile || 'U').charAt(0).toUpperCase();
                setAvatar.textContent = (isNaN(firstChar) ? firstChar : 'U');
            }

            lucide.createIcons();
        }

        // Financial Audit & Self-Healing Logic
        window.auditFinancials = async function (btn) {
            if (btn) {
                const icon = btn.querySelector('i') || btn;
                icon.style.transition = 'transform 0.6s';
                icon.style.transform = 'rotate(360deg)';
                setTimeout(() => icon.style.transform = 'none', 600);
            }

            try {
                const user = await window.DB.refreshCurrentUser();
                if (!user) return;

                // 1. Fetch latest transactions
                if (typeof fetchUserTransactions === 'function') await fetchUserTransactions();

                // 2. Calculate Actual Outstanding from Trades
                const trades = (typeof transactionData !== 'undefined' && transactionData.all) ? transactionData.all : [];
                const actualOutstanding = trades
                    .filter(t => t.status === 'Pending' && (t.admin_note || "").startsWith('OUTSTANDING'))
                    .reduce((sum, t) => {
                        const total = parseFloat(t.total_amount);
                        const note = t.admin_note || "";
                        let paid = 0;
                        if (note.startsWith('OUTSTANDING:')) {
                            paid = parseFloat(note.split(':')[1]) || 0;
                        } else {
                            paid = total * 0.85;
                        }
                        return sum + (total - paid);
                    }, 0);

                const dbOutstanding = parseFloat(user.outstanding) || 0;

                // 3. If mismatch > 1, patch the DB
                if (Math.abs(actualOutstanding - dbOutstanding) > 1) {
                    await window.DB.updateUserFinancials(user.id, user.balance, user.invested, actualOutstanding);
                    await syncUserData();
                    showModal('success', 'Records Synchronized', 'Your financial data was cross-referenced with your transaction history and successfully reconciled.');
                } else {
                    await syncUserData();
                    showModal('success', 'Data Verified', 'Your financial records are consistent and accurate.');
                }
            } catch (e) {
                console.error("Audit Error:", e);
                showModal('error', 'Audit Failed', 'Unable to verify records at this time.');
            }
        };

        // Initial Render
        syncUserData();
        // Fetch fresh data from backend (e.g. approved deposits)
        DB.refreshCurrentUser().then(fullUser => {
            if (fullUser) syncUserData();
        });
        switchExchange('gainers', 'NSE');
        switchExchange('losers', 'NSE');
        renderFundRecords('all');

        // Handle URL 'view' parameter for navigation from Home
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            if (view === 'discover') showDiscoverView();
            else if (view === 'portfolio') showPortfolioView();
            else if (view === 'me') showMeView();
            else showMarketView();
        });

        // Customer Service Logic handled by script.js

        /* Holding & Selling Modal Controls */
        function openHoldingDetail(tradeId) {
            const queuedNotice = document.getElementById('hdQueuedNotice');
            const outstandingNotice = document.getElementById('hdOutstandingNotice');
            const settleBtn = document.getElementById('settleBtnContainer');
            const saleValueRow = document.getElementById('hdSaleValueRow');
            const timelineTitle = document.getElementById('hdTimelineTitle');

            if (queuedNotice) queuedNotice.style.display = 'none';
            if (outstandingNotice) outstandingNotice.style.display = 'none';
            if (settleBtn) settleBtn.style.display = 'none';

            if (tradeId.startsWith('LISTING:')) {
                const symbol = tradeId.split(':')[1];
                let listing = (window.MarketEngine ? window.MarketEngine.getIPO().find(x => x.symbol === symbol) : null);

                // Fallback for search by name if symbol exact match fails
                if (!listing && window.MarketEngine) {
                    listing = window.MarketEngine.getIPO().find(x => symbol.includes(x.symbol) || x.symbol.includes(symbol));
                }

                if (!listing) listing = { symbol, name: symbol, price: 0, yield: 'TBD' };

                document.getElementById('hdStockTitle').innerText = listing.name || symbol;

                // Handle Logo for Listing
                const hdLogoWrap = document.getElementById('hdLogoWrap');
                if (hdLogoWrap) {
                    hdLogoWrap.innerHTML = '';
                }

                document.getElementById('hdTotalVal').innerText = '0.00';
                document.getElementById('hdTradeId').innerText = 'Listing Information';
                document.getElementById('hdAssetName').innerText = listing.name || symbol;
                document.getElementById('hdAssetType').innerText = 'IPO Information';
                document.getElementById('hdSymbol').innerText = symbol;
                document.getElementById('hdQty').innerText = '-';
                document.getElementById('hdBuyPrice').innerText = '' + parseFloat(listing.price || 0).toLocaleString('en-IN', { minimumFractionDigits: 2 });
                document.getElementById('hdOrderVal').innerText = '-';

                document.getElementById('hdCurrPrice').innerText = '-';
                document.getElementById('hdProfit').innerText = '-';

                document.getElementById('hdPremiumHeader').style.display = 'block';
                document.getElementById('hdPremiumTitle').innerText = (listing.name || symbol) + ' (QIB)';
                document.getElementById('hdPremiumYield').innerText = listing.yield || 'TBD';
                document.getElementById('hdEstProfit').innerText = listing.yield || 'TBD';

                document.getElementById('hdNormalTradeTitle').innerText = (listing.name || symbol) + ' Listing Info';
                document.getElementById('hdAssetLabel').innerText = 'Subscription Price';
                document.getElementById('hdAssetName').innerText = '' + parseFloat(listing.price || 0).toLocaleString('en-IN');

                document.getElementById('hdAllocPriceRow').style.display = 'table-row';
                document.getElementById('hdAllocPrice').innerText = '' + parseFloat(listing.price || 0).toLocaleString('en-IN');

                document.getElementById('hdSubDateRow').style.display = 'table-row';
                document.getElementById('hdSubDate').innerText = listing.subDate || 'Open Now';

                document.getElementById('hdDeadlineRow').style.display = 'table-row';
                document.getElementById('hdDeadline').innerText = listing.deadline || 'Final Call';

                document.getElementById('hdAllocDateRow').style.display = 'table-row';
                document.getElementById('hdAllocDate').innerText = listing.allocDate || 'Pending';

                document.getElementById('hdListingDateRow').style.display = 'table-row';
                document.getElementById('hdListingDate').innerText = listing.listingDate || 'TBD';

                document.getElementById('hdEstProfitRow').style.display = 'table-row';

                document.getElementById('hdNormalTypeRow').style.display = 'none';
                document.getElementById('hdNormalQtyRow').style.display = 'none';
                document.getElementById('hdNormalBuyPriceRow').style.display = 'none';
                document.getElementById('hdNormalOrderValRow').style.display = 'none';
                document.getElementById('hdNormalCurrPriceRow').style.display = 'none';
                document.getElementById('hdNormalProfitRow').style.display = 'none';
                document.getElementById('hdTimelineTitle').style.display = 'none';
                document.getElementById('hdBuyTimeline').style.display = 'none';

                document.getElementById('holdingDetailModal').style.display = 'flex';
                lucide.createIcons();
                return;
            }

            const trade = transactionData.all.find(t => t.id == tradeId);
            if (!trade) {
                console.error("Trade not found:", tradeId);
                return;
            }

            const me = window.MarketEngine || {};
            const livePriceData = me.getProduct ? me.getProduct(trade.symbol) : null;
            const currentPrice = livePriceData ? livePriceData.price : trade.price;

            document.getElementById('hdStockTitle').innerText = trade.name;

            // Handle Logo for Trade
            const hdLogoWrap = document.getElementById('hdLogoWrap');
            if (hdLogoWrap) {
                hdLogoWrap.innerHTML = '';
            }

            document.getElementById('hdTotalVal').innerText = '' + parseFloat(trade.total_amount).toLocaleString('en-IN', { minimumFractionDigits: 2 });
            document.getElementById('hdTradeId').innerText = trade.id;
            document.getElementById('hdAssetName').innerText = trade.name;
            document.getElementById('hdAssetType').innerText = trade.type === 'stock' ? 'Standard Stock' : trade.type.toUpperCase();
            document.getElementById('hdSymbol').innerText = trade.symbol;
            document.getElementById('hdQty').innerText = trade.quantity;
            document.getElementById('hdBuyPrice').innerText = '' + parseFloat(trade.price).toLocaleString('en-IN', { minimumFractionDigits: 2 });
            document.getElementById('hdOrderVal').innerText = '' + parseFloat(trade.total_amount).toLocaleString('en-IN', { minimumFractionDigits: 2 });

            const mockCurrPrice = currentPrice;
            const mockSaleVal = mockCurrPrice * trade.quantity;
            const profitValue = mockSaleVal - parseFloat(trade.total_amount);
            const profitPct = (profitValue / parseFloat(trade.total_amount)) * 100;

            const dateStr = new Date(trade.created_at).toLocaleString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Pending vs Approved vs Outstanding Logic
            const note = trade.admin_note || "";
            const isOutstanding = trade.status === 'Pending' && (note === 'OUTSTANDING_BALANCE' || note.startsWith('OUTSTANDING:'));
            const isPending = trade.status === 'Pending' && !isOutstanding;

            if (isPending) {
                document.getElementById('hdCurrPrice').innerText = '-';
                document.getElementById('hdProfit').innerText = '-';
                document.getElementById('hdProfit').style.color = '#94a3b8';
                document.getElementById('hdCurrPrice').style.color = '#f8fafc';
                if (queuedNotice) queuedNotice.style.display = 'block';
                if (saleValueRow) saleValueRow.style.display = 'none';

                if (trade.type === 'ipo') {
                    if (timelineTitle) timelineTitle.innerText = 'Subscribe';
                    document.getElementById('hdBuyTimeline').innerText = `Subscribe @ ${dateStr.replace(/\//g, '-')}`;
                    // Additional "Black Arrow" UI for IPO Pending
                    const listingInfo = note.includes('LISTING:') ? note.split('LISTING:')[1].split(';')[0] : 'TBD';
                    const estProfit = note.includes('PROFIT:') ? note.split('PROFIT:')[1].split(';')[0] : 'TBD';
                    document.getElementById('hdBuyTimeline').innerHTML += `<br><span style="margin-top:0.5rem; display:block;">Listing Date (est): ${listingInfo}</span><span style="display:block;">Estimated Profit: ${estProfit}</span>`;
                } else {
                    if (timelineTitle) timelineTitle.innerText = 'Pending Approval';
                    document.getElementById('hdBuyTimeline').innerText = `Order Placed @ ${dateStr.replace(/\//g, '-')}`;
                }
            } else {
                document.getElementById('hdCurrPrice').innerText = '' + mockCurrPrice.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                document.getElementById('hdProfit').innerText = `${profitValue.toLocaleString('en-IN', { minimumFractionDigits: 2 })} (${profitValue >= 0 ? '+' : ''}${profitPct.toFixed(2)}%)`;
                document.getElementById('hdProfit').style.color = profitValue >= 0 ? '#10b981' : '#ef4444';
                document.getElementById('hdCurrPrice').style.color = profitValue >= 0 ? '#10b981' : '#ef4444';

                if (isOutstanding) {
                    if (outstandingNotice) {
                        const total = parseFloat(trade.total_amount);
                        let paid = 0;
                        if (note.startsWith('OUTSTANDING:')) {
                            paid = parseFloat(note.split(':')[1]) || 0;
                        } else {
                            // Mocking for old data
                            paid = total * 0.85;
                        }

                        const outstanding = total - paid;
                        document.getElementById('hdPaidAmt').innerText = '' + paid.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                        document.getElementById('hdOutstandingAmt').innerText = '-' + outstanding.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                        outstandingNotice.style.display = 'block';
                        if (settleBtn) {
                            settleBtn.style.display = 'block';
                            settleBtn.innerHTML = `<button onclick="settleOutstanding('${trade.id}', this)" style="width: 100%; background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); color: black; border: none; padding: 0.85rem; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 0.95rem; margin-top: 0.5rem; transition: all 0.3s; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);">Settle Now</button>`;
                        }
                    }
                    if (saleValueRow) saleValueRow.style.display = 'none';
                } else {
                    if (saleValueRow) {
                        saleValueRow.style.display = 'table-row';
                        document.getElementById('hdTotalSaleVal').innerText = '' + mockSaleVal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    }
                }

                if (trade.type === 'ipo') {
                    if (timelineTitle) timelineTitle.innerText = 'Listing Time';
                    document.getElementById('hdBuyTimeline').innerText = `Listed @ ${dateStr.replace(/\//g, '-')}  Price ${mockCurrPrice.toLocaleString('en-IN')}`;
                } else {
                    if (timelineTitle) timelineTitle.innerText = 'Buy Time';
                    document.getElementById('hdBuyTimeline').innerText = `${dateStr.replace(/\//g, '-')}  Buy @ ${parseFloat(trade.price).toLocaleString('en-IN', { minimumFractionDigits: 2 })}  Total ${parseFloat(trade.total_amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                }
            }

            // --- IPO Milestone Data (Blue Arrow Section) ---
            const isIPO = trade.type === 'ipo';
            document.getElementById('hdPremiumHeader').style.display = isIPO ? 'block' : 'none';
            document.getElementById('hdNormalTradeTitle').innerText = isIPO ? (trade.name + ' Allocation Price:') : 'Trading Infomation';
            document.getElementById('hdAssetLabel').innerText = isIPO ? 'Allocation Price' : 'Asset Name';

            // Show/Hide IPO rows
            ['hdAllocPrice', 'hdSubDate', 'hdDeadline', 'hdAllocDate', 'hdListingDate', 'hdEstProfit'].forEach(id => {
                const row = document.getElementById(id + 'Row');
                if (row) row.style.display = isIPO ? 'table-row' : 'none';
            });
            document.getElementById('hdNormalTypeRow').style.display = isIPO ? 'none' : 'table-row';

            if (isIPO) {
                // Try to find original listing data for accurate dates/yields
                const listing = (window.MarketEngine ? window.MarketEngine.getIPO().find(x => x.symbol === trade.symbol) : null);
                const parseNote = (key) => note.includes(key + ':') ? note.split(key + ':')[1].split(';')[0] : null;

                document.getElementById('hdPremiumTitle').innerText = trade.name + ' (QIB)';
                const yieldVal = parseNote('PROFIT') || (listing ? listing.yield : '300%');
                document.getElementById('hdPremiumYield').innerText = yieldVal;
                document.getElementById('hdEstProfit').innerText = yieldVal;

                document.getElementById('hdAssetName').innerText = '' + parseFloat(trade.price).toLocaleString('en-IN');
                document.getElementById('hdAllocPrice').innerText = '' + parseFloat(trade.price).toLocaleString('en-IN');
                document.getElementById('hdSubDate').innerText = parseNote('SUB_DATE') || (listing ? listing.subDate : dateStr.split(' ')[0]);
                document.getElementById('hdDeadline').innerText = parseNote('DEADLINE') || (listing ? listing.deadline : 'TBD');
                document.getElementById('hdAllocDate').innerText = parseNote('ALLOC_DATE') || (listing ? listing.allocDate : 'Pending');
                document.getElementById('hdListingDate').innerText = parseNote('LISTING') || (listing ? listing.listingDate : 'TBD');

                // Redesign labels to match Blue Arrow section
                document.getElementById('hdAssetName').innerText = '' + parseFloat(trade.price).toLocaleString('en-IN');
            }

            // Set Market based on symbol if possible, else default BSE
            document.getElementById('hdMarket').innerText = trade.symbol.includes('NSE') ? 'NSE' : 'BSE';

            document.getElementById('holdingDetailModal').style.display = 'flex';
            lucide.createIcons();

            // Live Update for Modal
            if (window.hdLiveInterval) clearInterval(window.hdLiveInterval);
            if (!isPending && !isOutstanding && !isIPO) {
                window.hdLiveInterval = setInterval(() => {
                    if (document.getElementById('holdingDetailModal').style.display === 'none') {
                        clearInterval(window.hdLiveInterval);
                        return;
                    }
                    const lp = (window.MarketEngine && window.MarketEngine.getProduct) ? window.MarketEngine.getProduct(trade.symbol) : null;
                    if (!lp) return;
                    const cp = lp.price;
                    const sv = cp * trade.quantity;
                    const pv = sv - parseFloat(trade.total_amount);
                    const pp = (pv / parseFloat(trade.total_amount)) * 100;

                    const cpEl = document.getElementById('hdCurrPrice');
                    const pEl = document.getElementById('hdProfit');
                    const svEl = document.getElementById('hdTotalSaleVal');

                    if (cpEl) {
                        cpEl.innerText = '' + cp.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                        cpEl.style.color = pv >= 0 ? '#10b981' : '#ef4444';
                    }
                    if (pEl) {
                        pEl.innerText = `${pv.toLocaleString('en-IN', { minimumFractionDigits: 2 })} (${pv >= 0 ? '+' : ''}${pp.toFixed(2)}%)`;
                        pEl.style.color = pv >= 0 ? '#10b981' : '#ef4444';
                    }
                    if (svEl) {
                        svEl.innerText = '' + sv.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    }
                }, 1000);
            }
        }

        function openIpoListingDetail(symbol) {
            openHoldingDetail('LISTING:' + symbol);
        }

        async function settleOutstanding(tradeId, btnEl) {
            const trade = transactionData.all.find(t => t.id == tradeId);
            if (!trade) return;

            const user = window.DB ? await window.DB.refreshCurrentUser() : null;
            if (!user) return;

            const total = parseFloat(trade.total_amount);
            const note = trade.admin_note || "";
            let paid = 0;
            if (note.startsWith('OUTSTANDING:')) {
                paid = parseFloat(note.split(':')[1]) || 0;
            } else {
                paid = total * 0.85;
            }

            const outstanding = total - paid;
            const currentBalance = parseFloat(user.balance || 0);

            if (currentBalance < outstanding) {
                alert(`Insufficient balance to settle this order. You need ${outstanding.toLocaleString('en-IN', { minimumFractionDigits: 2 })} more. Please deposit funds first.`);
                return;
            }

            if (!confirm(`Are you sure you want to settle the outstanding balance of ${outstanding.toLocaleString('en-IN', { minimumFractionDigits: 2 })} for ${trade.name}?`)) {
                return;
            }

            const btn = btnEl || event.target;
            const originalText = btn.innerText;
            btn.innerText = "Settling...";
            btn.disabled = true;

            try {
                const newBalance = currentBalance - outstanding;
                const currentInvested = parseFloat(user.invested) || 0;
                const newInvested = currentInvested + outstanding;

                // 1. Update User Financials (Decrement by the settled amount)
                const currentOutstanding = parseFloat(user.outstanding) || 0;
                const newOutstanding = Math.max(0, currentOutstanding - outstanding);
                const finResult = await window.DB.updateUserFinancials(user.id, newBalance, newInvested, newOutstanding);

                if (finResult.success) {
                    // 2. Update Trade Status (Set to Pending for Admin Approval)
                    const tradeResult = await window.DB.updateTradeStatus(trade.id, 'Pending', 'Subscribed Fully');

                    if (tradeResult.success) {
                        alert("Successfully settled! Your subscription is now fully paid and has been moved to Pending transactions for admin approval.");
                        document.getElementById('holdingDetailModal').style.display = 'none';
                        await fetchUserTransactions();
                        // Switch to Pending tab
                        const pendingTab = document.querySelector('.d-tab-pill[onclick*="pending"]');
                        switchTransactionTab(pendingTab, 'pending');
                    } else {
                        alert("Balance deducted but failed to update trade status. Please contact support.");
                    }
                } else {
                    alert("Failed to update financials: " + (finResult.error?.message || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                alert("An error occurred: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function closeHoldingDetail() {
            document.getElementById('holdingDetailModal').style.display = 'none';
        }
    </script>
    <script src="js/trading.js"></script>



    <div class="floating-csr" onclick="openCS()" id="floatingCSR" style="display: flex;">
        <div class="csr-badge" id="csrMsgBadge" style="display: none;"></div>
        <i data-lucide="headset"></i>
        <span>Support</span>
    </div>

    <!-- Modals -->
    <div id="topAlertContainer" class="top-alert-container">
        <div class="top-alert">
            <i data-lucide="alert-circle"></i>
            <span>Please sign in to continue.</span>
            <i data-lucide="x" class="close-alert" onclick="closeAlert()"></i>
        </div>
    </div>

    <div id="messageCenterOverlay" class="message-center-overlay" onclick="toggleMessageCenter()"></div>
    <div id="messageCenter" class="message-center-modal">
        <div class="mc-header">
            <div class="mc-title-row">
                <span class="mc-title">Notifications</span>
                <span class="mc-subtitle" id="msgCount">10 Messages</span>
            </div>
            <button class="mc-close" onclick="toggleMessageCenter()"><i data-lucide="x" size="24"></i></button>
        </div>
        <div class="mc-actions">
            <button class="mc-btn" onclick="makeAllRead()">Make all read</button>
            <button class="mc-btn delete-all" onclick="deleteAllMessages()">Delete all</button>
        </div>
        <div class="mc-list" id="mcList">
            <div class="mc-item">
                <div class="mc-dot unread"></div>
                <div class="mc-content">
                    <div class="mc-msg-title">IPO Announcement  Armour Security IPOQIB</div>
                    <div class="mc-time">14-01-2026 15:10:23</div>
                    <div class="mc-tag">IPO:NEW</div>
                    <button class="mc-delete-item" onclick="deleteMessage(this)">Delete</button>
                </div>
            </div>
            <div class="mc-item">
                <div class="mc-dot unread"></div>
                <div class="mc-content">
                    <div class="mc-msg-title">Important Notice</div>
                    <div class="mc-time">12-01-2026 09:32:02</div>
                    <div class="mc-tag">TEXT</div>
                    <button class="mc-delete-item" onclick="deleteMessage(this)">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal" onclick="if(event.target == this) closeSettings()">
        <div class="settings-content">
            <button class="settings-close" onclick="closeSettings()"><i data-lucide="x" size="24"></i></button>
            <div class="settings-header">
                <div class="avatar-circle">U</div>
                <div class="settings-name"
                    style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-top: 0.5rem;">User Name</div>
                <div class="settings-phone" style="font-size: 0.9rem; color: #64748b; margin-top: 0.2rem;">+91</div>
                <div class="badge-row">
                    <div class="s-badge vip"><i data-lucide="shield-check" size="18"></i> VIP: 0</div>
                    <div class="s-badge credit"><i data-lucide="crown" size="18"></i> Credit Score: 100</div>
                </div>
            </div>
            <div class="settings-list">
                <div class="settings-item" onclick="toggleUserProfile()">
                    <div class="settings-item-icon"><i data-lucide="user" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">User Profile</div>
                        <div class="settings-item-desc">Update your profile information.</div>
                    </div>
                    <i data-lucide="chevron-down" id="userProfileChevron" class="settings-chevron" size="18"
                        style="transition: transform 0.2s;"></i>
                </div>
                <div id="userProfileSubmenu" class="settings-submenu">
                    <div class="submenu-item" onclick="openEditNameModal()">
                        <i data-lucide="edit-3" size="18"></i> Update Name
                    </div>
                    <div class="submenu-item" onclick="openAvatarModal()">
                        <i data-lucide="image" size="18"></i> Update Avatar
                    </div>
                    <div class="submenu-item" onclick="openKYCModal()">
                        <i data-lucide="file-check" size="18"></i> View KYC
                    </div>
                </div>
                <div class="settings-item" onclick="toggleSecurityMenu()">
                    <div class="settings-item-icon"><i data-lucide="lock" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Security</div>
                        <div class="settings-item-desc">Update your system security settings.</div>
                    </div>
                    <i data-lucide="chevron-down" id="securityChevron" class="settings-chevron" size="18"
                        style="transition: transform 0.2s;"></i>
                </div>
                <div id="securitySubmenu" class="settings-submenu">
                    <div class="submenu-item" onclick="openWithdrawalPinModal()">
                        <i data-lucide="shield-check" size="18"></i> Withdrawal PIN
                    </div>
                    <div class="submenu-item" onclick="openResetPassword()">
                        <i data-lucide="key" size="18"></i> Change Login Password
                    </div>
                </div>
                <div class="settings-item" onclick="window.location.href='bank_accounts.html'">
                    <div class="settings-item-icon"><i data-lucide="landmark" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Bank Accounts</div>
                        <div class="settings-item-desc">Manage bank accounts and info</div>
                    </div>
                    <i data-lucide="chevron-right" class="settings-chevron" size="18"></i>
                </div>
                <div class="settings-item" onclick="openCS()">
                    <div class="settings-item-icon"><i data-lucide="headset" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Customer Service</div>
                        <div class="settings-item-desc">Contact customer service</div>
                    </div>
                    <i data-lucide="chevron-right" class="settings-chevron" size="18"></i>
                </div>
            </div>
            <div class="logout-btn-container">
                <button class="logout-btn" onclick="DB.logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Holding Details Modal -->
    <div id="holdingDetailModal" class="center-popup-modal" onclick="if(event.target == this) closeHoldingDetail()">
        <div class="center-popup-content" style="max-width: 500px; padding: 0;">
            <div class="popup-header" style="background: #111; border-bottom: 1px solid #262626; padding: 1.5rem;">
                <h3 id="hdStockTitle" style="font-weight: 700; color: #f8fafc; font-size: 1.25rem;">Stock Name</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="popup-close" style="background:none; border:none; color:#d4af37; cursor: pointer;"><i
                            data-lucide="share-2" size="20"></i></button>
                    <button class="popup-close" onclick="closeHoldingDetail()"
                        style="background:none; border:none; color:#d4af37; cursor: pointer;"><i data-lucide="x"
                            size="24"></i></button>
                </div>
            </div>
            <div class="popup-body" style="padding: 1.5rem; max-height: 85vh; overflow-y: auto; background: #111;">
                <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                    <div id="hdLogoWrap"></div>
                </div>
                <div class="detail-total-label"
                    style="text-align: center; color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.25rem;">Total Value
                </div>
                <div class="detail-total-val" id="hdTotalVal"
                    style="text-align: center; font-size: 2.25rem; font-weight: 800; color: #f8fafc; margin-bottom: 0.75rem;">
                    0.00</div>
                <div style="text-align: center; margin-bottom: 2rem;">
                    <span
                        style="font-size: 0.8rem; color: #94a3b8; background: #1a1a1a; padding: 6px 14px; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid #262626;"
                        onclick="navigator.clipboard.writeText(document.getElementById('hdTradeId').innerText); alert('ID Copied!');">
                        <i data-lucide="copy" size="14"></i> <span id="hdTradeId">dca300...</span>
                    </span>
                </div>

                <!-- Premium IPO Header (Green Arrow Section) -->
                <div id="hdPremiumHeader" style="display: none; text-align: center; margin-bottom: 2rem;">
                    <div style="font-weight: 700; color: #f8fafc; font-size: 1.15rem; margin-bottom: 0.5rem;"
                        id="hdPremiumTitle">ICICI India IPO (QIB)</div>
                    <div style="font-size: 2.5rem; font-weight: 800; color: #10b981; margin-bottom: 0.25rem;"
                        id="hdPremiumYield">300%</div>
                    <div style="font-size: 0.85rem; color: #94a3b8; font-weight: 600;">Estimated Profit</div>
                </div>

                <div style="font-weight: 700; color: #f8fafc; margin-bottom: 1rem; font-size: 1.05rem;"
                    id="hdNormalTradeTitle">Trading Infomation</div>
                <table class="detail-info-table" style="width: 100%; border-collapse: collapse;">
                    <style>
                        .detail-info-table tr td {
                            padding: 0.85rem 0;
                            border-bottom: 1px solid #262626;
                            font-size: 0.95rem;
                        }

                        .detail-info-table tr td:first-child {
                            color: #94a3b8;
                            font-weight: 500;
                        }

                        .detail-info-table tr td:last-child {
                            text-align: right;
                            font-weight: 600;
                            color: #f8fafc;
                        }
                    </style>
                    <tr>
                        <td id="hdAssetLabel">Asset Name</td>
                        <td id="hdAssetName">-</td>
                    </tr>
                    <tr id="hdAllocPriceRow" style="display: none;">
                        <td>Allocation Price</td>
                        <td id="hdAllocPrice">0.00</td>
                    </tr>
                    <tr id="hdSubDateRow" style="display: none;">
                        <td>Subscription Date</td>
                        <td id="hdSubDate">-</td>
                    </tr>
                    <tr id="hdDeadlineRow" style="display: none;">
                        <td>Subscription Deadline</td>
                        <td id="hdDeadline">-</td>
                    </tr>
                    <tr id="hdAllocDateRow" style="display: none;">
                        <td>Allocation Date</td>
                        <td id="hdAllocDate">-</td>
                    </tr>
                    <tr id="hdListingDateRow" style="display: none;">
                        <td>Listing Date</td>
                        <td id="hdListingDate">-</td>
                    </tr>
                    <tr id="hdEstProfitRow" style="display: none;">
                        <td>Estimated Profit</td>
                        <td id="hdEstProfit" style="color: #10b981 !important;">300%</td>
                    </tr>
                    <tr id="hdNormalTypeRow">
                        <td>Asset Type</td>
                        <td id="hdAssetType" style="color: #d4af37 !important;">Standard</td>
                    </tr>
                    <tr>
                        <td>Country</td>
                        <td id="hdCountry">IN</td>
                    </tr>
                    <tr>
                        <td>Market</td>
                        <td id="hdMarket">BSE</td>
                    </tr>
                    <tr>
                        <td>Symbol</td>
                        <td id="hdSymbol">-</td>
                    </tr>
                    <tr id="hdNormalQtyRow">
                        <td>Quantity</td>
                        <td id="hdQty">0</td>
                    </tr>
                    <tr id="hdNormalBuyPriceRow">
                        <td>Buy Price</td>
                        <td id="hdBuyPrice" style="color: #d4af37 !important;">0.00</td>
                    </tr>
                    <tr id="hdNormalOrderValRow">
                        <td>Total Order Value</td>
                        <td id="hdOrderVal">0.00</td>
                    </tr>
                    <tr id="hdSaleValueRow" style="display: none;">
                        <td>Total Sale Value</td>
                        <td id="hdTotalSaleVal">0.00</td>
                    </tr>
                    <tr id="hdNormalCurrPriceRow">
                        <td>Current Price</td>
                        <td id="hdCurrPrice" style="color: #10b981 !important;">0.00</td>
                    </tr>
                    <tr id="hdNormalProfitRow">
                        <td>Profit</td>
                        <td id="hdProfit" style="color: #10b981 !important;">0.00 (0.00%)</td>
                    </tr>
                </table>

                <div id="hdOutstandingNotice"
                    style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 1.25rem; margin: 1.5rem 0; color: #ef4444; font-size: 0.9rem; line-height: 1.6;">
                    <div
                        style="font-weight: 800; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        Outstanding Balance Detected
                    </div>
                    <div style="font-size: 0.85rem; margin-bottom: 1rem;">
                        You have an unpaid order. <br>
                        You have paid <span id="hdPaidAmt" style="color:#d4af37; font-weight:700;">0.00</span> already
                        and the outstanding balance is <span id="hdOutstandingAmt"
                            style="color:#ef4444; font-weight:700;">-0.00</span>. Please settle immediately to avoid
                        impacts.
                    </div>
                    <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.8rem; color: #94a3b8;">
                        <li>Suspension of future trading activity</li>
                        <li>Reduced Trust Score</li>
                        <li>Delays in execution/settlement</li>
                    </ul>
                    <div id="settleBtnContainer" style="display: none; margin-top: 1rem;"></div>
                </div>

                <div id="hdQueuedNotice"
                    style="display: none; background: rgba(212, 175, 55, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; padding: 1rem; margin: 1.5rem 0; color: #d4af37; font-size: 0.9rem; line-height: 1.5;">
                    Your order is queued and awaiting allocation/authorization.
                </div>

                <!-- Expandable Sections -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 0; border-bottom: 1px solid #262626; cursor: pointer;">
                    <span style="font-weight: 700; color: #f8fafc;">Fees</span>
                    <i data-lucide="chevron-right" size="20" color="#d4af37"></i>
                </div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 0; border-bottom: 1px solid #262626; cursor: pointer;">
                    <span style="font-weight: 700; color: #f8fafc;">Fund Txn.</span>
                    <i data-lucide="chevron-right" size="20" color="#d4af37"></i>
                </div>

                <div style="margin-top: 2rem;">
                    <div id="hdTimelineTitle"
                        style="font-weight: 700; color: #d4af37; margin-bottom: 1.25rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                        Timeline
                    </div>
                    <div class="timeline-item" style="display: flex; gap: 1.25rem; position: relative;">
                        <div class="timeline-dot"
                            style="width: 12px; height: 12px; border-radius: 50%; background: #d4af37; margin-top: 4px; z-index: 1;">
                        </div>
                        <div class="timeline-content">
                            <h4 style="font-size: 1rem; font-weight: 700; color: #f8fafc; margin-bottom: 0.25rem;">Buy
                                Time</h4>
                            <p id="hdBuyTimeline" style="font-size: 0.85rem; color: #94a3b8; line-height: 1.4;">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Premium Order Confirmation Modal -->
    <div id="orderConfirmModal" class="center-popup-modal" onclick="if(event.target == this) closeOrderConfirm()">
        <div class="center-popup-content"
            style="max-width: 480px; padding: 0; overflow: hidden; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div style="background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); padding: 1.5rem; color: #000;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div id="ocTypeLabel"
                            style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; font-weight: 700; margin-bottom: 0.25rem;">
                            PRO ORDER CONFIRMATION</div>
                        <h2 id="ocAssetName"
                            style="font-weight: 800; font-size: 1.5rem; margin: 0; line-height: 1.2; color: #000;">
                            Stock Name</h2>
                        <div id="ocAssetSymbol"
                            style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; font-weight: 500;">SYMBOL 
                            EXCHANGE</div>
                    </div>
                    <button class="popup-close" onclick="closeOrderConfirm()"
                        style="background: rgba(0,0,0,0.1); border: none; color: #000; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center;"><i
                            data-lucide="x" size="20"></i></button>
                </div>
            </div>

            <div class="popup-body" style="padding: 1.5rem; background: #111;">
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <div
                        style="flex: 1; background: #1a1a1a; padding: 1rem; border-radius: 12px; border: 1px solid #333;">
                        <div
                            style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; margin-bottom: 0.25rem; text-transform: uppercase;">
                            Quantity</div>
                        <div id="ocQuantity" style="font-size: 1.25rem; font-weight: 800; color: #d4af37;">0</div>
                    </div>
                    <div
                        style="flex: 1; background: #1a1a1a; padding: 1rem; border-radius: 12px; border: 1px solid #333;">
                        <div
                            style="font-size: 0.7rem; color: #94a3b8; font-weight: 700; margin-bottom: 0.25rem; text-transform: uppercase;">
                            Price/Share</div>
                        <div id="ocPrice" style="font-size: 1.25rem; font-weight: 800; color: #d4af37;">0.00</div>
                    </div>
                </div>

                <div
                    style="border-radius: 16px; background: #161616; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #262626;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.9rem; font-weight: 500;">Base Amount</span>
                        <span id="ocBaseAmount"
                            style="font-weight: 600; color: #f8fafc; font-size: 0.95rem;">0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.85rem;">Tax (0.12%)</span>
                        <span id="ocTax" style="font-weight: 600; color: #ef4444; font-size: 0.85rem;">+0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span style="color: #94a3b8; font-size: 0.85rem;">Txn Charge (0.03%)</span>
                        <span id="ocTxn" style="font-weight: 600; color: #ef4444; font-size: 0.85rem;">+0.00</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px dashed #333;">
                        <span style="color: #d4af37; font-weight: 800; font-size: 1rem;">EST. TOTAL</span>
                        <span id="ocTotal" style="font-weight: 900; color: #d4af37; font-size: 1.4rem;">0.00</span>
                    </div>
                </div>

                <div
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 10px; margin-bottom: 2rem;">
                    <i data-lucide="shield-check" size="18" color="#d4af37"></i>
                    <span style="font-size: 0.75rem; color: #d4af37; line-height: 1.4; font-weight: 500;">By confirming,
                        you agree to execute the order at the current market value. Real-time volatility may affect the
                        final price.</span>
                </div>

                <button id="ocConfirmBtn"
                    style="width: 100%; padding: 1.25rem; background: #d4af37; color: black; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);"
                    onmouseover="this.style.background='#aa8c2c'; this.style.transform='translateY(-2px)';"
                    onmouseout="this.style.background='#d4af37'; this.style.transform='translateY(0)';">CONFIRM
                    BUY ORDER</button>

                <p style="text-align: center; margin-top: 1rem; font-size: 0.75rem; color: #94a3b8; font-weight: 500;">
                    Fast execution  Secured by Avendus Enterprise</p>
            </div>
        </div>
    </div>

    <!-- Confirm Purchase Modal (For OTC/IPO) -->
    <div id="purchaseConfirmModal" class="center-popup-modal" onclick="if(event.target == this) closePurchaseModal()">
        <div class="center-popup-content"
            style="max-width: 480px; padding: 0; overflow: hidden; border: none; border-radius: 20px;">
            <div style="background: #d4af37; padding: 1.5rem; color: black;">
                <h2 style="font-weight: 800; margin: 0; font-size: 1.25rem; color: black;">Subscription Confirmation
                </h2>
                <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 4px; color: black;">Review your institutional
                    allocation
                    request</div>
            </div>
            <div class="popup-body" style="padding: 1.5rem; background: #111;">
                <div
                    style="background: #1a1a1a; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.9rem;">Product</span>
                        <span id="cpName" style="font-weight: 700; color: #f8fafc;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.9rem;">Symbol</span>
                        <span id="cpSymbol" style="font-weight: 700; color: #f8fafc;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span style="color: #94a3b8; font-size: 0.9rem;">Quantity Requested</span>
                        <span id="cpQty" style="font-weight: 700; color: #f8fafc;">0</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px dashed #333;">
                        <span style="color: #d4af37; font-weight: 800;">TOTAL PAYABLE</span>
                        <span id="cpTotal" style="font-weight: 900; color: #d4af37; font-size: 1.25rem;">0.00</span>
                    </div>
                </div>

                <div
                    style="margin-bottom: 1.5rem; text-align: center; color: #94a3b8; font-size: 0.85rem; line-height: 1.5; padding: 0 1rem;">
                    Your subscription request will be sent to our desk for review. Once verified, units will be credited
                    to your portfolio.
                </div>

                <button class="logout-btn"
                    style="background: #d4af37; width: 100%; border-radius: 12px; height: 56px; font-weight: 800; border:none; color:black; cursor:pointer; font-size: 1rem; transition: all 0.2s;"
                    onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='none'"
                    id="cpSubmitBtn" onclick="confirmPurchaseSubscription()">SEND SUBSCRIPTION REQUEST</button>
            </div>
        </div>
    </div>

    <!-- Close Order Modal -->
    <div id="closeOrderModal" class="center-popup-modal" onclick="if(event.target == this) closeSellingModal()">
        <div class="center-popup-content"
            style="max-width: 480px; padding: 0; overflow: hidden; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border-radius: 20px;">
            <div style="background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); padding: 1.5rem; color: #000;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div
                            style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; font-weight: 700; margin-bottom: 0.25rem; color: #000;">
                            PRO SELL ORDER</div>
                        <h2 id="coStockTitle"
                            style="font-weight: 800; font-size: 1.5rem; margin: 0; line-height: 1.2; color: #000;">
                            Stock Name</h2>
                        <div id="coSymbolLabel"
                            style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; font-weight: 500; color: #000;">
                            SYMBOL 
                            SELL QUOTATION</div>
                    </div>
                    <button class="popup-close" onclick="closeSellingModal()"
                        style="background: rgba(0,0,0,0.1); border: none; color: #000; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center;"><i
                            data-lucide="x" size="20"></i></button>
                </div>
            </div>

            <div class="popup-body" style="padding: 1.5rem; background: #111;">
                <div
                    style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 1.25rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                    <div>
                        <span
                            style="display: block; font-size: 0.75rem; color: #ef4444; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">Live
                            Market Exit</span>
                        <span id="coCurrPrice" style="font-weight: 800; color: #ef4444; font-size: 1.5rem;">0.00</span>
                    </div>
                    <button id="coRefreshBtn"
                        style="background: #1a1a1a; border: 1px solid #d4af37; padding: 8px 16px; border-radius: 8px; color: #d4af37; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;"
                        onmouseover="this.style.background='rgba(212, 175, 55, 0.1)'"
                        onmouseout="this.style.background='#1a1a1a'"><i data-lucide="refresh-cw" size="14"></i>
                        Refresh</button>
                </div>

                <div
                    style="background: #1a1a1a; border-radius: 16px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.85rem; font-weight: 500;">Exit Quantity</span>
                        <span id="coQty" style="font-weight: 700; color: #f8fafc; font-size: 0.9rem;">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                        <span style="color: #94a3b8; font-size: 0.85rem; font-weight: 500;">Market Value</span>
                        <span id="coOrderVal" style="font-weight: 700; color: #f8fafc; font-size: 0.9rem;">0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #94a3b8; font-size: 0.8rem;">Selling Tax (0.12%)</span>
                        <span id="coTaxAmt" style="font-weight: 600; color: #ef4444; font-size: 0.8rem;">-0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span style="color: #94a3b8; font-size: 0.8rem;">Exit Charge (0.03%)</span>
                        <span id="coTxnCharge"
                            style="font-weight: 600; color: #ef4444; font-size: 0.8rem;">-0.00</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 1px dashed #333;">
                        <span style="color: #d4af37; font-weight: 800; font-size: 1rem;">NET PROCEEDS</span>
                        <span id="coNetReturn" style="font-weight: 900; color: #d4af37; font-size: 1.4rem;">0.00</span>
                    </div>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <span id="coTimerText" style="font-size: 0.8rem; color: #94a3b8; font-weight: 600;">Quotation
                        expires in 20s</span>
                    <span id="coSymbol" style="font-size: 0.8rem; color: #94a3b8; font-weight: 700;">-</span>
                </div>

                <div class="quotation-timer"
                    style="height: 6px; background: #262626; border-radius: 3px; overflow: hidden; margin-bottom: 2rem;">
                    <div class="quotation-progress" id="coProgressBar"
                        style="height: 100%; background: #d4af37; width: 100%; transition: width 1s linear;"></div>
                </div>

                <button class="logout-btn"
                    style="background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); width: 100%; border-radius: 12px; height: 56px; font-weight: 800; font-size: 1.1rem; border: none; color: black; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);"
                    onmouseover="this.style.background='#aa8c2c'; this.style.transform='translateY(-2px)';"
                    onmouseout="this.style.background='#d4af37'; this.style.transform='translateY(0)';"
                    id="coConfirmBtn" onclick="executeCloseOrder()">CLOSE POSITION</button>

                <p style="text-align: center; margin-top: 1rem; font-size: 0.7rem; color: #94a3b8; line-height: 1.4;">
                    Settlement will be immediate. Proceeds will be credited to your wallet after statutory deductions.
                </p>
            </div>
        </div>
    </div>

    <!-- Customer Service Modal -->

    <div id="csModal" class="settings-modal" onclick="if(event.target == this) closeCS()">
        <div class="settings-content" style="max-width: 500px; height: 600px; display: flex; flex-direction: column;">
            <button class="settings-close" onclick="closeCS()"><i data-lucide="x" size="24"></i></button>
            <div class="settings-header" style="margin-bottom: 1rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700;">Customer Service</h2>
            </div>
            <div id="chatBox"
                style="flex: 1; overflow-y: auto; padding: 1rem; background: #f8fafc; border-radius: 12px; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="file" id="csImageInput" accept="image/*" style="display: none;"
                    onchange="handleCSImageUpload(this)">
                <button onclick="document.getElementById('csImageInput').click()"
                    style="background: none; border: none; cursor: pointer; color: #64748b; padding: 0.5rem;">
                    <i data-lucide="image" size="20"></i>
                </button>
                <button onclick="toggleEmojiPicker()"
                    style="background: none; border: none; cursor: pointer; color: #64748b; padding: 0.5rem; position: relative;">
                    <i data-lucide="smile" size="20"></i>
                    <div id="emojiPicker"
                        style="display: none; position: absolute; bottom: 40px; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); width: 150px;">
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                        <span onclick="insertEmoji('')" style="cursor: pointer; font-size: 1.2rem;"></span>
                    </div>
                </button>
                <input type="text" id="csInput" placeholder="Type a message..."
                    style="flex: 1; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                <button onclick="sendCSMessage()"
                    style="background: #3b82f6; color: white; border: none; padding: 0 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Send</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal (Logged-In) -->
    <div id="resetPasswordModal" class="center-popup-modal" onclick="if(event.target == this) closeResetPassword()">
        <div class="center-popup-content" style="max-width: 450px;">
            <div class="popup-header">
                <h2>Reset Password</h2>
                <button class="popup-close" onclick="closeResetPassword()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body">
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Current
                        Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="currentPass" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('currentPass', this)"></i>
                    </div>
                </div>
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                        Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="newPassInternal" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('newPassInternal', this)"></i>
                    </div>
                </div>
                <div class="reg-input-group" style="margin-bottom: 2rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Confirm
                        New Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="confirmPassInternal" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('confirmPassInternal', this)"></i>
                    </div>
                </div>
                <button class="logout-btn" style="background: #3b82f6;" onclick="handleInternalReset()">Update
                    Password</button>
                <button class="logout-btn" style="background: #f1f5f9; color: #64748b; margin-top: 1rem;"
                    onclick="closeResetPassword()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal PIN Modal -->
    <div id="withdrawalPinModal" class="center-popup-modal"
        onclick="if(event.target == this) closeWithdrawalPinModal()">
        <div class="center-popup-content" style="max-width: 450px;">
            <div class="popup-header">
                <h2 id="wpModalTitle">Withdrawal PIN</h2>
                <button class="popup-close" onclick="closeWithdrawalPinModal()"><i data-lucide="x"
                        size="24"></i></button>
            </div>
            <div class="popup-body">
                <p id="wpModalDesc" style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">Set or update
                    your 4-6 digit withdrawal PIN.</p>
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                        Withdrawal PIN (4-6 digits)</label>
                    <input type="password" id="wpNewPin" class="reg-input" maxlength="6" pattern="\d*"
                        inputmode="numeric" placeholder="Enter New PIN"
                        style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                </div>
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Confirm
                        New PIN</label>
                    <input type="password" id="wpConfirmPin" class="reg-input" maxlength="6" pattern="\d*"
                        inputmode="numeric" placeholder="Confirm New PIN"
                        style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                </div>
                <div class="reg-input-group" style="margin-bottom: 2rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Verify
                        Login Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="wpLoginPass" class="reg-input" placeholder="Enter Login Password"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('wpLoginPass', this)"></i>
                    </div>
                </div>
                <button id="wpSubmitBtn" class="logout-btn" style="background: #fb923c;"
                    onclick="handleWithdrawalPinSubmit()">Update
                    Withdrawal PIN</button>
                <button class="logout-btn" style="background: #f1f5f9; color: #64748b; margin-top: 1rem;"
                    onclick="closeWithdrawalPinModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatarModal" class="center-popup-modal">
        <div class="center-popup-content avatar-form" style="max-width: 400px;">
            <div class="popup-header"
                style="width:100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.25rem; font-weight: 700;">Update Avatar</h2>
                <button class="popup-close" onclick="closeAvatarModal()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body" style="display:flex; flex-direction:column; align-items:center; width: 100%;">
                <div class="avatar-preview-lg" id="avatarPreviewContainer"
                    onclick="document.getElementById('avatarInput').click()">
                    <i data-lucide="user" size="64" style="color:#cbd5e1;" id="avatarPlaceholderIcon"></i>
                    <img id="avatarPreviewImg" src="" style="display:none;">
                    <div class="avatar-change-overlay">Change Image</div>
                </div>
                <input type="file" id="avatarInput" hidden onchange="previewAvatar(this)" accept="image/*">
                <div style="width: 100%; margin-top: 2rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn-primary" onclick="uploadAvatar()">Save Changes</button>
                    <button class="btn-secondary" onclick="closeAvatarModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KYC Modal -->
    <div id="kycModal" class="center-popup-modal">
        <div class="center-popup-content">
            <div class="popup-header">
                <h2>View KYC</h2>
                <button class="popup-close" onclick="closeKYCModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="popup-body">
                <div class="kyc-form-grid">
                    <div class="kyc-field-label">Full Name</div>
                    <input type="text" id="kycName" class="kyc-field-input" placeholder="Enter Full Name">
                    <div class="kyc-field-label">Mobile Number</div>
                    <input type="text" id="kycMobile" class="kyc-field-input" readonly style="background: #f8fafc;">
                    <div class="kyc-field-label">ID Number</div>
                    <input type="text" id="kycIdNum" class="kyc-field-input" placeholder="Enter ID Number">
                    <div class="kyc-field-label">Submitted On</div>
                    <input type="text" id="kycSubmitted" class="kyc-field-input" readonly style="background: #f8fafc;">
                    <div class="kyc-field-label">Approval Status</div>
                    <input type="text" id="kycApproved" class="kyc-field-input" readonly style="background: #f8fafc;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <div class="kyc-upload-box" onclick="document.getElementById('kycFrontInput').click()">
                        <div class="plus-icon">+ Front</div>
                        <img id="kycFrontPreview" style="display:none; width:100%; height:100%; object-fit:cover;">
                        <input type="file" id="kycFrontInput" hidden
                            onchange="previewKYCImage(this, 'kycFrontPreview')">
                    </div>
                    <div class="kyc-upload-box" onclick="document.getElementById('kycBackInput').click()">
                        <div class="plus-icon">+ Back</div>
                        <img id="kycBackPreview" style="display:none; width:100%; height:100%; object-fit:cover;">
                        <input type="file" id="kycBackInput" hidden onchange="previewKYCImage(this, 'kycBackPreview')">
                    </div>
                </div>
                <button class="btn-submit" onclick="submitKYC()" style="margin-top: 1.5rem; width: 100%;">Submit
                    Verification</button>
            </div>
        </div>
    </div>
    <!-- Message Center Modal -->
    <div id="messageCenterOverlay" onclick="toggleMessageCenter()"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2999;">
    </div>
    <div id="messageCenter" class="cs-content"
        style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%) scale(0.9); opacity:0; transition: all 0.3s; z-index:3000; display:none; flex-direction:column; background:white; width:400px; height:600px; border-radius:16px;">
        <div class="cs-header"
            style="background:#1e56a0; color:white; padding:1.25rem; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700; display:flex; gap:10px; align-items:center;"><i data-lucide="bell"
                    size="20"></i> Notifications</div>
            <button onclick="toggleMessageCenter()"
                style="background:transparent; border:none; color:white; cursor:pointer;"><i data-lucide="x"
                    size="20"></i></button>
        </div>
        <div class="cs-body" id="mcList"
            style="flex:1; overflow-y:auto; padding:1.5rem; display:flex; flex-direction:column; gap:1rem;">
            <!-- Messages go here -->
        </div>
        <div style="padding:1rem; border-top:1px solid #eee; display:flex; justify-content:space-between;"
            id="mcFooter">
            <button onclick="makeAllRead()"
                style="background:#f1f5f9; border:none; padding:8px 16px; border-radius:6px; font-size:0.8rem; cursor:pointer; color:#64748b;">Mark
                all read</button>
            <button onclick="deleteAllMessages()"
                style="background:#fee2e2; border:none; padding:8px 16px; border-radius:6px; font-size:0.8rem; cursor:pointer; color:#ef4444;">Delete
                all</button>
        </div>
    </div>

    <!-- Notification Bell Floating Button -->
    <div class="cs-floating-tab" onclick="toggleMessageCenter()"
        style="bottom: 7rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; padding:0; justify-content:center; background: #fff; border: 1px solid #e2e8f0; color: #64748b; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000;">
        <div
            style="position:relative; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
            <i data-lucide="bell" size="24" color="#1e56a0"></i>
            <div id="msgBadge"
                style="position:absolute; top:12px; right:12px; background:#ef4444; color:white; width:10px; height:10px; border-radius:50%; display:none; border:2px solid white;">
            </div>
        </div>
    </div>

    <!-- Edit Name Modal -->
    <div id="editNameModal" class="center-popup-modal">
        <div class="center-popup-content" style="max-width: 400px;">
            <div class="popup-header">
                <h2>Update Name</h2>
                <button class="popup-close" onclick="closeEditNameModal()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body">
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                        Name</label>
                    <input type="text" id="editNameInput" class="reg-input" placeholder="Enter your name"
                        style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="logout-btn" id="saveNameBtn" style="background: #3b82f6;" onclick="saveName()">Save
                        Name</button>
                    <button class="logout-btn" style="background: #f1f5f9; color: #64748b;"
                        onclick="closeEditNameModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Notification Modal -->
    <div id="globalModal" class="center-popup-modal" onclick="if(event.target == this) closeGlobalModal()"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
        <div class="center-popup-content"
            style="max-width: 400px; padding: 2.5rem 2rem; text-align: center; border-radius: 24px; border: 1px solid #333; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); background: #111;">
            <div id="modalIconContainer"
                style="width: 80px; height: 80px; background: rgba(212, 175, 55, 0.1); color: #d4af37; border-radius: 50%; display: grid; place-items: center; margin: 0 auto 1.5rem;">
                <i id="modalIcon" data-lucide="check-circle" size="48"></i>
            </div>
            <h2 id="modalTitle" style="font-weight: 800; font-size: 1.5rem; color: #f8fafc; margin-bottom: 0.5rem;">
                Success</h2>
            <p id="modalMsg" style="color: #94a3b8; font-size: 0.95rem; line-height: 1.6; margin-bottom: 2rem;">Your
                transaction has been processed successfully.</p>
            <button id="modalBtn" onclick="closeGlobalModal()"
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%); color: #000; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='none'">
                CONTINUE
            </button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        (function () {
            // --- Helper: Get Index Data by TradingView Symbol ---
            function getIndexByTvSymbol(tvSymbol) {
                const indices = window.MarketEngine ? window.MarketEngine.getIndices() : [];
                // Mapping reverse logic or simple search
                if (tvSymbol === 'BSE:SENSEX') return indices.find(i => i.symbol === 'SENSEX');
                if (tvSymbol === 'NSE:NIFTY') return indices.find(i => i.symbol === 'NIFTY 50');
                if (tvSymbol === 'NSE:BANKNIFTY') return indices.find(i => i.symbol === 'NIFTY BANK');

                return indices.find(i => tvSymbol.includes(i.symbol.replace(/\s/g, '')));
            }

            // --- Override updateChart to handle dynamic cards ---
            window.updateChart = function (symbol, title) {
                // Update Global Var
                window.currentActiveSymbol = symbol;

                // Active Class Logic
                document.querySelectorAll('.index-card').forEach(c => c.classList.remove('active'));
                const activeCard = document.querySelector(`.index-card[data-tv-symbol="${symbol}"]`);
                if (activeCard) activeCard.classList.add('active');

                // Load Widget
                if (window.loadWidget) window.loadWidget(symbol);

                // Trigger immediate UI update
                if (window.syncUI) window.syncUI();
            };

            // --- Override syncUI to use Real-Time Engine Data for Indices ---
            window.syncUI = function () {
                // 1. Update Hero Section based on Current Symbol
                const idx = getIndexByTvSymbol(window.currentActiveSymbol);
                if (idx) {
                    // Update Header
                    const priceEl = document.getElementById('indexPrice');
                    const symEl = document.getElementById('valSymbol');
                    const txtEl = document.getElementById('valSymbolText');
                    const chgEl = document.getElementById('heroChange');

                    if (priceEl) priceEl.innerText = idx.price.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    if (symEl) symEl.innerText = idx.symbol;
                    if (txtEl) txtEl.innerText = idx.symbol;

                    if (chgEl) {
                        const isUp = idx.change >= 0;
                        const colorClass = isUp ? 'green' : 'red'; // CSS classes
                        const bg = isUp ? '#eefcf4' : '#fff1f1';
                        const col = isUp ? '#10b981' : '#ef4444';
                        chgEl.className = `index-chg ${colorClass}`;
                        chgEl.style.background = bg;
                        chgEl.style.color = col;
                        chgEl.innerText = `${isUp ? '+' : ''}${idx.change.toFixed(2)} (${isUp ? '+' : ''}${idx.changePercent.toFixed(2)}%)`;
                    }

                    // Update Range Bar (Simulated based on current price +- volatility for demo)
                    const staticD = window.indexData ? window.indexData[window.currentActiveSymbol] : null;
                    if (staticD) {
                        const range = staticD.high - staticD.low;
                        const pos = idx.price - staticD.low;
                        const pctPos = Math.max(0, Math.min(100, (pos / range) * 100));

                        const slider = document.getElementById('sliderMarker');
                        const progress = document.getElementById('rangeProgress');
                        if (slider) slider.style.left = `${pctPos}%`;
                        if (progress) progress.style.width = `${pctPos}%`;
                    }
                }
            };

            // --- Carousel Logic (Updated for Wrapper) ---
            const slider = document.getElementById('indicesScrollContainer');
            let isDown = false;
            let startX;
            let scrollLeft;

            if (slider) {
                slider.addEventListener('mousedown', (e) => {
                    isDown = true;
                    slider.style.cursor = 'grabbing';
                    startX = e.pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                });
                slider.addEventListener('mouseleave', () => {
                    isDown = false;
                    slider.style.cursor = 'grab';
                });
                slider.addEventListener('mouseup', () => {
                    isDown = false;
                    slider.style.cursor = 'grab';
                });
                slider.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                });

                // Touch events for mobile swipe
                slider.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                });
                slider.addEventListener('touchmove', (e) => {
                    const x = e.touches[0].pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                });
            }

            // Dynamic Rendering Loop
            function renderMajorIndices() {
                if (!window.MarketEngine || !document.getElementById('majorIndicesList')) return;

                const indices = window.MarketEngine.getIndices();
                const container = document.getElementById('majorIndicesList');

                // Build Layout if empty
                if (container.children.length === 0 && indices.length > 0) {
                    indices.forEach((idx, i) => {
                        const div = document.createElement('div');
                        div.className = `index-card`;
                        // Ensure consistent width styling inline
                        div.style.minWidth = "260px";
                        div.style.flex = "0 0 auto";
                        div.style.cursor = "pointer";

                        // ID for updates
                        div.id = `idx-card-dyn-${i}`;

                        // Map symbol logic
                        let tvSymbol = idx.symbol;
                        if (idx.symbol === 'SENSEX') tvSymbol = 'BSE:SENSEX';
                        else if (idx.symbol === 'NIFTY 50') tvSymbol = 'NSE:NIFTY';
                        else if (idx.symbol === 'NIFTY BANK') tvSymbol = 'NSE:BANKNIFTY';
                        else if (idx.symbol === 'VIX') tvSymbol = 'NSE:INDIAVIX';
                        else tvSymbol = 'NSE:' + idx.symbol.replace(/\s+/g, '');

                        div.setAttribute('data-tv-symbol', tvSymbol);

                        div.onclick = function () {
                            if (window.updateChart) window.updateChart(tvSymbol, idx.name);
                        };

                        div.innerHTML = `
                            <div class="index-card-left">
                                <div class="index-head">
                                    <img src="https://flagcdn.com/w20/in.png" class="index-flag">
                                    <span class="index-name">${idx.symbol}</span>
                                </div>
                                <div class="index-val" id="idx-val-${i}" style="font-weight:700; font-size:1.1rem; margin:0.25rem 0;">--</div>
                                <div class="index-chg" id="idx-chg-${i}" style="font-weight:600; font-size:0.85rem;">--</div>
                            </div>
                            <div class="sparkline-container">
                                <svg class="sparkline-svg" viewBox="0 0 100 40" style="width:100px; height:40px;">
                                    <path class="sparkline-path" id="idx-spark-${i}"
                                        d="M0 20 C 20 10, 40 30, 60 15 S 100 25, 100 20" fill="none" stroke-width="2"></path>
                                </svg>
                            </div>
                        `;
                        container.appendChild(div);
                    });

                    // Set initial active state
                    const initialActive = document.querySelector(`.index-card[data-tv-symbol="${window.currentActiveSymbol}"]`);
                    if (initialActive) initialActive.classList.add('active');
                }

                // Update Values Loop
                indices.forEach((idx, i) => {
                    const valParams = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
                    const priceEl = document.getElementById(`idx-val-${i}`);
                    const chgEl = document.getElementById(`idx-chg-${i}`);
                    const sparkEl = document.getElementById(`idx-spark-${i}`);

                    if (priceEl) priceEl.innerText = idx.price.toLocaleString('en-IN', valParams);

                    if (chgEl) {
                        const isUp = idx.change >= 0;
                        const colorClass = isUp ? '#10b981' : '#ef4444';
                        const colorClassName = isUp ? 'green' : 'red';

                        chgEl.className = `index-chg ${colorClassName}`;
                        chgEl.innerText = `${isUp ? '+' : ''}${idx.change.toFixed(2)} (${isUp ? '+' : ''}${idx.changePercent.toFixed(2)}%)`;

                        if (sparkEl) sparkEl.setAttribute('stroke', colorClass);
                    }
                });

                // Trigger Hero Update via syncUI (which we overrode)
                if (window.syncUI) window.syncUI();
            }

            // Start Cycle
            setInterval(renderMajorIndices, 1000);
            setTimeout(renderMajorIndices, 500);
        })();
    </script>
    <style>
        /* Scoped styles for the new wrapper */
        #indicesScrollContainer::-webkit-scrollbar {
            display: none;
        }

        /* Ensure Black & Gold theme styling persists */
        #majorIndicesList .index-card {
            background: #111;
            border: 1px solid #2a2a2a;
        }

        #majorIndicesList .index-card:hover {
            border-color: #d4af37;
        }

        #majorIndicesList .index-name {
            color: #ccc;
        }

        #majorIndicesList .index-val {
            color: #fff;
        }
    </style>
    <script src="js/trading.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof showDiscoverView === 'function') {
                showDiscoverView();
            }
        });
    </script>
</body>

</html>
<style>
    .mini-tf-btn {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 700;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mini-tf-btn.active {
        background: #1e56a0;
        color: white;
        border-color: #1e56a0;
    }

    .range-dot,
    #rangeProgress {
        transition: all 0.5s ease;
    }
</style>

<style>
    /* CRITICAL FIX: Global Horizontal Scroll Prevention */
    html,
    body {
        overflow-x: hidden !important;
        width: 100% !important;
        max-width: 100vw !important;
        position: relative;
    }

    /* Prevent parent containers from expanding */
    .market-content,
    .market-wrapper,
    #mainDashboard {
        max-width: 100vw !important;
        width: 100% !important;
        overflow-x: hidden !important;
        box-sizing: border-box;
    }

    /* Fix Grid Item expansion (Common issue with carousels) */
    .center-col {
        min-width: 0 !important;
        width: 100% !important;
        /* Ensure it doesn't leak */
        overflow-x: clip !important;
    }

    /* Scoped Carousel styles */
    #indicesScrollContainer {
        width: 100% !important;
        max-width: 100% !important;
        /* Horizontal scroll only inside here */
        overflow-x: auto !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch;
        display: block;
        padding-bottom: 5px;
    }

    /* Clean Scrollbar */
    #indicesScrollContainer::-webkit-scrollbar {
        display: none;
        height: 0;
        width: 0;
    }

    /* Inner List expands freely horizontally */
    #majorIndicesList {
        width: max-content !important;
        display: flex !important;
        margin: 0 !important;
        padding: 0 !important;
    }
</style>

<style>
    /* =========================================
       MARKET PAGE BLACK & GOLD THEME OVERRIDES
       ========================================= */

    /* 1. Page Background & Main Layout */
    body,
    html {
        background-color: #0b0b0b !important;
        color: #e2e8f0 !important;
    }

    .market-wrapper,
    .market-content,
    #mainDashboard {
        background-color: #0b0b0b !important;
        color: #e2e8f0 !important;
    }

    /* 2. Card Containers (Replace White with Dark) */
    .m-card,
    .h-card,
    .main-index-view,
    .styled-chart-box,
    .premium-trade-card {
        background-color: #111111 !important;
        border: 1px solid #2a2a2a !important;
        color: #ffffff !important;
        box-shadow: none !important;
    }

    /* Remove white shadows/glows */
    .m-card,
    .h-card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3) !important;
    }

    /* 3. Typography & Headings */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    .section-title,
    .premium-asset-name,
    .index-val,
    .asset-val,
    .stock-ticker,
    .h-stock-info h3,
    .h-stat-val,
    .detail-total-val,
    .news-item h4 {
        color: #f8fafc !important;
    }

    .section-title.indices {
        color: #ffffff !important;
    }

    .text-muted,
    .asset-label,
    .asset-sub,
    .stock-full-name,
    .h-stock-meta,
    .h-stat-label,
    .news-item p,
    .news-meta,
    .premium-return-label,
    .detail-total-label,
    .detail-info-table tr td:first-child {
        color: #94a3b8 !important;
    }

    /* 4. Interactive Elements & Accents */
    /* Icons */
    i[data-lucide],
    svg {
        color: #d4af37 !important;
        /* Gold icons */
    }

    /* Specific overrides for status colors to keep them functional (Green/Red) */
    .asset-val.green,
    .index-chg.green,
    .sector-pct.up,
    .h-stat-val.green,
    .h-status-badge {
        color: #10b981 !important;
        /* Keep Green */
    }

    .asset-val.red,
    .index-chg.red,
    .sector-pct.down,
    .h-stat-val.red {
        color: #ef4444 !important;
        /* Keep Red */
    }

    /* Buttons */
    .tf-btn {
        background: #1a1a1a !important;
        color: #94a3b8 !important;
        border: 1px solid #333 !important;
    }

    .tf-btn:hover {
        border-color: #d4af37 !important;
        color: #d4af37 !important;
    }

    .tf-btn.active {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
        color: #000 !important;
        border-color: #d4af37 !important;
        font-weight: 800 !important;
    }

    .mini-tf-btn {
        background: #1a1a1a !important;
        color: #94a3b8 !important;
        border: 1px solid #333 !important;
    }

    .mini-tf-btn.active {
        background: #d4af37 !important;
        color: #000 !important;
        border-color: #d4af37 !important;
    }

    /* 5. Specific Component Overrides */
    /* Asset Cards */
    .asset-mini-card {
        background: #161616 !important;
        border: 1px solid #262626 !important;
    }

    /* Sector Cards */
    .sector-card {
        background: #161616 !important;
        border: 1px solid #262626 !important;
    }

    .sector-card:hover {
        border-color: #d4af37 !important;
        background: #1a1a1a !important;
    }

    .sector-name {
        color: #e2e8f0 !important;
    }

    /* Index Cards (Carousel) */
    .index-card {
        background: #161616 !important;
        border: 1px solid #262626 !important;
    }

    .index-card.active {
        border-color: #d4af37 !important;
        background: #1c1c1c !important;
    }

    .index-name {
        color: #d4af37 !important;
    }

    /* Gold Index Names */

    /* Stock List / Watchlist */
    .stock-row,
    .news-item {
        border-bottom: 1px solid #262626 !important;
    }

    .stock-circle {
        background: #262626 !important;
        color: #d4af37 !important;
        border: 1px solid #333 !important;
    }

    /* Range Slider */
    .day-range-container {
        border-top: 1px solid #262626 !important;
    }

    .slider-marker {
        background: #000 !important;
        border-color: #d4af37 !important;
    }

    /* Detail Modal / Locked Sections */
    .auth-lock-overlay {
        background: rgba(0, 0, 0, 0.7) !important;
        backdrop-filter: blur(4px);
    }

    .auth-lock-btn {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
        color: #000 !important;
        font-weight: 800 !important;
    }

    /* Chart Container specific */
    .chart-container-realtime {
        border: 1px solid #333 !important;
    }

    /* Table borders */
    .detail-info-table tr td {
        border-bottom: 1px solid #262626 !important;
    }

    /* =========================================
       ADDITIONAL REFINEMENTS (Blue to Gold / Light to Dark)
       ========================================= */

    /* Exchange Tabs (NSE/BSE) */
    .exchange-tab {
        background: #1a1a1a !important;
        color: #94a3b8 !important;
        border: 1px solid #333 !important;
    }

    .exchange-tab.active {
        background: #d4af37 !important;
        color: #000 !important;
        border-color: #d4af37 !important;
        font-weight: 700 !important;
    }

    /* IPO Status Badges */
    .ipo-item {
        border-bottom: 1px solid #262626 !important;
        color: #e2e8f0 !important;
    }

    .ipo-item>div:first-child>div:last-child {
        color: #94a3b8 !important;
        /* Date color */
    }

    /* Specific Badge Overrides to muted gold/dark theme style */
    .ipo-item div[style*="background: #eff6ff"] {
        /* Upcoming (Blue) -> Gold/Dark */
        background: #2a2a2a !important;
        color: #f59e0b !important;
        border: 1px solid #f59e0b !important;
    }

    .ipo-item div[style*="background: #f0fdf4"] {
        /* Open (Green) -> Keep Green but Darker Bg */
        background: #052e16 !important;
        color: #4ade80 !important;
        border: 1px solid #059669 !important;
    }

    .ipo-item div[style*="background: #fef3c7"] {
        /* Soon (Yellow) -> Darker Yellow */
        background: #2a2a2a !important;
        color: #fbbf24 !important;
        border: 1px solid #b45309 !important;
    }

    /* Side List Titles (Star, Trending Icons etc) */
    .side-list-title i {
        color: #d4af37 !important;
    }

    /* Specific overrides for Up/Down trend icons to keep Green/Red logic if preferred, 
       but user asked for Gold theme. Let's keep Green/Red for directional logic as it's functional,
       but background of tabs is handled above. */

    /* Search Bar in Header (if visible) */
    .search-bar {
        background: #111 !important;
        border: 1px solid #333 !important;
    }

    .search-input {
        color: #fff !important;
    }

    .search-input::placeholder {
        color: #64748b !important;
    }

    /* Watchlist "No Data" Text */
    .auth-locked-content {
        color: #94a3b8 !important;
    }

    /* Buy Widget Inputs (Stock Detail) */
    .input-group .q-input {
        background: #111 !important;
        border: 1px solid #333 !important;
        color: #fff !important;
    }

    .input-group .max-btn {
        background: #262626 !important;
        color: #d4af37 !important;
        border: 1px solid #333 !important;
    }

    .input-group .max-btn:hover {
        border-color: #d4af37 !important;
    }

    /* Trading Info Table in Detail View */
    .trading-info-table tr td {
        border-bottom: 1px solid #262626 !important;
        color: #94a3b8 !important;
    }

    .trading-info-table tr td.val {
        color: #f8fafc !important;
    }

    .trading-info-table tr td.val.total {
        color: #d4af37 !important;
    }

    /* Buy/Sell Buttons */
    button.buy-btn {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
        color: #000 !important;
        font-weight: 800 !important;
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2) !important;
    }

    button.buy-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3) !important;
    }

    /* Sell button stays red but premium */
    button#sellBtn {
        background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2) !important;
    }

    /* Range Slider Track */
    input[type=range] {
        accent-color: #d4af37 !important;
    }

    /* Footer */
    .footer-market {
        border-top: 1px solid #262626 !important;
        color: #64748b !important;
    }

    /* =========================================
       DISCOVER PAGE BLACK & GOLD THEME OVERRIDES
       ========================================= */

    /* Main Discover View Container */
    #discoverView {
        background-color: #0b0b0b !important;
        color: #e2e8f0 !important;
    }

    /* Sidebar */
    .discover-sidebar {
        background-color: #111111 !important;
        border-right: 1px solid #262626 !important;
    }

    .discover-nav-item {
        color: #94a3b8 !important;
        border-left: 3px solid transparent !important;
    }

    .discover-nav-item:hover {
        background-color: #1a1a1a !important;
        color: #e2e8f0 !important;
    }

    .discover-nav-item.active {
        background-color: #1a1a1a !important;
        color: #d4af37 !important;
        border-left-color: #d4af37 !important;
        font-weight: 700 !important;
    }

    .discover-nav-item.active i {
        color: #d4af37 !important;
    }

    /* Main Content Area */
    .discover-main {
        background-color: #0b0b0b !important;
    }

    /* Cards */
    .discover-card {
        background-color: #111111 !important;
        border: 1px solid #262626 !important;
        box-shadow: none !important;
        color: #e2e8f0 !important;
    }

    /* Header & Titles */
    .discover-head {
        border-bottom: 1px solid #262626 !important;
    }

    .discover-head div[style*="color: #3b82f6"] {
        color: #e2e8f0 !important;
        /* Title Text */
    }

    .discover-head i[data-lucide] {
        color: #d4af37 !important;
        /* Gold Icons in Header */
    }

    /* Action Circles (Refresh/Search) */
    .refresh-circle,
    .search-circle {
        background-color: #1a1a1a !important;
        border: 1px solid #333 !important;
        color: #d4af37 !important;
    }

    .refresh-circle:hover,
    .search-circle:hover {
        background-color: #262626 !important;
        border-color: #d4af37 !important;
    }

    /* Tabs (Box Style) */
    .discover-tabs {
        border-bottom: 1px solid #262626 !important;
    }

    .d-tab {
        color: #94a3b8 !important;
        border-bottom: 2px solid transparent !important;
    }

    .d-tab:hover {
        color: #e2e8f0 !important;
    }

    .d-tab.active {
        color: #d4af37 !important;
        border-bottom-color: #d4af37 !important;
    }

    .d-tab.active i {
        color: #d4af37 !important;
    }

    /* Tabs (Pill Style - Transactions) */
    .d-tab-pill {
        background-color: #1a1a1a !important;
        color: #94a3b8 !important;
        border: 1px solid #333 !important;
    }

    .d-tab-pill:hover {
        border-color: #64748b !important;
        color: #e2e8f0 !important;
    }

    .d-tab-pill.active {
        background-color: #d4af37 !important;
        color: #000 !important;
        border-color: #d4af37 !important;
        font-weight: 700 !important;
    }

    /* Transaction List Items */
    .trans-item {
        background-color: #111111 !important;
        border-bottom: 1px solid #262626 !important;
    }

    .trans-item:hover {
        background-color: #161616 !important;
    }

    .trans-icon-box {
        background-color: #1a1a1a !important;
        color: #d4af37 !important;
    }

    .t-name {
        color: #f8fafc !important;
    }

    .t-date {
        color: #64748b !important;
    }

    .t-amount {
        color: #f8fafc !important;
    }

    /* Trade List Items */
    .trade-item {
        background-color: #111111 !important;
        border-bottom: 1px solid #262626 !important;
    }

    .trade-info h4 {
        color: #f8fafc !important;
    }

    .trade-info p {
        color: #94a3b8 !important;
    }

    /* Buttons in lists */
    .btn-trade-action {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
        color: #000 !important;
    }

    .h-head h3 {
        color: #f8fafc !important;
    }

    .h-stock-meta {
        color: #94a3b8 !important;
    }

    .h-stat-label {
        color: #64748b !important;
    }

    .h-stat-val {
        color: #f8fafc !important;
    }

    .h-stat-val.green {
        color: #10b981 !important;
    }

    .h-stat-val.red {
        color: #ef4444 !important;
    }

    /* View Details Button */
    .h-btn.view {
        background: #262626 !important;
        color: #e2e8f0 !important;
        border: 1px solid #475569 !important;
    }

    .h-btn.view:hover {
        border-color: #d4af37 !important;
        color: #d4af37 !important;
    }

    /* =========================================
       TRADE MODALS & BUTTONS (Black & Gold)
       ========================================= */

    .t-info-label {
        color: #64748b !important;
    }

    /* =========================================
       CONFIRMATION MODALS (Black & Gold)
       ========================================= */

    /* Universal Modal Background */
    #orderConfirmModal .center-popup-content,
    #purchaseConfirmModal .center-popup-content,
    #closeOrderModal .center-popup-content,
    #globalModal .center-popup-content {
        background-color: #111111 !important;
        border: 1px solid #333 !important;
        color: #e2e8f0 !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
    }

    /* Modal Body Overrides */
    #orderConfirmModal .popup-body,
    #purchaseConfirmModal .popup-body,
    #closeOrderModal .popup-body,
    #globalModal .popup-body {
        background-color: #111111 !important;
        color: #e2e8f0 !important;
    }

    /* Modal Headers */
    #orderConfirmModal .center-popup-content>div:first-child,
    #purchaseConfirmModal .center-popup-content>div:first-child {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
    }

    /* Text Colors inside Modals */
    .center-popup-content h2 {
        color: #f8fafc !important;
    }

    #orderConfirmModal h2,
    #purchaseConfirmModal h2 {
        color: #000 !important;
    }

    .center-popup-content p,
    .center-popup-content span:not([id*="Total"]):not([id*="Net"]):not([style*="color: #d4af37"]) {
        color: #94a3b8 !important;
    }

    /* Inner Card Overrides */
    .popup-body div[style*="background: #1a1a1a"],
    .popup-body div[style*="background: #161616"],
    .popup-body div[style*="background: #f8fafc"],
    .popup-body div[style*="background: #f1f5f9"] {
        background-color: #1a1a1a !important;
        border-color: #333 !important;
    }

    /* Buttons */
    #ocConfirmBtn,
    #cpSubmitBtn,
    #modalBtn {
        background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%) !important;
        color: #000 !important;
        font-weight: 800 !important;
        border: none !important;
    }

    #modalBtn {
        color: #000 !important;
    }

    /* Success Icon in Global Modal */
    #modalIconContainer {
        background: rgba(212, 175, 55, 0.1) !important;
        color: #d4af37 !important;
    }

    /* Stock Detail / Trade Now Page */
    #stockDetailView {
        background-color: #0b0b0b !important;
        color: #e2e8f0 !important;
    }

    #stockDetailView .m-card,
    #stockDetailView .main-index-view,
    #stockDetailView .buy-widget {
        background-color: #111111 !important;
        border: 1px solid #262626 !important;
        color: #e2e8f0 !important;
    }

    #stockDetailView .stock-full-name {
        color: #94a3b8 !important;
    }

    #stockDetailView .info-label {
        color: #64748b !important;
    }

    #stockDetailView .info-val-text {
        color: #f8fafc !important;
    }

    #stockDetailView .tf-btn {
        background: #1a1a1a !important;
        color: #94a3b8 !important;
        border-color: #333 !important;
    }

    #stockDetailView .tf-btn.active {
        background: #d4af37 !important;
        color: #000 !important;
        border-color: #d4af37 !important;
    }

    #stockDetailView .detail-info-table tr td {
        border-bottom: 1px solid #262626 !important;
    }

    #stockDetailView .detail-info-table tr td:last-child {
        color: #f8fafc !important;
    }

    #stockDetailView #detHoldingsList>div {
        border-bottom: 1px solid #262626 !important;
        background: #111 !important;
    }
</style>