<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avendus Capital - Premium Trading Platform</title>
    <meta name="description"
        content="Access real-time market summaries, breaking news, and personalized stock recommendations on our premium financial dashboard.">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="settings-panel-fix.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="db.js"></script>
    <script src="market_data.js"></script>
    <style>
        /* Indices styling */
        .index-mini-card {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .index-mini-card.active {
            border-color: var(--gold-primary, #d4af37) !important;
            background: rgba(212, 175, 55, 0.05) !important;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        /* Chart specific */
        .mini-tf-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #1a1a1a;
            font-size: 11px;
            font-weight: 800;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .mini-tf-btn.active {
            background: var(--gold-primary, #d4af37);
            color: #000;
            border-color: var(--gold-primary, #d4af37);
        }

        .mini-tf-btn:hover:not(.active) {
            border-color: #666;
            color: #fff;
        }

        /* Sector cards */
        .sector-card {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sector-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold-primary, #d4af37);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        /* Exchange tabs for Gainers/Losers */
        .exchange-tab {
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 6px;
            color: #666;
            font-weight: 800;
            font-size: 0.7rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .exchange-tab.active {
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold-primary, #d4af37);
            border-color: rgba(212, 175, 55, 0.3);
        }

        /* Layout modifications */
        .market-content-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1.5rem;
            padding: 0 0 1.5rem;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .market-content-grid {
                grid-template-columns: 1fr 320px;
            }

            .left-col {
                display: none;
            }
        }

        @media (max-width: 900px) {
            .market-content-grid {
                grid-template-columns: 1fr;
            }

            .right-col {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="search-container">
                    <!-- Improved trap for browser autofill -->
                    <div style="position: absolute; left: -9999px; top: -9999px;">
                        <input type="text" name="fake_user" autocomplete="username">
                        <input type="password" name="fake_pass" autocomplete="current-password">
                    </div>

                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" placeholder="Search Stocks (e.g. RELIANCE, TCS)..." class="search-input"
                        id="globalSearchInput" autocomplete="off">
                    <div id="searchResults" class="search-results-dropdown"></div>
                </div>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-item active" id="navHome" onclick="setActiveNav(this)"><i
                        data-lucide="home"></i> Home</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('market.html'); setActiveNav(this)"
                    class="nav-item" id="navMarket"><i data-lucide="trending-up"></i> Market</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('market.html?view=discover'); setActiveNav(this)"
                    class="nav-item" id="navDiscover"><i data-lucide="compass"></i> Discover</a>
                <a href="javascript:void(0)"
                    onclick="handleGuestClick('market.html?view=portfolio'); setActiveNav(this)" class="nav-item"
                    id="navPortfolio"><i data-lucide="briefcase"></i> Portfolio</a>
                <a href="javascript:void(0)" onclick="handleGuestClick('market.html?view=me'); setActiveNav(this)"
                    class="nav-item" id="navMe"><i data-lucide="user"></i> Me</a>
            </nav>
            <div class="header-right">
                <button class="settings-btn" onclick="toggleMessageCenter()">
                    <i data-lucide="bell"></i>
                    <div class="notif-badge"></div>
                </button>
                <button class="settings-btn" onclick="openCS()" title="Customer Service" style="position: relative;">
                    <div class="csr-badge" id="csrHeaderBadge" style="display: none;"></div>
                    <i data-lucide="headset"></i>
                </button>
                <button class="settings-btn" onclick="openSettings()"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <!-- Premium Video Featured Section -->
        <div class="video-promo-section">
            <div class="video-container" id="videoWrapper">
                <video id="promoVideo" loop muted playsinline autoplay
                    poster="https://images.pexels.com/photos/6801874/pexels-photo-6801874.jpeg?auto=compress&cs=tinysrgb&w=3840&h=2160&dpr=1">
                    <source
                        src="https://player.vimeo.com/external/494163966.sd.mp4?s=7b9e6f3d9f285d8d0c83a1d6a9e1e8d9b1c9c8a2&profile_id=164"
                        type="video/mp4">
                    Your browser does not support the video tag.
                </video>

                <!-- Video Overlays -->
                <div class="video-overlay">
                    <div class="video-text-content">
                        <span class="badge">Exclusive Highlight</span>
                        <h1>Avendus Capital</h1>
                        <p class="tagline">Invest now for the future. Join now.</p>
                        <div class="video-actions" id="promoActions">
                            <a href="login.html" class="join-btn-large"
                                style="text-decoration: none; display: flex; align-items: center; justify-content: center;">Login</a>
                            <button class="learn-more-btn">Learn More</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Summary (shown when logged in) -->
        <div class="portfolio-summary-bar" id="portfolioBar" style="display: none;">
            <div class="user-greeting">
                <div class="user-avatar">U</div>
                <div class="user-text">
                    <h3>Welcome User</h3>
                    <p>Start your investment journey.</p>
                </div>
            </div>

            <!-- Removed portfolio stats per user request -->


            <div class="action-btns">
                <a href="deposit.html" class="btn-deposit"><i data-lucide="plus-circle"></i> Deposit</a>
                <a href="withdraw.html" class="btn-withdraw"><i data-lucide="minus-circle"></i> Withdraw</a>
            </div>
        </div>


        <!-- Main Content -->
        <main class="main-grid" style="display: block; padding: 1.5rem; max-width: 1400px; margin: 0 auto;">

            <!-- Market Summary - Full Width Grid -->
            <section class="card market-summary" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="header-icon"><i data-lucide="activity"></i></div>
                    <h2>Market Summary</h2>
                </div>
                <div class="market-cards-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">SENSEX</span>
                        </div>
                        <div class="stock-value">83,580.40</div>
                        <div class="stock-change green">+266.47 (+0.32%)</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">NIFTY 50</span>
                        </div>
                        <div class="stock-value">25,627.1</div>
                        <div class="stock-change negative">-148.9 (-0.58%)</div>
                    </div>
                    <div class="stock-card">
                        <div class="stock-info">
                            <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon">
                            <span class="stock-name">NIFTY BANK</span>
                        </div>
                        <div class="stock-value">60,023.4</div>
                        <div class="stock-change negative">-214.75 (-0.36%)</div>
                    </div>
                </div>
            </section>



            <!-- About + Breaking News - 2 Column Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">


                <!-- Breaking News + Recommendation (Right) -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <section class="card breaking-news">
                        <div class="card-header">
                            <div class="header-icon blue"><i data-lucide="newspaper"></i></div>
                            <h2>Breaking News</h2>
                        </div>
                        <div class="news-carousel" id="newsCarousel">
                            <div class="news-slide active">
                                <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&q=80&w=800"
                                    alt="News">
                                <div class="news-slide-overlay">
                                    <span class="news-time">Just Now</span>
                                    <h3>Market Hits New Milestone Amid Global Optimism</h3>
                                </div>
                            </div>
                            <!-- Arrow Controls -->
                            <button class="carousel-prev" onclick="changeSlide(-1)"><i
                                    data-lucide="chevron-left"></i></button>
                            <button class="carousel-next" onclick="changeSlide(1)"><i
                                    data-lucide="chevron-right"></i></button>
                        </div>
                    </section>

                    <section class="card recommendation">
                        <div class="card-header" id="recommendationHeader" style="cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="header-icon blue"><i data-lucide="thumbs-up"></i></div>
                                <h2>Recommendation</h2>
                            </div>
                            <i data-lucide="chevron-down" id="recommendationChevron"></i>
                        </div>
                        <div class="recommendation-list" id="recommendationList"
                            style="display: none; max-height: 0; overflow: hidden;">
                            <div class="rec-item">
                                <img class="rec-thumb"
                                    src="https://images.unsplash.com/photo-1460925895917-afdab827c52f?auto=format&fit=crop&q=80&w=200"
                                    alt="Rec">
                                <div class="rec-content">
                                    <h3>2026 Financial Outlook</h3>
                                    <p>Latest trends and predictions.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Recommendation Alert (for guests) -->
            <div class="market-auth-prompt" id="marketAuthPrompt" style="margin-bottom: 1.5rem;">
                <p>Please log in to view more premium insights</p>
                <a href="login.html" class="login-btn-small">Login to Continue</a>
            </div>
        </main>

        <!-- Exclusive Offers Section -->
        <section class="exclusive-offers-section" style="padding: 1.5rem; max-width: 1400px; margin: 0 auto;">
            <div class="card-header"
                style="padding-left: 0.5rem; background: transparent; border: none; margin-bottom: 1rem;">
                <div class="header-icon blue" style="background: #e0f2fe; color: #0ea5e9;">
                    <i data-lucide="sparkles"></i>
                </div>
                <h2 style="font-size: 1.3rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">
                    Exclusive
                    Offers</h2>
            </div>
            <div class="offers-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/6770610/pexels-photo-6770610.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Equity Trading">
                    </div>
                    <div class="offer-info">
                        <h3>Equity Trading</h3>
                        <p>Invest in leading companies and grow with the stock market.</p>
                    </div>
                </div>
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Robo Advisory">
                    </div>
                    <div class="offer-info">
                        <h3>Robo Advisory</h3>
                        <p>AI-powered, personalised investment strategies made simple.</p>
                    </div>
                </div>
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/164501/pexels-photo-164501.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Mutual Funds">
                    </div>
                    <div class="offer-info">
                        <h3>Mutual Funds</h3>
                        <p>Diversify your portfolio with professionally managed fund options.</p>
                    </div>
                </div>
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/6801874/pexels-photo-6801874.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Online Trading Experience">
                    </div>
                    <div class="offer-info">
                        <h3>Online Trading Experience</h3>
                        <p>Online Trading Experience</p>
                    </div>
                </div>
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/6780824/pexels-photo-6780824.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Exchange Traded Funds">
                    </div>
                    <div class="offer-info">
                        <h3>Exchange Traded Funds</h3>
                        <p>Trade diversified baskets of assets at low cost.</p>
                    </div>
                </div>
                <div class="offer-card">
                    <div class="offer-img-wrapper">
                        <img src="https://images.pexels.com/photos/7788009/pexels-photo-7788009.jpeg?auto=compress&cs=tinysrgb&w=600"
                            alt="Bonds & Debt">
                    </div>
                    <div class="offer-info">
                        <h3>Bonds & Debt</h3>
                        <p>Earn stable returns with safe, fixed-income instruments.</p>
                    </div>
                </div>
            </div>
        </section>



        <!-- Footer -->
        <footer class="footer">
            <div class="footer-left">
                © 2025. Reserved. | <a href="admin_kyc.html" style="color: inherit; text-decoration: none;">Admin</a>
            </div>
            <div class="footer-right">
                <span class="timezone">
                    <img src="https://flagcdn.com/w40/in.png" width="20" alt="India" class="flag-icon"> 12:51:09
                    GMT+5:30
                </span>
                <a href="#" class="cookie-pref">Cookie Preference</a>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="topAlertContainer" class="top-alert-container">
        <div class="top-alert">
            <i data-lucide="alert-circle"></i>
            <span>Please sign in to continue.</span>
            <i data-lucide="x" class="close-alert" onclick="closeAlert()"></i>
        </div>
    </div>

    <div id="messageCenterOverlay" class="message-center-overlay" onclick="toggleMessageCenter()"></div>
    <div id="messageCenter" class="message-center-modal">
        <div class="mc-header">
            <div class="mc-title-row">
                <span class="mc-title">Notifications</span>
                <span class="mc-subtitle" id="msgCount">10 Messages</span>
            </div>
            <button class="mc-close" onclick="toggleMessageCenter()"><i data-lucide="x" size="24"></i></button>
        </div>
        <div class="mc-actions">
            <button class="mc-btn" onclick="makeAllRead()">Make all read</button>
            <button class="mc-btn delete-all" onclick="deleteAllMessages()">Delete all</button>
        </div>
        <div class="mc-list" id="mcList">
            <div class="mc-item">
                <div class="mc-dot unread"></div>
                <div class="mc-content">
                    <div class="mc-msg-title">IPO Announcement – Armour Security IPO（QIB）</div>
                    <div class="mc-time">14-01-2026 15:10:23</div>
                    <div class="mc-tag">IPO:NEW</div>
                    <button class="mc-delete-item" onclick="deleteMessage(this)">Delete</button>
                </div>
            </div>
            <div class="mc-item">
                <div class="mc-dot unread"></div>
                <div class="mc-content">
                    <div class="mc-msg-title">Important Notice</div>
                    <div class="mc-time">12-01-2026 09:32:02</div>
                    <div class="mc-tag">TEXT</div>
                    <button class="mc-delete-item" onclick="deleteMessage(this)">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal" onclick="if(event.target == this) closeSettings()">
        <div class="settings-content">
            <button class="settings-close" onclick="closeSettings()"><i data-lucide="x" size="24"></i></button>
            <div class="settings-header">
                <div class="avatar-circle" id="settingsAvatar">U</div>
                <div class="settings-name" id="settingsName"
                    style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-top: 0.5rem;">User Name</div>
                <div class="settings-phone" id="settingsPhone"
                    style="font-size: 0.9rem; color: #64748b; margin-top: 0.2rem;">+91</div>
                <div class="badge-row">
                    <div class="s-badge vip"><i data-lucide="shield-check" size="18"></i> VIP: 0</div>
                    <div class="s-badge credit"><i data-lucide="crown" size="18"></i> Credit Score: 100</div>
                </div>
            </div>
            <div class="settings-list">
                <div class="settings-item" onclick="toggleUserProfile()">
                    <div class="settings-item-icon"><i data-lucide="user" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">User Profile</div>
                        <div class="settings-item-desc">Update your profile information.</div>
                    </div>
                    <i data-lucide="chevron-down" id="userProfileChevron" class="settings-chevron" size="18"
                        style="transition: transform 0.2s;"></i>
                </div>
                <div id="userProfileSubmenu" class="settings-submenu">
                    <div class="submenu-item" onclick="openEditNameModal()">
                        <i data-lucide="edit-3" size="18"></i> Update Name
                    </div>
                    <div class="submenu-item" onclick="openAvatarModal()">
                        <i data-lucide="image" size="18"></i> Update Avatar
                    </div>
                    <div class="submenu-item" onclick="openKYCModal()">
                        <i data-lucide="file-check" size="18"></i> View KYC
                    </div>
                </div>
                <div class="settings-item" onclick="toggleSecurityMenu()">
                    <div class="settings-item-icon"><i data-lucide="lock" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Security</div>
                        <div class="settings-item-desc">Update your system security settings.</div>
                    </div>
                    <i data-lucide="chevron-down" id="securityChevron" class="settings-chevron" size="18"
                        style="transition: transform 0.2s;"></i>
                </div>
                <div id="securitySubmenu" class="settings-submenu">
                    <div class="submenu-item" onclick="openWithdrawalPinModal()">
                        <i data-lucide="shield-check" size="18"></i> Withdrawal PIN
                    </div>
                    <div class="submenu-item" onclick="openResetPassword()">
                        <i data-lucide="key" size="18"></i> Change Login Password
                    </div>
                </div>
                <div class="settings-item" onclick="window.location.href='bank_accounts.html'">
                    <div class="settings-item-icon"><i data-lucide="landmark" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Bank Accounts</div>
                        <div class="settings-item-desc">Manage bank accounts and info</div>
                    </div>
                    <i data-lucide="chevron-right" class="settings-chevron" size="18"></i>
                </div>
                <div class="settings-item" onclick="openCS()">
                    <div class="settings-item-icon"><i data-lucide="headset" size="20"></i></div>
                    <div class="settings-item-info">
                        <div class="settings-item-title">Customer Service</div>
                        <div class="settings-item-desc">Contact customer service</div>
                    </div>
                    <i data-lucide="chevron-right" class="settings-chevron" size="18"></i>
                </div>

            </div>
            <div class="logout-btn-container">
                <button class="logout-btn" onclick="DB.logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Customer Service Modal -->
    <div id="csModal" class="settings-modal" onclick="if(event.target == this) closeCS()">
        <div class="settings-content" style="max-width: 500px; height: 600px; display: flex; flex-direction: column;">
            <button class="settings-close" onclick="closeCS()"><i data-lucide="x" size="24"></i></button>
            <div class="settings-header" style="margin-bottom: 1rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700;">Customer Service</h2>
            </div>
            <div id="chatBox"
                style="flex: 1; overflow-y: auto; padding: 1rem; background: #f8fafc; border-radius: 12px; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="csInput" placeholder="Type a message..."
                    style="flex: 1; padding: 0.8rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                <button onclick="sendCSMessage()"
                    style="background: #3b82f6; color: white; border: none; padding: 0 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Send</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal (Logged-In) -->
    <div id="resetPasswordModal" class="center-popup-modal" onclick="if(event.target == this) closeResetPassword()">
        <div class="center-popup-content" style="max-width: 450px;">
            <div class="popup-header">
                <h2>Reset Password</h2>
                <button class="popup-close" onclick="closeResetPassword()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body">
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Current
                        Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="currentPass" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('currentPass', this)"></i>
                    </div>
                </div>
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                        Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="newPassInternal" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('newPassInternal', this)"></i>
                    </div>
                </div>
                <div class="reg-input-group" style="margin-bottom: 2rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Confirm
                        New Password</label>
                    <div class="reg-password-wrapper" style="position: relative;">
                        <input type="password" id="confirmPassInternal" class="reg-input"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                        <i data-lucide="eye-off"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                            onclick="toggleInternalPass('confirmPassInternal', this)"></i>
                    </div>
                </div>
                <button class="logout-btn" style="background: #3b82f6;" onclick="handleInternalReset()">Update
                    Password</button>
                <button class="logout-btn" style="background: #f1f5f9; color: #64748b; margin-top: 1rem;"
                    onclick="closeResetPassword()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal PIN Modal -->
    <div id="withdrawalPinModal" class="center-popup-modal"
        onclick="if(event.target == this) closeWithdrawalPinModal()">
        <div class="center-popup-content" style="max-width: 450px;">
            <div class="popup-header">
                <h2 id="wpModalTitle">Withdrawal PIN</h2>
                <button class="popup-close" onclick="closeWithdrawalPinModal()"><i data-lucide="x"
                        size="24"></i></button>
            </div>
            <div class="popup-body">
                <p id="wpModalDesc" style="font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem;">Set or update your
                    4-6 digit withdrawal PIN.</p>
                <div style="padding: 1rem 0;">
                    <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                            Withdrawal PIN (4-6 digits)</label>
                        <input type="password" id="wpNewPin" class="reg-input" maxlength="6" pattern="\d*"
                            inputmode="numeric" placeholder="Enter New PIN"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                    </div>
                    <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                        <label
                            style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Confirm
                            New PIN</label>
                        <input type="password" id="wpConfirmPin" class="reg-input" maxlength="6" pattern="\d*"
                            inputmode="numeric" placeholder="Confirm New PIN"
                            style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                    </div>
                    <div class="reg-input-group" style="margin-bottom: 2rem;">
                        <label
                            style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Verify
                            Login Password</label>
                        <div class="reg-password-wrapper" style="position: relative;">
                            <input type="password" id="wpLoginPass" class="reg-input" placeholder="Enter Login Password"
                                style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                            <i data-lucide="eye-off"
                                style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer;"
                                onclick="toggleInternalPass('wpLoginPass', this)"></i>
                        </div>
                    </div>
                    <button id="wpSubmitBtn" class="logout-btn" style="background: #fb923c;"
                        onclick="handleWithdrawalPinSubmit()">Update
                        Withdrawal PIN</button>
                    <button class="logout-btn" style="background: #f1f5f9; color: #64748b; margin-top: 1rem;"
                        onclick="closeWithdrawalPinModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatarModal" class="center-popup-modal">
        <div class="center-popup-content avatar-form" style="max-width: 400px;">
            <div class="popup-header"
                style="width:100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.25rem; font-weight: 700;">Update Avatar</h2>
                <button class="popup-close" onclick="closeAvatarModal()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body" style="display:flex; flex-direction:column; align-items:center; width: 100%;">
                <div class="avatar-preview-lg" id="avatarPreviewContainer"
                    onclick="document.getElementById('avatarInput').click()">
                    <i data-lucide="user" size="64" style="color:#cbd5e1;" id="avatarPlaceholderIcon"></i>
                    <img id="avatarPreviewImg" src="" style="display:none;">
                    <div class="avatar-change-overlay">Change Image</div>
                </div>
                <input type="file" id="avatarInput" hidden onchange="previewAvatar(this)" accept="image/*">
                <div style="width: 100%; margin-top: 2rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn-primary" onclick="uploadAvatar()">Save Changes</button>
                    <button class="btn-secondary" onclick="closeAvatarModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KYC Modal -->
    <div id="kycModal" class="center-popup-modal">
        <div class="center-popup-content">
            <div class="popup-header">
                <h2>View KYC</h2>
                <button class="popup-close" onclick="closeKYCModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="popup-body">
                <div class="kyc-form-grid">
                    <div class="kyc-field-label">Full Name</div>
                    <input type="text" id="kycName" class="kyc-field-input" placeholder="Enter Full Name">
                    <div class="kyc-field-label">Mobile Number</div>
                    <input type="text" id="kycMobile" class="kyc-field-input" readonly style="background: #f8fafc;">
                    <div class="kyc-field-label">ID Number</div>
                    <input type="text" id="kycIdNum" class="kyc-field-input" placeholder="Enter ID Number">
                    <div class="kyc-field-label">Submitted On</div>
                    <input type="text" id="kycSubmitted" class="kyc-field-input" readonly style="background: #f8fafc;">
                    <div class="kyc-field-label">Approval Status</div>
                    <input type="text" id="kycApproved" class="kyc-field-input" readonly style="background: #f8fafc;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                    <div class="kyc-upload-box" onclick="document.getElementById('kycFrontInput').click()">
                        <div class="plus-icon">+ Front</div>
                        <img id="kycFrontPreview" style="display:none; width:100%; height:100%; object-fit:cover;">
                        <input type="file" id="kycFrontInput" hidden
                            onchange="previewKYCImage(this, 'kycFrontPreview')">
                    </div>
                    <div class="kyc-upload-box" onclick="document.getElementById('kycBackInput').click()">
                        <div class="plus-icon">+ Back</div>
                        <img id="kycBackPreview" style="display:none; width:100%; height:100%; object-fit:cover;">
                        <input type="file" id="kycBackInput" hidden onchange="previewKYCImage(this, 'kycBackPreview')">
                    </div>
                </div>
                <button class="btn-submit" onclick="submitKYC()" style="margin-top: 1.5rem; width: 100%;">Submit
                    Verification</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (typeof initCarousel === 'function') initCarousel();
            checkAuthState();
            syncUserData();

            // Recommendation Toggle
            const recHeader = document.getElementById('recommendationHeader');
            const recList = document.getElementById('recommendationList');
            const recChevron = document.getElementById('recommendationChevron');
            if (recHeader && recList) {
                recHeader.addEventListener('click', () => {
                    const isHidden = recList.style.display === 'none';
                    if (isHidden) {
                        recList.style.display = 'block';
                        setTimeout(() => {
                            recList.style.maxHeight = '2000px';
                            if (recChevron) recChevron.style.transform = 'rotate(180deg)';
                        }, 10);
                    } else {
                        recList.style.maxHeight = '0';
                        if (recChevron) recChevron.style.transform = 'rotate(0deg)';
                        setTimeout(() => recList.style.display = 'none', 400);
                    }
                });
            }

            // Persist CS Modal State
            if (localStorage.getItem('avendus_cs_open') === 'true') {
                window.openCS();
            }

            // Auto-refresh data when user switches back to this tab
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log("Tab visible, syncing user data...");
                    syncUserData();
                }
            });
            window.addEventListener('focus', () => {
                console.log("Window focused, syncing user data...");
                syncUserData();
            });
        });

        function checkAuthState() {
            const user = window.DB && window.DB.getCurrentUser ? window.DB.getCurrentUser() : null;
            const loggedIn = !!user;

            // Header & Hero
            const portBar = document.getElementById('portfolioBar');
            if (portBar) portBar.style.display = loggedIn ? 'flex' : 'none';
            const promo = document.getElementById('promoActions');
            if (promo) promo.style.display = loggedIn ? 'none' : 'flex';

            // Sidebar Auth Prompt
            const authPrompt = document.getElementById('marketAuthPrompt');
            if (authPrompt) authPrompt.style.display = loggedIn ? 'none' : 'block';

            // Feature Locks
            const assetsLock = document.getElementById('assetsLockOverlay');
            if (assetsLock) assetsLock.style.display = loggedIn ? 'none' : 'flex';

            const chartLock = document.querySelector('.auth-lock-overlay');
            if (chartLock) chartLock.style.display = loggedIn ? 'none' : 'flex';

            // Stock Lists (Gainers/Losers)
            document.querySelectorAll('.auth-locked-content').forEach(el => {
                if (el.closest('.auth-locked-container')) return; // handled by parent overlay if exists
                // We handle these by only calling switchExchange if logged in or showing placeholders
            });

            if (loggedIn) {
                if (typeof syncUserData === 'function') syncUserData();
                setTimeout(() => {
                    if (typeof startChatListener === 'function') startChatListener();
                    updateCSRVisibility();
                }, 1000);
            }
        }

        function playNotificationSound() {
            try {
                // More reliable notification sound
                const audio = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3');
                audio.volume = 0.5;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => console.log("Audio blocked. Interact with page first."));
                }
            } catch (e) { }
        }

        // Page specific initialization
        window.addEventListener('load', () => {
            const updateCSRVisibility = () => {
                const user = window.DB && window.DB.getCurrentUser ? window.DB.getCurrentUser() : null;
                const btn = document.getElementById('floatingCSR');
                if (btn) btn.style.display = user ? 'flex' : 'none';
            };
            updateCSRVisibility();
            if (typeof syncUserData === 'function') syncUserData();

            // Initialize Market Components
            if (typeof lucide !== 'undefined') lucide.createIcons();
            loadWidget('BSE:SENSEX');
            switchExchange('gainers', 'NSE');
            switchExchange('losers', 'NSE');
        });

        // --- MARKET DATA & CHART LOGIC (GLOBAL SCOPE) ---
        let currentWidget = null;
        let currentActiveSymbol = 'BSE:SENSEX';
        let currentInterval = 'D';

        const indexData = {
            'BSE:SENSEX': {
                price: 83580.40, basePrice: 83313.93, low: 83250.27, high: 83784.17, open: 83757.54, close: 83817.69, sym: "SENSEX",
                cardValId: 'valSensexCard', cardChgId: 'chgSensexCard'
            },
            'NSE:NIFTY': {
                price: 25641.65, basePrice: 25776.00, low: 25600.00, high: 25800.00, open: 25750.00, close: 25776.00, sym: "NIFTY 50",
                cardValId: 'valNiftyCard', cardChgId: 'chgNiftyCard'
            },
            'NSE:NIFTYBANK': {
                price: 51234.75, basePrice: 50822.45, low: 50700.00, high: 51500.00, open: 50900.00, close: 50822.45, sym: "BANK NIFTY",
                cardValId: 'valBankNiftyCard', cardChgId: 'chgBankNiftyCard'
            }
        };

        const stockData = {
            gainers: {
                NSE: [
                    { t: 'NIRAJISPAT', n: 'Niraj Ispat Industries', p: '₹257.41', c: '+20.00%' },
                    { t: 'PRESSTONIC', n: 'Presstonic Engineering', p: '₹53.20', c: '+19.82%' },
                    { t: 'IZMO', n: 'IZMO Limited', p: '₹841.45', c: '+18.48%' }
                ],
                BSE: [
                    { t: 'HDFCBANK', n: 'HDFC Bank Ltd', p: '₹1,540.20', c: '+2.45%' },
                    { t: 'RELIANCE', n: 'Reliance Industries', p: '₹2,985.40', c: '+1.80%' }
                ]
            },
            losers: {
                NSE: [
                    { t: 'DHARIWAL', n: 'Dhariwalcorp Limited', p: '₹78.70', c: '-79.61%' },
                    { t: 'CLEDUCATE', n: 'CL Educate Limited', p: '₹59.08', c: '-20.00%' }
                ],
                BSE: [
                    { t: 'ZOMATO', n: 'Zomato Limited', p: '₹255.40', c: '-4.20%' },
                    { t: 'PAYTM', n: 'One 97 Communications', p: '₹712.10', c: '-3.15%' }
                ]
            }
        };

        function loadWidget(symbol) {
            const container = document.getElementById('tradingview_widget');
            if (container) container.innerHTML = '';
            if (typeof TradingView === 'undefined') return;

            currentWidget = new TradingView.widget({
                "autosize": true,
                "symbol": symbol,
                "interval": currentInterval,
                "timezone": "Asia/Kolkata",
                "theme": "dark",
                "style": "1",
                "locale": "in",
                "toolbar_bg": "#000000",
                "enable_publishing": false,
                "allow_symbol_change": false,
                "hide_top_toolbar": true,
                "container_id": "tradingview_widget",
                "hide_side_toolbar": true,
                "overrides": {
                    "paneProperties.background": "#000000",
                    "paneProperties.gridLines": "#1a1a1a",
                    "mainSeriesProperties.candleStyle.upColor": "#00ff88",
                    "mainSeriesProperties.candleStyle.downColor": "#ff3b3b",
                    "mainSeriesProperties.candleStyle.borderUpColor": "#00ff88",
                    "mainSeriesProperties.candleStyle.borderDownColor": "#ff3b3b",
                    "mainSeriesProperties.candleStyle.wickUpColor": "#00ff88",
                    "mainSeriesProperties.candleStyle.wickDownColor": "#ff3b3b"
                },
                "disabled_features": [
                    "header_symbol_search", "header_compare", "header_settings",
                    "header_indicators", "header_chart_type", "header_resolutions",
                    "left_toolbar", "context_menus"
                ]
            });
        }

        function updateChart(symbol, title) {
            if (!indexData[symbol]) return;
            currentActiveSymbol = symbol;

            document.querySelectorAll('.index-mini-card').forEach(c => {
                c.classList.toggle('active', c.innerText.includes(title));
            });

            const d = indexData[symbol];
            const diff = d.price - d.basePrice;
            const pct = (diff / d.basePrice) * 100;
            const isUp = diff >= 0;

            if (document.getElementById('indexPrice')) document.getElementById('indexPrice').innerText = d.price.toLocaleString('en-IN');
            if (document.getElementById('valSymbol')) document.getElementById('valSymbol').innerText = d.sym;

            const hChg = document.getElementById('heroChange');
            if (hChg) {
                hChg.innerText = `${isUp ? '+' : ''}${diff.toFixed(2)} (${isUp ? '+' : ''}${pct.toFixed(2)}%)`;
                hChg.className = `index-chg ${isUp ? 'green' : 'red'}`;
            }

            loadWidget(symbol);
        }

        function updateChartInterval(interval, btn) {
            currentInterval = interval;
            document.querySelectorAll('.mini-tf-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            loadWidget(currentActiveSymbol);
        }

        function switchExchange(type, exchange) {
            const listId = type === 'gainers' ? 'gainersList' : 'losersList';
            const listContainer = document.querySelector(`#${listId} .auth-locked-content`);
            if (!listContainer) return;
            const data = stockData[type][exchange];

            const section = listContainer.closest('.card');
            section.querySelectorAll('.exchange-tab').forEach(tab => {
                tab.classList.toggle('active', tab.innerText === exchange);
            });

            listContainer.innerHTML = data.map(s => `
                <div class="stock-row" style="display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;">
                    <div>
                        <div style="font-weight: 700; font-size: 0.9rem; color: #fff;">${s.t}</div>
                        <div style="font-size: 0.75rem; color: #666;">${s.n}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 800; font-size: 0.9rem; color: #fff;">${s.p}</div>
                        <div class="index-chg ${type === 'gainers' ? 'green' : 'red'}" style="font-size: 0.8rem; font-weight: 700; color: ${type === 'gainers' ? '#00ff88' : '#ff3b3b'};">${s.c}</div>
                    </div>
                </div>
            `).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    </script>

    <!-- Notification Bell Floating Button -->
    <div class="cs-floating-tab" onclick="toggleMessageCenter()"
        style="bottom: 7rem; right: 2rem; width: 56px; height: 56px; border-radius: 50%; padding:0; justify-content:center; background: #fff; border: 1px solid #e2e8f0; color: #64748b; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000;">
        <div
            style="position:relative; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">
            <i data-lucide="bell" size="24" color="#1e56a0"></i>
            <div id="msgBadge"
                style="position:absolute; top:12px; right:12px; background:#ef4444; color:white; width:10px; height:10px; border-radius:50%; display:none; border:2px solid white;">
            </div>
        </div>
    </div>

    <!-- Floating CSR Button -->
    <div class="floating-csr" onclick="openCS()" id="floatingCSR" style="display: none;">
        <div class="csr-badge" id="csrMsgBadge" style="display: none;"></div>
        <i data-lucide="headset"></i>
        <span>Support</span>
    </div>


    <div id="editNameModal" class="center-popup-modal">
        <div class="center-popup-content" style="max-width: 400px;">
            <div class="popup-header">
                <h2>Update Name</h2>
                <button class="popup-close" onclick="closeEditNameModal()"><i data-lucide="x" size="24"></i></button>
            </div>
            <div class="popup-body">
                <div class="reg-input-group" style="margin-bottom: 1.5rem;">
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">New
                        Name</label>
                    <input type="text" id="editNameInput" class="reg-input" placeholder="Enter your name"
                        style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; outline: none;">
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="logout-btn" id="saveNameBtn" style="background: #3b82f6;" onclick="saveName()">Save
                        Name</button>
                    <button class="logout-btn" style="background: #f1f5f9; color: #64748b;"
                        onclick="closeEditNameModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>